<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha256-CTSx/A06dm1B063156EVh15m6Y67pAjZZaQc89LLSrU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"qilu.me","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.18.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="樂只君子">
<meta property="og:url" content="https://qilu.me/page/3/index.html">
<meta property="og:site_name" content="樂只君子">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Kaleo Feng">
<meta property="article:tag" content="樂只君子">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://qilu.me/page/3/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/3/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>樂只君子</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">樂只君子</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">起舞弄清影</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Kaleo Feng</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">48</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">99</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qilu.me/2016/03/03/2016-03-03/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Kaleo Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樂只君子">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 樂只君子">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/03/03/2016-03-03/" class="post-title-link" itemprop="url">Java游戏服务器-留存/付费数据统计</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-03-03 11:00:00" itemprop="dateCreated datePublished" datetime="2016-03-03T11:00:00+08:00">2016-03-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>游戏上线后，需要统计留存，付费等信息。留存一般关心次日留存，三日留存，周留存和月留存。付费包括平均用户付费等，平均付费用户付费等。</p>
<p>假设我们有以下两个表，分别是用户表（<code>tb_player</code>）和支付订单表（<code>tb_billing_order</code>）:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `tb_player` (</span><br><span class="line">  `player_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;角色ID&#x27;</span>,</span><br><span class="line">    ...</span><br><span class="line">  `create_time` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `last_login_time` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;上次登录时间&#x27;</span>,</span><br><span class="line">    ...</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`player_id`),</span><br><span class="line">  KEY `account` (`account`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `tb_billing_order` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;ID&#x27;</span>,</span><br><span class="line">  `player_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;玩家ID&#x27;</span>,</span><br><span class="line">    ...</span><br><span class="line">  `income` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;收入&#x27;</span>,</span><br><span class="line">    ...</span><br><span class="line">  `complete_time` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;完成时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure>

<p>所有统计数据都从其中产生。</p>
<p>首先创建一个记录统计数据的表（<strong>tb_stat_remain</strong>）:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `tb_stat_remain` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `dnu` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;每日新增用户&#x27;</span>,</span><br><span class="line">  `dau` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;每日活跃用户&#x27;</span>,</span><br><span class="line">  `dpr` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;每日充值收入&#x27;</span>,</span><br><span class="line">  `dpu` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;每日充值用户&#x27;</span>,</span><br><span class="line">  `r2` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;次日留存&#x27;</span>,</span><br><span class="line">  `r3` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;三日留存&#x27;</span>,</span><br><span class="line">  `r7` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;周留存&#x27;</span>,</span><br><span class="line">  `r30` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;月留存&#x27;</span>,</span><br><span class="line">  `stat_time` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;统计时间&#x27;</span>,</span><br><span class="line">  `op_time` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;操作时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure>

<p>然后创建一个存储过程，用来实际统计数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> `proc_stat_remain`()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> tuts <span class="type">BIGINT</span> <span class="keyword">DEFAULT</span> UNIX_TIMESTAMP() <span class="operator">*</span> <span class="number">1000</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> today <span class="type">DATE</span> <span class="keyword">DEFAULT</span> func_ctz(tuts);</span><br><span class="line">    <span class="keyword">DECLARE</span> yuts <span class="type">BIGINT</span> <span class="keyword">DEFAULT</span> tuts <span class="operator">-</span> <span class="number">86400000</span> <span class="operator">*</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> yesterday <span class="type">DATE</span> <span class="keyword">DEFAULT</span> func_ctz(yuts);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">DECLARE</span> d2 <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> d3 <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> d7 <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">6</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> d30 <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">29</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">SET</span> <span class="variable">@dnu</span> <span class="operator">=</span> (<span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> tb_player <span class="keyword">WHERE</span> DATEDIFF(yesterday, func_ctz(create_time)) <span class="operator">=</span> <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">SET</span> <span class="variable">@dau</span> <span class="operator">=</span> (<span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> tb_player <span class="keyword">WHERE</span> DATEDIFF(yesterday, func_ctz(last_login_time)) <span class="operator">=</span> <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">SET</span> <span class="variable">@dpr</span> <span class="operator">=</span> (<span class="keyword">SELECT</span> <span class="built_in">SUM</span>(income) <span class="keyword">FROM</span> tb_billing_order <span class="keyword">WHERE</span> STATUS <span class="operator">=</span> <span class="number">3</span> <span class="keyword">AND</span> DATEDIFF(yesterday, func_ctz(complete_time)) <span class="operator">=</span> <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">SET</span> <span class="variable">@dpu</span> <span class="operator">=</span> (<span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> player_id) <span class="keyword">FROM</span> tb_billing_order <span class="keyword">WHERE</span> STATUS <span class="operator">=</span> <span class="number">3</span> <span class="keyword">AND</span> DATEDIFF(yesterday, func_ctz(complete_time)) <span class="operator">=</span> <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">SET</span> <span class="variable">@r2</span> <span class="operator">=</span> func_stat_remain(yesterday, d2);</span><br><span class="line">    <span class="keyword">SET</span> <span class="variable">@r3</span> <span class="operator">=</span> func_stat_remain(yesterday, d3);</span><br><span class="line">    <span class="keyword">SET</span> <span class="variable">@r7</span> <span class="operator">=</span> func_stat_remain(yesterday, d7);</span><br><span class="line">    <span class="keyword">SET</span> <span class="variable">@r30</span> <span class="operator">=</span> func_stat_remain(yesterday, d30);</span><br><span class="line"></span><br><span class="line">    #<span class="keyword">SELECT</span> <span class="variable">@dnu</span>, <span class="variable">@dau</span>, <span class="variable">@dpr</span>, <span class="variable">@dpu</span>, <span class="variable">@r2</span>, <span class="variable">@r3</span>, <span class="variable">@r7</span>, <span class="variable">@r30</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">INSERT</span> <span class="keyword">INTO</span> tb_stat_remain(dnu, dau, dpr, dpu, stat_time, op_time) <span class="keyword">VALUES</span>(<span class="variable">@dnu</span>, <span class="variable">@dau</span>, <span class="variable">@dpr</span>, <span class="variable">@dpu</span>, yuts, tuts);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">UPDATE</span> tb_stat_remain <span class="keyword">SET</span> r2 <span class="operator">=</span> <span class="variable">@r2</span> <span class="keyword">WHERE</span> DATEDIFF(yesterday, func_ctz(stat_time)) <span class="operator">=</span> d2;</span><br><span class="line">    <span class="keyword">UPDATE</span> tb_stat_remain <span class="keyword">SET</span> r3 <span class="operator">=</span> <span class="variable">@r3</span> <span class="keyword">WHERE</span> DATEDIFF(yesterday, func_ctz(stat_time)) <span class="operator">=</span> d3;</span><br><span class="line">    <span class="keyword">UPDATE</span> tb_stat_remain <span class="keyword">SET</span> r7 <span class="operator">=</span> <span class="variable">@r7</span> <span class="keyword">WHERE</span> DATEDIFF(yesterday, func_ctz(stat_time)) <span class="operator">=</span> d7;</span><br><span class="line">    <span class="keyword">UPDATE</span> tb_stat_remain <span class="keyword">SET</span> r30 <span class="operator">=</span> <span class="variable">@r30</span> <span class="keyword">WHERE</span> DATEDIFF(yesterday, func_ctz(stat_time)) <span class="operator">=</span> d30;</span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure>

<p>计算并插入昨天的付费相关的数据，同时计算并更新与昨天相关的存留相关的数据。其中调用了两个函数：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> `func_stat_remain`(`yesterday` <span class="type">date</span>, `days`  <span class="type">int</span>) <span class="keyword">RETURNS</span> <span class="keyword">double</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">SET</span> <span class="variable">@number</span> <span class="operator">=</span> (<span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> tb_player <span class="keyword">WHERE</span> DATEDIFF(yesterday, func_ctz(create_time)) <span class="operator">=</span> days <span class="keyword">AND</span> DATEDIFF(yesterday, func_ctz(last_login_time)) <span class="operator">=</span> <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">SET</span> <span class="variable">@total</span> <span class="operator">=</span> (<span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> tb_player <span class="keyword">WHERE</span> DATEDIFF(yesterday, func_ctz(create_time)) <span class="operator">=</span> days);</span><br><span class="line">    <span class="keyword">SET</span> <span class="variable">@percent</span> <span class="operator">=</span> <span class="variable">@number</span> <span class="operator">/</span> <span class="variable">@total</span> <span class="operator">*</span> <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">RETURN</span> <span class="variable">@percent</span>;</span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure>

<p><code>func_stat_remain</code> 计算与指定日期相隔 <code>days</code> 天的留存率。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Function structure for func_ctz</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">FUNCTION</span> IF <span class="keyword">EXISTS</span> `func_ctz`;</span><br><span class="line">DELIMITER ;;</span><br><span class="line"><span class="keyword">CREATE</span> DEFINER<span class="operator">=</span>`catstudiolc2`@`<span class="operator">%</span>` <span class="keyword">FUNCTION</span> `func_ctz`(`milliseconds` <span class="type">bigint</span>) <span class="keyword">RETURNS</span> datetime</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">SET</span> <span class="variable">@dt</span> <span class="operator">=</span> CONVERT_TZ(FROM_UNIXTIME(milliseconds <span class="operator">/</span><span class="number">1000</span>), &quot;+0:00&quot;, &quot;+8:00&quot;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">RETURN</span> <span class="variable">@dt</span>;</span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure>

<p><code>func_ctz</code> 转换毫秒时间为当前时区日期，时区问题在<a href="/2016/02/20/2016-02-20">上篇</a>文章阐述过。</p>
<p>最后创建一个事件：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> EVENT `event_stat_remain` <span class="keyword">ON</span> SCHEDULE <span class="keyword">EVERY</span> <span class="number">1</span> <span class="keyword">DAY</span> STARTS <span class="string">&#x27;2015-10-01 16:00:00&#x27;</span> <span class="keyword">ON</span> COMPLETION <span class="keyword">NOT</span> PRESERVE ENABLE DO <span class="keyword">CALL</span> proc_stat_remain()</span><br></pre></td></tr></table></figure>

<p>每天零点执行。因为数据库所在时区是UTC（零时区），所以使用 <code>16:00:00</code>，正好是GMT+8（东八区）的零点。也可以在服务器程序里在每天零点调用上面的主存储过程，就不需要这个事件了。</p>
<p>每天产生存留和付费的基础数据，保存在 <code>tb_stat_remain</code> 表中，具体关心的每项数据从中获取计算即可。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qilu.me/2016/02/20/2016-02-20/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Kaleo Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樂只君子">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 樂只君子">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/02/20/2016-02-20/" class="post-title-link" itemprop="url">Java游戏服务器-时区问题</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-02-20 23:00:00" itemprop="dateCreated datePublished" datetime="2016-02-20T23:00:00+08:00">2016-02-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>游戏要推向海外多个市场时，不可避免地会遇到时区问题。</p>
<p>比如对台湾地区的用户，服务器可以部署在AWS的东京区。AWS的服务器和数据库，默认都使用UTC（零时区）时间，而台湾使用GMT+8（东八区）。</p>
<p>针对CentOS，可以使用<code>cat /etc/localtime</code>查看当前时区，输出如下：<br><img src="/2016-02-20/timezone_centos.jpg"></p>
<p>针对MySQL，可以使用<code>SHOW VARIABLES LIKE &quot;%time_zone%&quot;</code>查看当前时区，输出如下：<br><img src="/2016-02-20/timezone_mysql.jpg"></p>
<p>如果开发时不注意时区问题，正式上线后极可能会出现各种逻辑和显示上的时间的混乱。</p>
<p>时区问题，全区全服和分区分服处理起来还不太一样，全区全服要面向所有时区的玩家，分区分服通常可以做到服务器和玩家所在时区一致。但根据个人经验，无论全区全服或分区分服，都应该保证服务器唯一时区，且全部以服务器时间为准，具体时间显示可由客户端时区决定。</p>
<p>还是以上面台湾区服务器部署为例，有两种解决方案：</p>
<ol>
<li>调整服务器和数据库时区为GMT+8。这最简单，逻辑上也不容易出错。但有时同一个服务器和数据库可能会部署多个服务器服务多个不同地区的玩家，全局的时区改变并不合适，也增加了部署成本。</li>
<li>保持服务器和数据库时区为UTC，程序里改变时区。具体服务器采用那个时区，可通过配置文件决定，服务器启动时设置目标时区。</li>
</ol>
<p>通过实践，方案2更优。对于Java程序，可以这样设置时区：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TimeZone.setDefault(TimeZone.getTimeZone(<span class="string">&quot;GMT+8&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>这种方案下，程序和数据库的所有数据上的时间都应该使用通常的毫秒值，而不应该使用Timestamp&#x2F;DateTime等类型，因为后者都是时区相关的。同时逻辑上跟日期时间相关的，比如零点刷新等，都应该使用Calendar来获取，这样时区相关才能做到现实合理。即做到服务器使用唯一时区，客户端遵循本地时区，数据上时区无关，逻辑上时区相关。</p>
<p>以上解决方式更适用于分区分服，服务器仅服务于一个时区的情况。而全区全服，服务器要服务于多个时区的情况下，如何保证体验，还在探索。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qilu.me/2016/01/30/2016-01-30/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Kaleo Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樂只君子">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 樂只君子">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/01/30/2016-01-30/" class="post-title-link" itemprop="url">Java游戏服务器-Windows平台自动部署程序到Linux平台</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-01-30 23:00:00" itemprop="dateCreated datePublished" datetime="2016-01-30T23:00:00+08:00">2016-01-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>最近游戏已经基本完成，开始小规模内测。目前开发环境是在Windows下，服务器使用阿里云CentOS，这就牵扯到如何方便部署程序(包括数据，下同)。</p>
<p>最开始做法是Windows下export程序，然后使用FileZilla通过sftp上传到目标服务器。说起来好像并不复杂，而且部署并不频繁，起初还能接受，但慢慢不胜其烦。因为每次要部署Login&#x2F;Game&#x2F;Journal3类服务器，重复操作实在繁琐。本着能自动做就不手动做的原则，需要一种通过脚本自动部署的方式来解放双手。</p>
<p>首先梳理一下需求：</p>
<ol>
<li><p>自动导出程序</p>
</li>
<li><p>自动对程序打包压缩，上传到目标服务器</p>
</li>
<li><p>自动在目标服务器解压，拷贝更新</p>
</li>
</ol>
<p>1、3是相关平台下的操作，有多种实现方式，我们主要看2需求，这是实际部署中最繁琐的地方。</p>
<p>要对程序进行压缩，并且在Linux下解压，第一反应就是使用tar命令。要上传文件到服务器，第一反应是使用sftp命令。然而在Windows下默认没有这两个命令，幸运的是，已经有第三方实现。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/bmatzelle/gow/releases"> Gow (Gnu On Windows)</a> is the lightweight alternative to Cygwin. It uses a convenient Windows installer that installs about 130 extremely useful open source UNIX applications compiled as native win32 binaries. It is designed to be as small as possible, about 10 MB, as opposed to Cygwin which can run well over 100 MB depending upon options.</p>
</blockquote>
<p>有了tar和sftp等仿Linux命令，脚本就很容易实现了，示例如下。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar -zcf Test.tar.gz Test</span><br><span class="line">md5sum Test.tar.gz</span><br><span class="line">psftp root@123.45.67.89 -pw 123456 -b psftp.txt</span><br><span class="line">rm -rf Test.tar.gz</span><br></pre></td></tr></table></figure>

<p>首先对程序目录打包，其次计算md5，再通过sftp上传到Linux服务器，最后清理压缩文件。</p>
<p>上传命令在psftp.txt中，如下。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /home/test/</span><br><span class="line">lcd E:/Test/</span><br><span class="line">put Test.tar.gz</span><br><span class="line">!md5sum Test.tar.gz</span><br><span class="line">exit</span><br></pre></td></tr></table></figure>

<p>即将Windows的E:&#x2F;Test&#x2F;下的Test.tar.gz上传到目标Linux服务器的&#x2F;home&#x2F;test&#x2F;目录下，并计算md5。</p>
<p>另外，查看了一些资料，目前还没找到2、3都能通过Windows上的一个脚本完成的方法，只能分开进行。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qilu.me/2015/12/12/2015-12-12/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Kaleo Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樂只君子">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 樂只君子">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/12/12/2015-12-12/" class="post-title-link" itemprop="url">Java游戏服务器-百万规模实时排行榜实现（桶式）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-12-12 10:00:00" itemprop="dateCreated datePublished" datetime="2015-12-12T10:00:00+08:00">2015-12-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>前面<a href="/post/tech/2015-11-21">一篇文章</a>介绍了一种基于树形的实时排行榜实现，在较大规模数据下表现良好。但其并不适用于每个场景，尤其在区间较大，但实际数据记录数并不多的情况下，因为它的节点数是与区间相关的，大量的内存耗费在节点上。</p>
<p>针对这种场景，有一种更好的算法，即分桶式。其具体原理引用云风<a target="_blank" rel="noopener" href="https://blog.codingnow.com/2014/03/mmzb_db_2.html">文章</a>的一段话描述：</p>
<blockquote>
<p>陌陌争霸中用于排名的分数区间不大，也就是 0 分到 5000 分。而参与排名的人数众多，数以百万计。对百万用户做插入排序，每个插入即使是 O(N) 的也不可接受。可事实是大量玩家的分数相同，都是并列排名的。所以我们只需要做 5000 个桶，每个桶里仅记录这个分数有多少个人就可以了。</p>
<p>当玩家分数变迁，把原来的桶减一，新的桶加一。这个操作就是 O(1) 的。</p>
<p>而排行榜的查询仅需要把当前分数靠前的桶累加，就能获知查询者的名次。对于上百万玩家，看到哪些人和你并列的人的名字是没有意义的。这个查询虽然是 O(n) 复杂度，但 n 只有区区 5000 ，还可以做 cache 以应对查询频率远高于更新频率的情况。</p>
<p>真正需要精确知道人名的是榜单的前 200 个人，而对前 200 个人做插入排序也很快，所以并不会造成性能问题。</p>
</blockquote>
<p>其实可以看到，云风描述的应用场景和我描述的是两个方向的，区别就在于是否需要精确计算每个玩家的排名，分桶式在这两种场景下都适用。</p>
<p>算法很简单，按照惯例，直接展示代码，完整代码请参看文末。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LeaderboardPile</span>&lt;Extra <span class="keyword">extends</span> <span class="title class_">LeaderboardPileExtra</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">LeaderboardBucket</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="variable">lowerKey</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="variable">upperKey</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="variable">number</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> ArrayList&lt;Extra&gt; extraList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Extra&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">lowerKey</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">upperKey</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">bucketNumber</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> ArrayList&lt;LeaderboardBucket&gt; buckets = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;LeaderboardBucket&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setup</span><span class="params">(<span class="type">int</span> lowerKey, <span class="type">int</span> upperKey, <span class="type">int</span> bucketNumber)</span> &#123;</span><br><span class="line">        <span class="keyword">assert</span> (upperKey - lowerKey) / bucketNumber &gt; <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">assert</span> (upperKey - lowerKey) % bucketNumber == <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.lowerKey = lowerKey;</span><br><span class="line">        <span class="built_in">this</span>.upperKey = upperKey;</span><br><span class="line">        <span class="built_in">this</span>.bucketNumber = bucketNumber;</span><br><span class="line">        setupBucket();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(<span class="type">int</span> key, Extra extra)</span> &#123;</span><br><span class="line">        insertIntoBucket(key, extra);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">(<span class="type">int</span> key, Extra extra)</span> &#123;</span><br><span class="line">        removeFromBucket(key, extra);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">change</span><span class="params">(<span class="type">int</span> oldKey, <span class="type">int</span> newKey, Extra extra)</span> &#123;</span><br><span class="line">        remove(oldKey, extra);</span><br><span class="line">        insert(newKey, extra);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getRanking</span><span class="params">(<span class="type">int</span> key, Extra extra)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getRankingOfBucket(key, extra) + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> LeaderboardPileData <span class="title function_">getRankingN</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">        <span class="type">LeaderboardPileData</span> <span class="variable">data</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">ranking</span> <span class="operator">=</span> n;</span><br><span class="line">        <span class="type">int</span> <span class="variable">bucketIndex</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (LeaderboardBucket bucket : buckets) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ranking &gt; bucket.number) &#123;</span><br><span class="line">                ranking -= bucket.number;</span><br><span class="line">                bucketIndex += <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bucketIndex &lt; <span class="number">0</span> || bucketIndex &gt;= bucketNumber) &#123;</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">LeaderboardBucket</span> <span class="variable">bucket</span> <span class="operator">=</span> buckets.get(bucketIndex);</span><br><span class="line">        <span class="keyword">if</span> (bucket == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ranking &lt;= <span class="number">0</span> || ranking &gt; bucket.number) &#123;</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Extra extra : bucket.extraList) &#123;</span><br><span class="line">            ranking -= <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (ranking &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                data = <span class="keyword">new</span> <span class="title class_">LeaderboardPileData</span>();</span><br><span class="line">                data.key = extra.key;</span><br><span class="line">                data.ranking = n;</span><br><span class="line">                data.extra = extra;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;LeaderboardPileData&gt; <span class="title function_">getTopN</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">        ArrayList&lt;LeaderboardPileData&gt; dataList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;LeaderboardPileData&gt;();</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (LeaderboardBucket bucket : buckets) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Extra extra : bucket.extraList) &#123;</span><br><span class="line">                <span class="type">LeaderboardPileData</span> <span class="variable">data</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LeaderboardPileData</span>();</span><br><span class="line">                data.ranking = ++count;</span><br><span class="line">                data.key = extra.key;</span><br><span class="line">                data.extra = extra;</span><br><span class="line">                dataList.add(data);</span><br><span class="line">                <span class="keyword">if</span> (count &gt;= n) &#123;</span><br><span class="line">                    <span class="keyword">return</span> dataList;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dataList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setupBucket</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (lowerKey &gt; upperKey) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>; index &lt; bucketNumber; ++index) &#123;</span><br><span class="line">            <span class="type">LeaderboardBucket</span> <span class="variable">bucket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LeaderboardBucket</span>();</span><br><span class="line">            bucket.lowerKey = getBucketLowerKey(index);</span><br><span class="line">            bucket.upperKey = getBucketUpperKey(index);</span><br><span class="line">            bucket.number = <span class="number">0</span>;</span><br><span class="line">            bucket.extraList.clear();</span><br><span class="line">            buckets.add(bucket);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">insertIntoBucket</span><span class="params">(<span class="type">int</span> key, Extra extra)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">bucketIndex</span> <span class="operator">=</span> getBucketIndex(key);</span><br><span class="line">        <span class="type">LeaderboardBucket</span> <span class="variable">bucket</span> <span class="operator">=</span> buckets.get(bucketIndex);</span><br><span class="line">        <span class="keyword">if</span> (bucket != <span class="literal">null</span>) &#123;</span><br><span class="line">            extra.key = key;</span><br><span class="line">            bucket.extraList.add(extra);</span><br><span class="line">            bucket.extraList.sort((Extra left, Extra right) -&gt; left.compareTo(right));</span><br><span class="line">            bucket.number += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">removeFromBucket</span><span class="params">(<span class="type">int</span> key, Extra extra)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">bucketIndex</span> <span class="operator">=</span> getBucketIndex(key);</span><br><span class="line">        <span class="type">LeaderboardBucket</span> <span class="variable">bucket</span> <span class="operator">=</span> buckets.get(bucketIndex);</span><br><span class="line">        <span class="keyword">if</span> (bucket != <span class="literal">null</span>) &#123;</span><br><span class="line">            extra.key = key;</span><br><span class="line">            bucket.extraList.remove(extra);</span><br><span class="line">            bucket.extraList.sort((Extra left, Extra right) -&gt; left.compareTo(right));</span><br><span class="line">            bucket.number -= <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">getRankingOfBucket</span><span class="params">(<span class="type">int</span> key, Extra extra)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">ranking</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">bucketIndex</span> <span class="operator">=</span> getBucketIndex(key);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>; index &lt; bucketIndex; ++index) &#123;</span><br><span class="line">            <span class="type">LeaderboardBucket</span> <span class="variable">bucket</span> <span class="operator">=</span> buckets.get(index);</span><br><span class="line">            <span class="keyword">if</span> (bucket != <span class="literal">null</span>) &#123;</span><br><span class="line">                ranking += bucket.number;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">LeaderboardBucket</span> <span class="variable">bucket</span> <span class="operator">=</span> buckets.get(bucketIndex);</span><br><span class="line">        <span class="keyword">if</span> (bucket != <span class="literal">null</span>) &#123;</span><br><span class="line">            extra.key = key;</span><br><span class="line">            ranking += getBucketRanking(bucket, extra);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ranking;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">getBucketLowerKey</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">bucketLowerKey</span> <span class="operator">=</span> getBucketUpperKey(index + <span class="number">1</span>) + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> bucketLowerKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">getBucketUpperKey</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">stepKey</span> <span class="operator">=</span> getStepKey();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">bucketUpperKey</span> <span class="operator">=</span> upperKey - stepKey * index;</span><br><span class="line">        <span class="keyword">return</span> bucketUpperKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">getBucketIndex</span><span class="params">(<span class="type">int</span> key)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (key &lt; lowerKey) &#123;</span><br><span class="line">            <span class="keyword">return</span> bucketNumber - <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (key &gt; upperKey) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">stepKey</span> <span class="operator">=</span> getStepKey();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">diffKey</span> <span class="operator">=</span> upperKey - key;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> diffKey / stepKey;</span><br><span class="line">        <span class="keyword">return</span> index;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">getBucketRanking</span><span class="params">(LeaderboardBucket bucket, Extra extra)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">ranking</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (Extra bucketExtra : bucket.extraList) &#123;</span><br><span class="line">            <span class="keyword">if</span> (extra.compareTo(bucketExtra) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                ranking += <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ranking;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getStepKey</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">stepKey</span> <span class="operator">=</span> (upperKey - lowerKey + <span class="number">1</span>) / bucketNumber;</span><br><span class="line">        <span class="keyword">return</span> stepKey;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>采用这种做法，需要在服务器启动时重新构建排行树，先确定排行区间，然后依次插入每个玩家数据。运行期间，玩家数据等改变时，先删除旧的排行，再插入新的排行。</p>
<p>该算法在面对数据分布不均、同区间玩家过多情况时，性能会大幅退化，可将ArrayList替换为更高效的数据结构，或变通需求。</p>
<p>公共库仓库：<a target="_blank" rel="noopener" href="https://github.com/KaleoFeng/JMetazion.git">JMetazion</a></p>
<p>服务器示例仓库：<a target="_blank" rel="noopener" href="https://github.com/KaleoFeng/JGameDemo.git">JGameDemo</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qilu.me/2015/11/21/2015-11-21/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Kaleo Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樂只君子">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 樂只君子">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/11/21/2015-11-21/" class="post-title-link" itemprop="url">Java游戏服务器-百万规模实时排行榜实现（树形）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-11-21 10:00:00" itemprop="dateCreated datePublished" datetime="2015-11-21T10:00:00+08:00">2015-11-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>有人的地方就有对比，游戏中自然也少不了排行榜。</p>
<p>当前项目设计目标是，每个服务器玩家数量为百万左右。每个玩家都有战力、经验等属性，战力最大值在50万以内。</p>
<p>现在期望能有战力排行榜，有以下几点需求：</p>
<ul>
<li>全部角色参与排行，能实时知道某个角色的排名</li>
<li>排行榜显示前100名玩家详情</li>
</ul>
<p>排名规则是战力越高排名越前，战力相同则比较经验，经验再相同则比较创建时间。</p>
<p>排行榜算法并不少见，<a target="_blank" rel="noopener" href="https://www.cnblogs.com/weidagang2046/archive/2012/03/01/massive-user-ranking.html">这篇文章</a>介绍的就不错。根据上述需求分析，最适合采用文中的算法3，即树形分区设计，具体算法文中有详细介绍。</p>
<p>采用该算法，时间复杂度在O(log(n))，在百万规模下空间消耗也就几十M。但有两个问题待解决：</p>
<ul>
<li>战力相同时如何确定具体排名</li>
<li>如何获得TOP N</li>
</ul>
<p>针对问题1，假定游戏设计的战力相对均匀（尽管高战力显然更分散），那么战力相同的玩家数量会在一个较小规模内。依然以战力构建排行树，相同战力为同一个节点。节点可以存在一个有序列表，以经验、创建时间排序。这里有个小技巧，以玩家ID等效于创建时间，就直接记录了相应玩家，同时也保证了唯一性。这在增加删除（排名改变时）尤为有用。</p>
<p>针对问题2，排行树算法决定了最终战力节点都是叶子节点，同时在叶子节点层，战力总是从左向右递增的。在树构建过程中，可以 ，将所有叶子节点连成一个双向链表。这样就可以做到既能得到前N名，也可以得到后N名，时间复杂度都是O(N)。</p>
<p>下面show the code，完整代码请参看文末。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LeaderboardTree</span>&lt;Extra <span class="keyword">extends</span> <span class="title class_">LeaderboardExtra</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">LeaderboardNode</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="variable">lowerKey</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="variable">upperKey</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="variable">number</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> ArrayList&lt;Extra&gt; extraList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Extra&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="type">LeaderboardNode</span> <span class="variable">left</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="type">LeaderboardNode</span> <span class="variable">right</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="type">LeaderboardNode</span> <span class="variable">prev</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="type">LeaderboardNode</span> <span class="variable">next</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">LeaderboardNode</span> <span class="variable">root</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">LeaderboardNode</span> <span class="variable">head</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">LeaderboardNode</span> <span class="variable">tail</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setup</span><span class="params">(<span class="type">int</span> lowerKey, <span class="type">int</span> upperKey)</span> &#123;</span><br><span class="line">        root = setupNode(root, lowerKey, upperKey);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(<span class="type">int</span> score, Extra extra)</span> &#123;</span><br><span class="line">        insertIntoNode(root, score, extra);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">(<span class="type">int</span> score, Extra extra)</span> &#123;</span><br><span class="line">        removeFromNode(root, score, extra);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">change</span><span class="params">(<span class="type">int</span> oldKey, <span class="type">int</span> newKey, Extra extra)</span> &#123;</span><br><span class="line">        remove(oldKey, extra);</span><br><span class="line">        insert(newKey, extra);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getRanking</span><span class="params">(<span class="type">int</span> score, Extra extra)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getRankingOfNode(root, score, extra) + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;LeaderboardData&gt; <span class="title function_">getTopN</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">        ArrayList&lt;LeaderboardData&gt; dataList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;LeaderboardData&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">LeaderboardNode</span> <span class="variable">cursor</span> <span class="operator">=</span> tail;</span><br><span class="line">        <span class="keyword">while</span> (cursor != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Extra extra : cursor.extraList) &#123;</span><br><span class="line">                <span class="type">LeaderboardData</span> <span class="variable">data</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LeaderboardData</span>();</span><br><span class="line">                data.ranking = ++count;</span><br><span class="line">                data.key = cursor.lowerKey;</span><br><span class="line">                data.extra = extra;</span><br><span class="line">                dataList.add(data);</span><br><span class="line">                <span class="keyword">if</span> (count &gt;= n) &#123;</span><br><span class="line">                    <span class="keyword">return</span> dataList;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            cursor = cursor.prev;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dataList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LeaderboardNode <span class="title function_">setupNode</span><span class="params">(LeaderboardNode node, <span class="type">int</span> lowerKey, <span class="type">int</span> upperKey)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (lowerKey &gt; upperKey) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        node = <span class="keyword">new</span> <span class="title class_">LeaderboardNode</span>();</span><br><span class="line">        node.lowerKey = lowerKey;</span><br><span class="line">        node.upperKey = upperKey;</span><br><span class="line">        node.number = <span class="number">0</span>;</span><br><span class="line">        node.extraList.clear();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isLeafNode(node)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (head == <span class="literal">null</span>) &#123;</span><br><span class="line">                head = node;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (tail != <span class="literal">null</span>) &#123;</span><br><span class="line">                tail.next = node;</span><br><span class="line">                node.prev = tail;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            tail = node;</span><br><span class="line">            <span class="keyword">return</span> node;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (upperKey &gt; lowerKey) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">middleKey</span> <span class="operator">=</span> getMiddleKey(lowerKey, upperKey);</span><br><span class="line">            node.left = setupNode(node.left, lowerKey, middleKey);</span><br><span class="line">            node.right = setupNode(node.right, middleKey + <span class="number">1</span>, upperKey);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> node;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">insertIntoNode</span><span class="params">(LeaderboardNode node, <span class="type">int</span> score, Extra extra)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (node == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!isInsideNode(node, score)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ++node.number;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isLeafNode(node)) &#123;</span><br><span class="line">            node.extraList.add(extra);</span><br><span class="line">            node.extraList.sort((Extra left, Extra right) -&gt; left.compareTo(right));</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">middleKey</span> <span class="operator">=</span> getMiddleKey(node.lowerKey, node.upperKey);</span><br><span class="line">        <span class="keyword">if</span> (score &lt;= middleKey) &#123;</span><br><span class="line">            insertIntoNode(node.left, score, extra);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            insertIntoNode(node.right, score, extra);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">removeFromNode</span><span class="params">(LeaderboardNode node, <span class="type">int</span> score, Extra extra)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (node == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!isInsideNode(node, score)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        --node.number;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isLeafNode(node)) &#123;</span><br><span class="line">            node.extraList.remove(extra);</span><br><span class="line">            node.extraList.sort((Extra left, Extra right) -&gt; left.compareTo(right));</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">middleKey</span> <span class="operator">=</span> getMiddleKey(node.lowerKey, node.upperKey);</span><br><span class="line">        <span class="keyword">if</span> (score &lt;= middleKey) &#123;</span><br><span class="line">            removeFromNode(node.left, score, extra);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            removeFromNode(node.right, score, extra);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">getRankingOfNode</span><span class="params">(LeaderboardNode node, <span class="type">int</span> score, Extra extra)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">ranking</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (node == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> ranking;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (score &lt; node.lowerKey) &#123;</span><br><span class="line">            ranking += node.number;</span><br><span class="line">            <span class="keyword">return</span> ranking;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (score &gt; node.upperKey) &#123;</span><br><span class="line">            ranking += <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span> ranking;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isLeafNode(node)) &#123;</span><br><span class="line">            ranking += Math.max(node.extraList.indexOf(extra), <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">return</span> ranking;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">middleKey</span> <span class="operator">=</span> getMiddleKey(node.lowerKey, node.upperKey);</span><br><span class="line">        <span class="keyword">if</span> (score &lt;= middleKey) &#123;</span><br><span class="line">            ranking += node.right != <span class="literal">null</span> ? node.right.number : <span class="number">0</span>;</span><br><span class="line">            ranking += getRankingOfNode(node.left, score, extra);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ranking += getRankingOfNode(node.right, score, extra);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ranking;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">getMiddleKey</span><span class="params">(<span class="type">int</span> lowerKey, <span class="type">int</span> upperKey)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">middleKey</span> <span class="operator">=</span> lowerKey + ((upperKey - lowerKey) &gt;&gt; <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> middleKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isInsideNode</span><span class="params">(LeaderboardNode node, <span class="type">int</span> score)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> score &gt;= node.lowerKey &amp;&amp; score &lt;= node.upperKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isLeafNode</span><span class="params">(LeaderboardNode node)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> node.lowerKey == node.upperKey;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>针对我们的需求，key就是战力，extra包含玩家经验和ID。</p>
<p>采用这种做法，需要在服务器启动时重新构建排行树，先确定排行战力区间，然后依次插入每个玩家战力等数据。运行期间，玩家战力等改变时，先删除旧的排行，再插入新的排行。</p>
<p>该算法在处理千万数据时依然有效，但再大规模性能会不足。如果战力分布不均，同战力玩家过多，性能也会大幅退化，可将ArrayList替换为更高效的数据结构，或变通需求。</p>
<p>公共库仓库：<a target="_blank" rel="noopener" href="https://github.com/KaleoFeng/JMetazion.git">JMetazion</a></p>
<p>服务器示例仓库：<a target="_blank" rel="noopener" href="https://github.com/KaleoFeng/JGameDemo.git">JGameDemo</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qilu.me/2015/10/08/2015-10-08/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Kaleo Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樂只君子">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 樂只君子">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/10/08/2015-10-08/" class="post-title-link" itemprop="url">Java游戏服务器-数据库表存取封装</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-10-08 16:00:00" itemprop="dateCreated datePublished" datetime="2015-10-08T16:00:00+08:00">2015-10-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>项目涉及的数据库表并不多，但每个select、insert、update和delete都去手动拼接字符串，是很低效的，尤其在时常要修改结构的情况下。开发的一个目标就是自动化，即能自动实现的事情就不要手动去做；还有一个原则是单一化，即尽量保证数据或逻辑一个入口一个出口。这个需求可以使用一些开源库解决，但因为需求简单，目标明确，没有必要引入多余的第三方库。于是自己写了一个，至少满足当前需求。</p>
<p>数据库表的封装，核心类有两个，表（Table）和记录（Record）。首先需要一个Table类保存数据库表结构的描述，并籍此自动生成相应SQL语句。其次需要一个Record类自动设置SQL参数，并从返回结果集中自动生成逻辑对象。</p>
<p>table类表结构描述可以有两个来源，自动从数据库获取，或从配置表加载。这里选择从配置表加载的方式，一来实现简单，二来应用面更广。</p>
<p>下面是一个账户表的配置示例（user.xml）。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Table</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;user_id&quot;</span> <span class="attr">primaryField</span>=<span class="string">&quot;userId&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Column</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">field</span>=<span class="string">&quot;username&quot;</span> <span class="attr">type</span>=<span class="string">&quot;2&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Column</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">field</span>=<span class="string">&quot;password&quot;</span> <span class="attr">type</span>=<span class="string">&quot;2&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Column</span> <span class="attr">name</span>=<span class="string">&quot;salt&quot;</span> <span class="attr">field</span>=<span class="string">&quot;salt&quot;</span> <span class="attr">type</span>=<span class="string">&quot;1&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Column</span> <span class="attr">name</span>=<span class="string">&quot;reg_time&quot;</span> <span class="attr">field</span>=<span class="string">&quot;registerTime&quot;</span> <span class="attr">type</span>=<span class="string">&quot;3&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Column</span> <span class="attr">name</span>=<span class="string">&quot;last_login_time&quot;</span> <span class="attr">field</span>=<span class="string">&quot;lastLoginTime&quot;</span> <span class="attr">type</span>=<span class="string">&quot;3&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Table</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>只定义了一个主键，有需要可对此扩充。每列name对应数据库表的列名，field对应逻辑对象的成员变量名，type对应字段的类型，比如是int、string、timestamp等，有了名字和类型，就可以使用反射方式自动get和set数据。</p>
<p>Table类读取配置文件获得数据表的结构描述。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Table</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TableField</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TYPE_INTEGER</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TYPE_STRING</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TYPE_TIMESTAMP</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="type">String</span> <span class="variable">columnName</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="type">String</span> <span class="variable">fieldName</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="variable">type</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">tableName</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">TableField</span> <span class="variable">primaryField</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TableField</span>();</span><br><span class="line">    <span class="keyword">private</span> ArrayList&lt;TableField&gt; tableFields = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;TableField&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">selectAllSql</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">selectSql</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">insertSql</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">updateSql</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">deleteSql</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p>然后生成PrepareStatement方式读写的select、insert、update和delete的SQL字符串。如update：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String <span class="title function_">generateUpdateSql</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;UPDATE &quot;</span> + tableName + <span class="string">&quot; SET &quot;</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> tableFields.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>; index &lt; size; ++index) &#123;</span><br><span class="line">            <span class="type">TableField</span> <span class="variable">tableField</span> <span class="operator">=</span> tableFields.get(index);</span><br><span class="line">            <span class="type">String</span> <span class="variable">conjunction</span> <span class="operator">=</span> index == <span class="number">0</span> ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;,&quot;</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">colSql</span> <span class="operator">=</span> tableField.columnName + <span class="string">&quot; = ?&quot;</span>;</span><br><span class="line">            sql = sql + conjunction + colSql;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sql = sql + <span class="string">&quot; WHERE &quot;</span> + primaryField.columnName + <span class="string">&quot;=?&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> sql;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>Table类的功能就这么多，下面是关键的Record类，其使用反射自动存取数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Record</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Table&lt;T&gt; table = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">T</span> <span class="variable">object</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>模板参数T即一个表记录对应的逻辑对象。在我们的示例里，即账户数据类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserData</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用户ID</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="variable">userId</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用户名</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 密码</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>有了SQL语句，要先设置参数，才能执行。主键和普通字段分开设置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">setPrimaryParams</span><span class="params">(<span class="type">int</span> start, PreparedStatement pst)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    Table&lt;T&gt;.<span class="type">TableField</span> <span class="variable">primaryField</span> <span class="operator">=</span> table.getPrimaryField();</span><br><span class="line"></span><br><span class="line">    <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> getFieldValue(primaryField);</span><br><span class="line">    value = toDBValue(primaryField, value);</span><br><span class="line">    pst.setObject(start, value);</span><br><span class="line">    <span class="keyword">return</span> start + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">setNormalParams</span><span class="params">(<span class="type">int</span> start, PreparedStatement pst)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    ArrayList&lt;Table&lt;T&gt;.TableField&gt; normalFields = table.getNoramlFields();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> normalFields.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>; index &lt; size; ++index) &#123;</span><br><span class="line">        Table&lt;T&gt;.<span class="type">TableField</span> <span class="variable">tableField</span> <span class="operator">=</span> normalFields.get(index);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> getFieldValue(tableField);</span><br><span class="line">        value = toDBValue(tableField, value);</span><br><span class="line">        pst.setObject(start + index, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> start + size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>就是根据表结构描述，通过反射获取对应字段的值然后设置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Object <span class="title function_">getFieldValue</span><span class="params">(Table&lt;T&gt;.TableField tableField)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(tableField.fieldName);</span><br><span class="line">    <span class="keyword">return</span> field.get(object);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>toDBValue作用是将Java逻辑类型转成对应数据库类型，比如时间，在逻辑里是Long，而数据库类型是Timestamp。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Object <span class="title function_">toDBValue</span><span class="params">(Table&lt;T&gt;.TableField tableField, Object value)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (tableField.type == TableField.TYPE_TIMESTAMP) &#123;</span><br><span class="line">        value = <span class="keyword">new</span> <span class="title class_">Timestamp</span>((<span class="type">long</span>) value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以设置update SQL参数为例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUpdateParams</span><span class="params">(PreparedStatement pst)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">start</span> <span class="operator">=</span> setNormalParams(<span class="number">1</span>, pst);</span><br><span class="line">    setPrimaryParams(start, pst);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后执行该SQL语句就可以了。如果是select语句还会返回结果集（ResultSet），从结果集自动生成逻辑对象原理类似，算是一个逆过程，详细参看文末代码。</p>
<p>下面给出一个使用的完整示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Table&lt;UserData&gt; udTable = <span class="keyword">new</span> <span class="title class_">Table</span>&lt;UserData&gt;();</span><br><span class="line">...</span><br><span class="line">udTable.load(<span class="string">&quot;user.xml&quot;</span>);</span><br><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">updateUserData</span><span class="params">(UserData userData)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        Record&lt;UserData&gt; record = udTable.createRecord();</span><br><span class="line"></span><br><span class="line">        record.setObject(userData);</span><br><span class="line"></span><br><span class="line">        <span class="type">PreparedStatement</span> <span class="variable">pst</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> udTable.getUpdateSql();</span><br><span class="line">            pst = DbUtil.openConnection().prepareStatement(sql);</span><br><span class="line">            record.setUpdateParams(pst);</span><br><span class="line"></span><br><span class="line">            result = pst.executeUpdate() &gt; <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            DbUtil.closeConnection(<span class="literal">null</span>, pst);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>代码封装得很简易，有更多需要可据此改进。</p>
<p>公共库仓库：<a target="_blank" rel="noopener" href="https://github.com/KaleoFeng/JMetazion.git">JMetazion</a></p>
<p>服务器示例仓库：<a target="_blank" rel="noopener" href="https://github.com/KaleoFeng/JGameDemo.git">JGameDemo</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qilu.me/2015/09/27/2015-09-27/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Kaleo Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樂只君子">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 樂只君子">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/09/27/2015-09-27/" class="post-title-link" itemprop="url">Java游戏服务器-多线程异步任务派发</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-09-27 23:00:00" itemprop="dateCreated datePublished" datetime="2015-09-27T23:00:00+08:00">2015-09-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>服务器开发，高并发始终是一个不断追求的目标。若实现这个目标，将所有阻塞操作异步化是必不可少的。执行异步任务，最容易想到的是使用多线程，但线程不是多多益善，相反要控制在一定的数量。如何在多线程环境下，合理地进行任务派发，是这篇文章要讨论的。</p>
<p>就像在<a href="/post/tech/2015-06-16">概述</a>中描述的，单个游戏服务器进程主要分三层：网络、逻辑和数据存取，下面将具体阐述。</p>
<p>网络层使用Netty，将有若干worker线程收发网络消息，收到消息后如何处理呢？我见过一些服务器程序，直接在收发消息的回调函数里，执行逻辑，甚至进行数据存取，这显然是不合适的。网络线程应该专注于收发消息的操作。首先网络线程一般都是多线程，直接执行业务逻辑，即意味着业务逻辑在多线程环境下，数据同步等就成了必须解决的问题。其次一旦业务逻辑耗时较多，尤其进行数据存取操作，网络线程就会阻塞，这将严重影响网络通信进而降低并发。合适的做法是将网络消息放到逻辑线程队列，所有后续业务逻辑都交由逻辑线程处理。在Java中可以使用concurrent包提供的队列容器，比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ConcurrentLinkedQueue&lt;RequestAction&gt; requestActionQueue = <span class="keyword">new</span> <span class="title class_">ConcurrentLinkedQueue</span>&lt;RequestAction&gt;();</span><br></pre></td></tr></table></figure>

<p>逻辑线程依次从队列里取出消息并处理。这里有一个常见的困惑，逻辑线程该使用单线程还是多线程。事情不能一概而论，但大多数情况下，逻辑层是最耗CPU的，多线程并不能提高性能，并会带来数据同步等相关的问题。所以在不知道如何抉择时，单线程是更好的选择。</p>
<p>逻辑单线程，就意味着不应该有任何阻塞操作，而业务逻辑不可避免地要进行数据存取。异步任务派发就是为了解决诸如数据存取等阻塞操作需求，同时需要回调在任务结束后执行后续业务逻辑。先看一个具体示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RAUserLoginCL</span> <span class="keyword">extends</span> <span class="title class_">RequestAction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">UserLoginCL</span> <span class="variable">req</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRequest</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">        req = (UserLoginCL) msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> req.username;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> req.password;</span><br><span class="line"></span><br><span class="line">        <span class="type">TaskLoadUser</span> <span class="variable">task</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TaskLoadUser</span>(session, req);</span><br><span class="line"></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> AppLogin.getLogicService().getUserManager().getUser(username);</span><br><span class="line">        <span class="keyword">if</span> (user != <span class="literal">null</span>) &#123;</span><br><span class="line">            task.setUserData(user.getUserData());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        AppLogin.getLogicService().getTaskManager().pushTask(task);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面这段代码，即是用户登录消息的处理。<code>UserLoginCL</code> 是登录消息包，网络IO线程收到该消息后，封装成 <code>RequestAction</code> 并push到逻辑线程消息队列。逻辑线程在逻辑循环中取到该消息，并调用 <code>execute()</code> 进行业务处理。这里将处理逻辑简化，简单说就是将请求信息再封装成 <code>TaskLoadUser</code> 任务，因为我们必须先要（从数据库）加载用户数据（<code>UserData</code>）到内存，才能进行密码验证等逻辑。</p>
<p>这个任务依然会首先放到一个当前逻辑线程的任务队列，然后等待执行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TaskManager</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ConcurrentLinkedQueue&lt;Task&gt; taskQueue = <span class="keyword">new</span> <span class="title class_">ConcurrentLinkedQueue</span>&lt;Task&gt;();</span><br><span class="line">    <span class="keyword">private</span> ConcurrentHashMap&lt;Integer, Task&gt; taskMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;Integer, Task&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="type">AtomicInteger</span> <span class="variable">nextSeq</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">tick</span><span class="params">(<span class="type">long</span> milliseconds)</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (!taskQueue.isEmpty()) &#123;</span><br><span class="line">            <span class="type">Task</span> <span class="variable">task</span> <span class="operator">=</span> taskQueue.poll();</span><br><span class="line">            task.execute();</span><br><span class="line"></span><br><span class="line">            putTask(task);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Iterator&lt;Map.Entry&lt;Integer, Task&gt;&gt; iterator = taskMap.entrySet().iterator();</span><br><span class="line">        <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">            Map.Entry&lt;Integer, Task&gt; entry = iterator.next();</span><br><span class="line">            <span class="type">Task</span> <span class="variable">task</span> <span class="operator">=</span> entry.getValue();</span><br><span class="line">            task.tick(milliseconds);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (task.isFinished()) &#123;</span><br><span class="line">                task.onFinish();</span><br><span class="line">                iterator.remove();</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (task.isTimeout()) &#123;</span><br><span class="line">                task.onTimeout();</span><br><span class="line">                iterator.remove();</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>看这个任务代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TaskLoadUser</span> <span class="keyword">extends</span> <span class="title class_">Task</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">TransmitSession</span> <span class="variable">sessionIn</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">UserLoginCL</span> <span class="variable">reqIn</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">UserLoginLC</span> <span class="variable">rspOut</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserLoginLC</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">UserData</span> <span class="variable">userDataOut</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TaskLoadUser</span><span class="params">(TransmitSession sessionIn, UserLoginCL req)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sessionIn = sessionIn;</span><br><span class="line">        <span class="built_in">this</span>.reqIn = req;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">()</span> &#123;</span><br><span class="line">        setResult(UserLoginLC.SUCCESS);</span><br><span class="line">        incDesire();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (userDataOut != <span class="literal">null</span>) &#123;</span><br><span class="line">            decDesire();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        DaoService.execute(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> reqIn.username;</span><br><span class="line"></span><br><span class="line">                <span class="type">UserData</span> <span class="variable">userData</span> <span class="operator">=</span> DbUser.getUserDataByName(username);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 用户不存在</span></span><br><span class="line">                <span class="keyword">if</span> (userData == <span class="literal">null</span>) &#123;</span><br><span class="line">                    setResult(UserLoginLC.ERROR_NOUSER);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                userDataOut = userData;</span><br><span class="line">            &#125; <span class="keyword">while</span> (<span class="literal">false</span>);</span><br><span class="line">            decDesire();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFinish</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (result != UserLoginLC.SUCCESS) &#123;</span><br><span class="line">            rollback();</span><br><span class="line">            failResponse();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        succeedResponse();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTimeout</span><span class="params">()</span> &#123;</span><br><span class="line">        setResult(UserLoginLC.TIMEOUT);</span><br><span class="line">        rollback();</span><br><span class="line">        failResponse();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserData</span><span class="params">(UserData userData)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userDataOut = userData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">rollback</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Noting to do</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">succeedResponse</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 检查密码</span></span><br><span class="line">        <span class="keyword">if</span> (!reqIn.password.equals(userDataOut.password)) &#123;</span><br><span class="line">            rspOut.result = UserLoginLC.ERROR_WRONGPWD;</span><br><span class="line">            sessionIn.send(rspOut);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        rspOut.result = (<span class="type">byte</span>) result;</span><br><span class="line">        rspOut.userId = userId;</span><br><span class="line">        rspOut.token = token;</span><br><span class="line">        sessionIn.send(rspOut);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">failResponse</span><span class="params">()</span> &#123;</span><br><span class="line">        rspOut.result = (<span class="type">byte</span>) result;</span><br><span class="line">        sessionIn.send(rspOut);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面两段代码是异步任务的核心。逻辑线程取到这个任务后，调用 <code>execute()</code>，它会通过数据存取层从数据库中加载数据。<code>execute()</code> 执行后，逻辑线程仍然继续检测这个任务，直到其完成或超时。如果完成会调用 <code>onFinish()</code> 执行后续逻辑，加载可能成功或失败，分别对应 <code>succeedResponse()</code> 和 <code>failResponse()</code>，如果执行超时则执行 <code>onTimeout()</code>。</p>
<p><code>DaoService</code> 即对应数据存取层，实现上是一个线程池：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DaoService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">IOTHREADNUMBER</span> <span class="operator">=</span> Runtime.getRuntime().availableProcessors() * <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">exeSvc</span> <span class="operator">=</span> Executors.newFixedThreadPool(IOTHREADNUMBER);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable daoOperation)</span> &#123;</span><br><span class="line">        exeSvc.execute(daoOperation);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这就实现了多线程异步数据存取。代码很简短，不了解的可以查阅下Java线程池相关知识。</p>
<p>逻辑线程使用数据存取层异步加载数据，加载完成与否，逻辑线程如何得知呢？<code>incDesire()</code> 和 <code>decDesire()</code>，就是用来解决这个问题，其类似引用计数。我们可以把所有阻塞操作分解成一个个可以用多线程去异步执行的子任务，先调用 <code>incDesire(N)</code> 增加计数，<strong>N</strong> 即分解的子任务数，然后使用  <code>DaoService.execute()</code> 去依次并行执行这些子任务。每完成一个子任务调用一次 <code>decDesire(1)</code> 将计数减1，计数为0时，即表明所有异步子任务都已执行完毕。如过指定时间内计数仍然大于0，即超时。还有一个技巧是，每执行完一个子任务，设置一个数据或标志，那么在整个任务失败或超时时，就可以执行 <code>rollback()</code> 回退已完成的子任务。</p>
<p>这里有个地方需要注意下。即使只有一个子任务，也应该先调用一次 <code>incDesire()</code>。否则，因为初始任务计数为0，异步任务是多线程执行的，可能子任务还在执行中，逻辑线程就已经检测到任务计数为0而错误认为任务已经完成了。</p>
<p>经过上述这些做法，消息收发、业务逻辑和数据存取实现了完全异步化，不再存在阻塞点。需要说明的是，异步任务并非是完美的，异步越多，响应延迟越大。高并发、低延时、易扩展，是一个需要综合权衡的目标。</p>
<p>公共库仓库：<a target="_blank" rel="noopener" href="https://github.com/KaleoFeng/JMetazion.git">JMetazion</a></p>
<p>服务器示例仓库：<a target="_blank" rel="noopener" href="https://github.com/KaleoFeng/JGameDemo.git">JGameDemo</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qilu.me/2015/08/19/2015-08-19/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Kaleo Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樂只君子">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 樂只君子">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/08/19/2015-08-19/" class="post-title-link" itemprop="url">Java游戏服务器-Netty自动重连与会话管理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-08-19 15:00:00" itemprop="dateCreated datePublished" datetime="2015-08-19T15:00:00+08:00">2015-08-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>网游少不了网络通信，不像写C++时自己造轮子，Java服务器使用Netty。Netty做了很多工作，使编写网络程序变得轻松简单。灵活利用这些基础设施，以实现我们的需求。</p>
<p>其中一个需求是自动重连。自动重连有两种应用场景：</p>
<ul>
<li>开始连接时，对端尚未开启</li>
<li>连接中途断开</li>
</ul>
<p>在有多个服务器（比如LoginServer和GameServer等）时，这样就不用考虑服务器启动顺序。<br>有需求就需要有解决方案，其实很简单，Netty已经提供，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctx.channel().eventLoop().schedule(() -&gt; tryConnect(), reconnectInterval, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure>

<p><code>tryConnect</code> 是实际执行连接的方法，后面两个参数表示每隔 <code>reconnectInterval</code> 秒重连一次即执行 <code>tryConnect</code>，而对应上述两种应用场景的分别是connect失败和channel inactive时，详见后面代码。</p>
<p>自动重连解决后，还有一个问题是如何管理连接。Netty使用Channel来抽象一个连接，但实际开发时，通常逻辑上会有一个 <strong>会话（Session）</strong> 对象用来表示对端，可以在其上添加各种逻辑属性方法等，以及收发网络消息。这样一个Channel就需要对应一个Session，且方便互相索引。</p>
<p>首先考虑如何创建这个Session。</p>
<p>为了方便Netty使用和复用，我抽象了一个TcpServer&#x2F;TcpClient类分别表示服务器和客户端。理想情况是 TcpServer和TcpClient合并为一个，不同行为由Session来决定。但因为Netty的服务器和客户端分别使用ServerBootstrap和Bootstrap，其分别包含bind和connect，这个想法未能实现。</p>
<p>Session有两种，ListenSession负责监听连接请求，TransmitSession负责传输数据。在实际应用中，有这么一种需求，比如GameServer主动连接LoginServer，这时GameServer即作为client端。在连接成功时，需要GameServer主动发个注册消息给LoginServer，LoginServer籍此得知是哪个服务器组。此时，GameServer可能同时会以Client身份连接另一个服务器比如Gateway而且同样要发消息。那么作为client端主动连接的TransmitSession最好细化，需要包含要连接的主机地址、端口和重连时间等信息，也需要在Active时发送不同消息，而Server端TransmitSession并不需要。所以设计上TransmitSession又分为ClientSession和ServerSession。SeverSession由TcpServer在建立连接时自动创建，而ListenSession和ClientSession则由使用者自行创建并交由TcpServer&#x2F;TcpClient管理。</p>
<p>接口如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">ListenSession</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">working</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">localPort</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">relistenInterval</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> ServerSession <span class="title function_">createServerSession</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">TransmitSession</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="variable">working</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">onActive</span><span class="params">()</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">onInactive</span><span class="params">()</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">onException</span><span class="params">()</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Object data)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">send</span><span class="params">(Object data)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">ClientSession</span> <span class="keyword">extends</span> <span class="title class_">TransmitSession</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">remoteHost</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">remotePort</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">reconnectInterval</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其次考虑如何管理Channel和Session的对应关系。除了使用一个类似HashMap&lt;Channel, Session&gt;的容器来管理外，一个更自然的想法是直接把Session记录在Channel上就好了，这样就省去了每次查找的开销。Netty已经提供了，即Channel的AttrMap。这里或许有疑问的是，client端connect成功的Channel和Active&#x2F;Inactive时的Channel是同一个，所以可以方便放置&#x2F;取出数据。而server端bind成功的Channel放置的是ListenSession，Active&#x2F;Inactive时的Channel却是一个新的，并非bind的Channel，怎么取出之前放入的ListenSession来呢？Netty也想到了，所以提供了Channel.parent()方法，每一个Active时的Channel是由bind时的Channel创建的，后者就是前者的parent。</p>
<p>综上，TcpServer示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TcpServer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AttributeKey&lt;ListenSession&gt; LISTENSESSIONKEY = AttributeKey.valueOf(<span class="string">&quot;LISTENSESSIONKEY&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AttributeKey&lt;ServerSession&gt; SERVERSESSIONKEY = AttributeKey.valueOf(<span class="string">&quot;SERVERSESSIONKEY&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ServerBootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="type">EventLoopGroup</span> <span class="variable">bossGroup</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">EventLoopGroup</span> <span class="variable">workerGroup</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ArrayList&lt;ListenSession&gt; listenSessions = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;ListenSession&gt;();</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        bossGroup = <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">1</span>);</span><br><span class="line">        workerGroup = <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">4</span>);</span><br><span class="line">        bootstrap.group(bossGroup, workerGroup);</span><br><span class="line">        bootstrap.channel(NioServerSocketChannel.class);</span><br><span class="line">        bootstrap.childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                <span class="type">ChannelPipeline</span> <span class="variable">pipeline</span> <span class="operator">=</span> ch.pipeline();</span><br><span class="line">                pipeline.addLast(<span class="string">&quot;encode&quot;</span>, <span class="keyword">new</span> <span class="title class_">ObjectEncoder</span>());</span><br><span class="line">                pipeline.addLast(<span class="string">&quot;decode&quot;</span>, <span class="keyword">new</span> <span class="title class_">ObjectDecoder</span>(ClassResolvers.cacheDisabled(<span class="literal">null</span>)));</span><br><span class="line">                pipeline.addLast(workerGroup, <span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                        <span class="type">ListenSession</span> <span class="variable">listenSession</span> <span class="operator">=</span> ctx.channel().parent().attr(LISTENSESSIONKEY).get();</span><br><span class="line">                        <span class="type">ServerSession</span> <span class="variable">serverSession</span> <span class="operator">=</span> listenSession.createServerSession();</span><br><span class="line">                        ctx.channel().attr(SERVERSESSIONKEY).set(serverSession);</span><br><span class="line">                        serverSession.setChannel(ctx.channel());</span><br><span class="line">                        serverSession.onActive();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelInactive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                        <span class="type">ServerSession</span> <span class="variable">serverSession</span> <span class="operator">=</span> ctx.channel().attr(SERVERSESSIONKEY).get();</span><br><span class="line">                        serverSession.onInactive();</span><br><span class="line">                    &#125;</span><br><span class="line">                    ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">tryListen</span><span class="params">(ListenSession listenSession)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!listenSession.isWorking()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> listenSession.getLocalPort();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">interval</span> <span class="operator">=</span> listenSession.getRelistenInterval();</span><br><span class="line"></span><br><span class="line">        <span class="type">ChannelFuture</span> <span class="variable">f</span> <span class="operator">=</span> bootstrap.bind(port);</span><br><span class="line">        f.addListener(<span class="keyword">new</span> <span class="title class_">ChannelFutureListener</span>() &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">operationComplete</span><span class="params">(ChannelFuture f)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                <span class="keyword">if</span> (f.isSuccess()) &#123;</span><br><span class="line">                    f.channel().attr(LISTENSESSIONKEY).set(listenSession);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    f.channel().eventLoop().schedule(() -&gt; tryListen(listenSession), interval, TimeUnit.SECONDS);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果监听失败则隔<strong>interval</strong>秒重试，新连接建立时创建ServerSession关联该Channel。<br>TcpClient的实现大同小异，不同点在于需要在Channel Inactive时执行重连：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TcpClient</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AttributeKey&lt;ClientSession&gt; SESSIONKEY = AttributeKey.valueOf(<span class="string">&quot;SESSIONKEY&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="type">EventLoopGroup</span> <span class="variable">workerGroup</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ArrayList&lt;ClientSession&gt; clientSessions = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;ClientSession&gt;();</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        workerGroup = <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        bootstrap.group(workerGroup);</span><br><span class="line">        bootstrap.channel(NioSocketChannel.class);</span><br><span class="line">        bootstrap.handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                <span class="type">ChannelPipeline</span> <span class="variable">pipeline</span> <span class="operator">=</span> ch.pipeline();</span><br><span class="line">                pipeline.addLast(<span class="string">&quot;encode&quot;</span>, <span class="keyword">new</span> <span class="title class_">ObjectEncoder</span>());</span><br><span class="line">                pipeline.addLast(<span class="string">&quot;decode&quot;</span>, <span class="keyword">new</span> <span class="title class_">ObjectDecoder</span>(ClassResolvers.cacheDisabled(<span class="literal">null</span>)));</span><br><span class="line">                pipeline.addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                        <span class="type">ClientSession</span> <span class="variable">clientSession</span> <span class="operator">=</span> ctx.channel().attr(SESSIONKEY).get();</span><br><span class="line">                        clientSession.setChannel(ctx.channel());</span><br><span class="line">                        clientSession.onActive();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelInactive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                        <span class="type">ClientSession</span> <span class="variable">clientSession</span> <span class="operator">=</span> ctx.channel().attr(SESSIONKEY).get();</span><br><span class="line">                        clientSession.onInactive();</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">interval</span> <span class="operator">=</span> clientSession.getReconnectInterval();</span><br><span class="line">                        ctx.channel().eventLoop().schedule(() -&gt; tryConnect(clientSession), interval, TimeUnit.SECONDS);</span><br><span class="line">                    &#125;</span><br><span class="line">                    ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">tryConnect</span><span class="params">(ClientSession clientSession)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!clientSession.isWorking()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> clientSession.getRemoteHost();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> clientSession.getRemotePort();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">interval</span> <span class="operator">=</span> clientSession.getReconnectInterval();</span><br><span class="line"></span><br><span class="line">        <span class="type">ChannelFuture</span> <span class="variable">future</span> <span class="operator">=</span> bootstrap.connect(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(host, port));</span><br><span class="line">        future.addListener(<span class="keyword">new</span> <span class="title class_">ChannelFutureListener</span>() &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">operationComplete</span><span class="params">(ChannelFuture f)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                <span class="keyword">if</span> (f.isSuccess()) &#123;</span><br><span class="line">                    f.channel().attr(SESSIONKEY).set(clientSession);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    f.channel().eventLoop().schedule(() -&gt; tryConnect(clientSession), interval, TimeUnit.SECONDS);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果需要监听多个端口或连接多个目的主机，只需要创建多个ClientSession&#x2F;ListenSession即可。如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">TcpServer</span> <span class="variable">tcpServer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TcpServer</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">LSServer</span> <span class="variable">lsServer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LSServer</span>();</span><br><span class="line"><span class="keyword">private</span> <span class="type">LSClient</span> <span class="variable">lsClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LSClient</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="variable">privatePort</span> <span class="operator">=</span> ServerConfig.getInstance().privatePort;</span><br><span class="line">lsServer.setLocalPort(privatePort);</span><br><span class="line">lsServer.setRelistenInterval(<span class="number">10</span>);</span><br><span class="line">tcpServer.attach(lsServer);</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="variable">publicPort</span> <span class="operator">=</span> ServerConfig.getInstance().publicPort;</span><br><span class="line">lsClient.setLocalPort(publicPort);</span><br><span class="line">lsClient.setRelistenInterval(<span class="number">10</span>);</span><br><span class="line">tcpServer.attach(lsClient);</span><br></pre></td></tr></table></figure>

<p>另外值得一提的是网上很多例子，都会在bind端口后，调用如下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f.channel().closeFuture().sync();</span><br></pre></td></tr></table></figure>

<p>这会阻塞当前线程，其实就是在当前线程做main loop。而实际游戏服务器中，通常main线程做逻辑线程，逻辑线程需要自己tick，也就是自定义main loop，我们在其中执行一些每帧更新的逻辑。所以并不需要上面这种方式。</p>
<p>公共库仓库：<a target="_blank" rel="noopener" href="https://github.com/KaleoFeng/JMetazion.git">JMetazion</a></p>
<p>服务器示例仓库：<a target="_blank" rel="noopener" href="https://github.com/KaleoFeng/JGameDemo.git">JGameDemo</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qilu.me/2015/07/16/2015-07-16/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Kaleo Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樂只君子">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 樂只君子">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/07/16/2015-07-16/" class="post-title-link" itemprop="url">Java游戏服务器-概述</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-07-16 17:00:00" itemprop="dateCreated datePublished" datetime="2015-07-16T17:00:00+08:00">2015-07-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>上个项目结束后，转做手游。新接手的项目，需要从头构建服务器。之前一直做C++，手游以Java居多，同时我也想做些不同的东西，于是时隔8年后再次捡起Java。好在服务器开发的领域知识是主要的，语言是其次，但一些惯例技巧还是需要慢慢熟知。这个系列博客，就是记录其中点滴。</p>
<p>新项目是休闲类游戏，服务器需求比较简单，采用分区分服机制。客户端通过短连接或长连接向服务器主动请求，服务器返回响应数据。不用HTTP是为了减少网络包大小，同时有更多可控性。不用UDP是希望尽量利用TCP的特性保证数据包的可靠传输。</p>
<p>鉴于需求较简单，服务器只分了两种，LoginServer和GameServer。数据存储使用了Mysql和阿里云OSS，缓存使用了Redis。</p>
<p>LoginServer负责账户创建和登录等，同时也管理服务器列表。一个大区可以有若干个，采用DNS负载均衡，客户端行为主要有三种，注册、登录和选择服务器，每次登录流程需要连接同一个服务器。</p>
<p>GameServer负责具体的游戏逻辑。主要分三层：网络、逻辑和数据存取。网络使用Netty，开一个Boss线程和CPU数目的Worker线程。逻辑单线程，有消息队列，网络层收到的消息放入该队列，等待处理。逻辑若有阻塞当前线程的数据存取需求，比如读写数据库或存档上传下载等，封装成任务交由数据存取层处理。数据存取层负责处理同步数据请求任务，其使用线程池，包含CPU数目的固定线程。任务执行完成后，逻辑线程进行后续的操作。</p>
<p>数据存储采用了Mysql和阿里云OSS。Mysql主要用于角色ID生成和便于信息查询，游戏数据以OSS记录为准。</p>
<p>为了提高读写效率，增加并发，GameServer采用了缓存策略，有两级缓存：内存和Redis。平时逻辑操作的都是内存数据。玩家进入游戏加载数据时，首先查看内存，没有则查看Redis，没有则查询数据库和OSS，加载后也会将数据缓存到Redis。</p>
<p>由于逻辑操作的都是内存数据，若服务器发生宕机等情形，会导致数据丢失，即所谓回档。为解决这个问题，数据会以30秒间隔定时写入Redis，300秒间隔写入数据库和OSS。同时，对于涉及金钱等的关键操作，每次都会标记数据记录为dirty，逻辑线程一旦检测到dirty，则会立刻发起写入Redis、数据库和OSS的同步任务。这样不能保证数据百分百不会丢失，但已足够实用有效。</p>
<p>本文是对目前项目服务器架构的简要介绍，一些细节问题将在后续文章中具体论述。</p>
<p>公共库仓库：<a target="_blank" rel="noopener" href="https://github.com/KaleoFeng/JMetazion.git">JMetazion</a></p>
<p>服务器示例仓库：<a target="_blank" rel="noopener" href="https://github.com/KaleoFeng/JGameDemo.git">JGameDemo</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qilu.me/2015/05/01/2015-05-01/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Kaleo Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樂只君子">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 樂只君子">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/05/01/2015-05-01/" class="post-title-link" itemprop="url">又是一年</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-05-01 23:00:00" itemprop="dateCreated datePublished" datetime="2015-05-01T23:00:00+08:00">2015-05-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Trifle/" itemprop="url" rel="index"><span itemprop="name">Trifle</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>去年的今天，开了这个博客，这么快，一年又过去了。</p>
<p>开始的几个月，凭着一股新鲜和激情的劲儿，写了些文章。最近几个月，却有开始荒废了。代码也是，过年回来，Github上就鲜少增加新的色块了。</p>
<p>虽然东西出的少了，最近的事儿却没少做。</p>
<p>年后学了不少东西，有时也想写博客记录下来。可写出一篇中意的文章总是很花费时间和精力的，架不住懒，尤其是想到要图文搭配，着实麻烦，就在心理暗示下放着了。</p>
<p>代码方面。之前写的东西因为一直没有项目驱动，没有愿望更新。而新的项目，因为没有需求驱动，也不着手。接下来要打破下怪圈才是。</p>
<p>这一两个月还在减肥，一年前向别人承诺的事儿，现在才做。每天只有中午能正常吃一顿，早晚两餐都在控制，大部分时候是燕麦片+奶粉+葡萄干。晚上也增加了室内运动，半小时左右。减肥这事儿，易或难不怎么好说，最大的对手就是自己。那些不断冒出的“今天怎么怎么就吃点好的&#x2F;不做运动了吧”的念头，总是给自己不好的暗示，挺过了，也就跨越了。效果是有的，已经减掉4KG，比较遗憾的就是该减的地方还是没什么动静。革命尚未成功，仍需努力。</p>
<p>游戏快上线了，值得欣慰的是还是没怎么加班。但有时投入进去，到下午5、6点钟就感觉精神疲惫，做不了什么了。会尽自己所能，毕竟已经投入三年。</p>
<p>这些日子也在考虑未来定居问题。初步目的地是杭州，心路历程就不细表了，正在为此做准备。</p>
<p>马上进入盛夏了，一年里最喜欢的这段时间，希望一切都更好。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Kaleo Feng</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
