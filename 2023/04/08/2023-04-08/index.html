<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha256-CTSx/A06dm1B063156EVh15m6Y67pAjZZaQc89LLSrU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"qilu.me","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.18.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="UE4版本 v4.26 操作系统 CentOS 7 编译器 clang version 10.0.1 问题项目流水线执行 BuildEngine 构建引擎，时不时出现 undefined reference 的链接错误，重试后可构建成功。 时常出现，重试成功，极大可能是链接时序问题。 复现本地服务器搭建类似环境，尝试复现该问题。 查阅 UE4 构建工具的代码，在合适地方添加日志，分析日志结合代码，">
<meta property="og:type" content="article">
<meta property="og:title" content="UE4构建时未定义的引用的链接问题">
<meta property="og:url" content="https://qilu.me/2023/04/08/2023-04-08/index.html">
<meta property="og:site_name" content="樂只君子">
<meta property="og:description" content="UE4版本 v4.26 操作系统 CentOS 7 编译器 clang version 10.0.1 问题项目流水线执行 BuildEngine 构建引擎，时不时出现 undefined reference 的链接错误，重试后可构建成功。 时常出现，重试成功，极大可能是链接时序问题。 复现本地服务器搭建类似环境，尝试复现该问题。 查阅 UE4 构建工具的代码，在合适地方添加日志，分析日志结合代码，">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-04-08T02:00:00.000Z">
<meta property="article:modified_time" content="2023-10-31T14:37:30.453Z">
<meta property="article:author" content="Kaleo Feng">
<meta property="article:tag" content="链接">
<meta property="article:tag" content="Unreal Engine">
<meta property="article:tag" content="虚幻引擎">
<meta property="article:tag" content="UE4">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://qilu.me/2023/04/08/2023-04-08/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://qilu.me/2023/04/08/2023-04-08/","path":"2023/04/08/2023-04-08/","title":"UE4构建时未定义的引用的链接问题"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>UE4构建时未定义的引用的链接问题 | 樂只君子</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">樂只君子</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">起舞弄清影</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%97%AE%E9%A2%98"><span class="nav-number">1.</span> <span class="nav-text">问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%8D%E7%8E%B0"><span class="nav-number">2.</span> <span class="nav-text">复现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E6%9E%90"><span class="nav-number">3.</span> <span class="nav-text">分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%93%BE%E6%8E%A5%E7%94%9F%E6%88%90-libUE4Editor-Engine-so"><span class="nav-number">3.1.</span> <span class="nav-text">链接生成 libUE4Editor-Engine.so</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%93%BE%E6%8E%A5%E7%94%9F%E6%88%90-UE4Editor"><span class="nav-number">3.2.</span> <span class="nav-text">链接生成 UE4Editor</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9A%E4%BD%8D"><span class="nav-number">4.</span> <span class="nav-text">定位</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3"><span class="nav-number">5.</span> <span class="nav-text">解决</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B9%E6%A1%881"><span class="nav-number">5.1.</span> <span class="nav-text">方案1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B9%E6%A1%882"><span class="nav-number">5.2.</span> <span class="nav-text">方案2</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%A9%E5%B1%95"><span class="nav-number">6.</span> <span class="nav-text">扩展</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8D%E6%8C%87%E5%AE%9A%E4%BE%9D%E8%B5%96%E5%BA%93"><span class="nav-number">6.1.</span> <span class="nav-text">不指定依赖库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%87%E5%AE%9A%E4%BE%9D%E8%B5%96%E5%BA%93"><span class="nav-number">6.2.</span> <span class="nav-text">指定依赖库</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E4%BF%A1%E6%81%AF"><span class="nav-number">7.</span> <span class="nav-text">参考信息</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#GNU-ld"><span class="nav-number">7.1.</span> <span class="nav-text">GNU ld</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LLVM-ld-lld"><span class="nav-number">7.2.</span> <span class="nav-text">LLVM ld.lld</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Kaleo Feng</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">48</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">99</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://qilu.me/2023/04/08/2023-04-08/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Kaleo Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樂只君子">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="UE4构建时未定义的引用的链接问题 | 樂只君子">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          UE4构建时未定义的引用的链接问题
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-04-08 10:00:00" itemprop="dateCreated datePublished" datetime="2023-04-08T10:00:00+08:00">2023-04-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>UE4版本 <code>v4.26</code></p>
<p>操作系统 <code>CentOS 7</code></p>
<p>编译器 <code>clang version 10.0.1</code></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>项目流水线执行 <code>BuildEngine</code> 构建引擎，时不时出现 <code>undefined reference</code> 的链接错误，重试后可构建成功。</p>
<p>时常出现，重试成功，极大可能是链接时序问题。</p>
<h2 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h2><p>本地服务器搭建类似环境，尝试复现该问题。</p>
<p>查阅 UE4 构建工具的代码，在合适地方添加日志，分析日志结合代码，最终确定问题所在。</p>
<p><code>UE4Editor</code> 可执行文件 依赖于 <code>libUE4Editor-Engine.so</code>，<code>libUE4Editor-Engine.so</code> 依赖于 <code>libUE4Editor-Xyz.so</code>，<code>UE4Editor</code> 不直接依赖 <code>libUE4Editor-Xyz.so</code>。</p>
<p>链接错误出现在链接生成 <code>UE4Editor</code> 的时候，需要去链接 <code>libUE4Editor-Engine.so</code>，此时报错找不到 <code>libUE4Editor-Xyz.so</code> 中的符号， 即 <code>undefined reference</code>。</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>分析链接过程。</p>
<h3 id="链接生成-libUE4Editor-Engine-so"><a href="#链接生成-libUE4Editor-Engine-so" class="headerlink" title="链接生成 libUE4Editor-Engine.so"></a>链接生成 <code>libUE4Editor-Engine.so</code></h3><p><code>libUE4Editor-Engine.so</code> 包含引擎核心代码，其会引用大量依赖其他模块，也有一些其他模块依赖它，这样就出现了模块循环依赖。</p>
<p>UE4 构建时，考虑到了循环依赖情况，会采取类似下面措施处理。</p>
<p>像 <code>libUE4Editor-Engine.so</code> 这种出现循环依赖的库，会进行两次链接。</p>
<p>第一次链接仅链接生成库自身，链接脚本 <code>Link-libUE4Editor-Engine.so.link.sh</code>。</p>
<p>关键链接参数：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Wl,--start-group -lpthread -lrt -ldl -Wl,--allow-shlib-undefined -Wl,--end-group</span><br></pre></td></tr></table></figure>

<ul>
<li>没有指定依赖的库 这样生成的 so 中不包含依赖库信息。</li>
<li>指定允许未定义符号参数 <code>-Wl,--allow-shlib-undefined</code> 该参数会在链接时忽略未定义的符号，从而即使找不到依赖库的符号，也不会报错。</li>
</ul>
<p>第二次重链接会生成完整的库，链接脚本 <code>Relink-libUE4Editor-Engine.so.sh</code>。</p>
<p>关键链接参数：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Wl,--start-group -lpthread -lrt -ldl -lUE4Editor-Xyz -Wl,--end-group</span><br></pre></td></tr></table></figure>

<ul>
<li>指定了依赖的库 参数 <code>-lUE4Editor-Xyz</code> 表示其依赖于 <code>libUE4Editor-Xyz.so</code>。</li>
<li>没有指定允许未定义符号参数 默认情况下，链接可执行程序时有符号未定义，就会报错，但链接动态库时，会忽略未定义符号，不会报错。</li>
</ul>
<h3 id="链接生成-UE4Editor"><a href="#链接生成-UE4Editor" class="headerlink" title="链接生成 UE4Editor"></a>链接生成 <code>UE4Editor</code></h3><p>关键链接参数：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--unresolved-symbols=ignore-in-shared-libs --start-group -lUE4Editor-Xyz --unresolved-symbols=ignore-in-shared-libs --end-group</span><br></pre></td></tr></table></figure>

<ul>
<li>指定了未定义符号处理策略参数 <code>--unresolved-symbols=ignore-in-shared-libs</code> 会忽略来自动态库中的未定义符号，不会报错。</li>
</ul>
<p>观察上述信息，如果出现符号未定义的链接错误，需要满足两点。</p>
<ul>
<li>链接参数指定的未定义符号处理策略参数无效，这样链接的时候就还是会去找动态库中未定义的符号。</li>
<li>未定义的符号找不到，意味着其所在的依赖库信息找不到，也意味着链接生成可执行程序 <code>UE4Editor</code>时，去链接的动态库 <code>libUE4Editor-Engine.so</code>，是第一次链接生成的不包含依赖库信息的库，而不是重链接生成的那个完整的库。</li>
</ul>
<h2 id="定位"><a href="#定位" class="headerlink" title="定位"></a>定位</h2><p>UE4的每个编译或链接等操作，都被定义成一个 Action。</p>
<p>此例中，仅考虑链接情况，有4个Action。</p>
<ul>
<li><code>libUE4Editor-Xyz.so 链接Action</code></li>
<li><code>libUE4Editor-Engine.so 链接Action</code></li>
<li><code>libUE4Editor-Engine.so 重链接Action</code></li>
<li><code>UE4Editor 链接Action</code></li>
</ul>
<p>Action彼此之间有依赖关系，被依赖的Action先执行完成后，才会执行依赖Action。</p>
<p>到这里一切看似正常，但 UE4 实际实现时，存在一个问题，重链接Action不会被依赖。</p>
<p>此例中，<code>UE4Editor 链接Action</code> 应该依赖于 <code>libUE4Editor-Engine.so 重链接Action</code>，这样才能保证其链接的是一个完整库。但其实际依赖的仅是 <code>libUE4Editor-Engine.so 链接Action</code>。</p>
<p><code>libUE4Editor-Engine.so 重链接Action</code>  和 <code>UE4Editor 链接Action</code> 都依赖于 <code>libUE4Editor-Engine.so 链接Action</code>，但彼此间没有依赖关系。所以在实际构建时，时序不确定。</p>
<ul>
<li><p>如果Engine重链接Action执行完成后，Editor才开始链接，Editor链接的就是完整的Engine.so，此时正常。</p>
</li>
<li><p>如果Engine重链接Action执行中，Editor已经开始链接，Editor链接的就是Engine第一次链接后的那个不完整的Engine.so，这个so中不包含依赖库信息，所以Editor也就找不到 <code>libUE4Editor-Xyz.so</code>。</p>
</li>
</ul>
<p>问题就出在第二种情况下。找不到Xyz.so，当然其中的符号就是未定义了，此时报错 <code>undefined reference</code>。</p>
<p>但前面已经分析过，链接过程中指定了 <code>--unresolved-symbols=ignore-in-shared-libs</code>，会忽略未定义符号，不应该报错才对。</p>
<p>经过对比测试，在使用 <code>LLVM ld.lld</code> 链接器时才会出现该问题，使用 <code>GUN ld</code> 链接器没有问题。<code>LLVM ld.lld</code> 链接器中这个参数没有效果（至少是当前使用的这个版本 <code>LLD 10.0.1 (compatible with GNU linkers)</code>）。</p>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><h3 id="方案1"><a href="#方案1" class="headerlink" title="方案1"></a>方案1</h3><p>换一个 <code>LLVM ld.lld</code> 链接器支持的参数。</p>
<p>修改文件 <code>LinuxToolChain.cs</code> 中的代码，将忽略未定义符号链接参数 <code>--unresolved-symbols=ignore-in-shared-libs</code> 替换为 <code>--allow-shlib-undefined</code>。</p>
<h3 id="方案2"><a href="#方案2" class="headerlink" title="方案2"></a>方案2</h3><p>让 <code>UE4Editor 链接Action</code> 依赖于 <code>libUE4Editor-Engine.so 重链接Action</code>。</p>
<p>文件 <code>Actions.cs</code> 中的 <code>class Action</code> 中添加一个字段，保存其关联的Action，即用来在 链接Action 中保存其对应的 重链接Action。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> The actions that this action related(e.g. relink)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> List&lt;Action&gt; RelatedActions = <span class="keyword">new</span> List&lt;Action&gt;();</span><br></pre></td></tr></table></figure>

<p>文件 <code>LinuxToolChain.cs</code> 中 添加代码。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RelinkAction.bProducesImportLibrary = LinkAction.bProducesImportLibrary;</span><br></pre></td></tr></table></figure>

<p><code>bProducesImportLibrary</code> 这个字段后面会用来区分构建的是可执行程序还是动态库，因为只有可执行程序链接时，才会出现问<br>题。这里让 重链接Action 跟 第一次链接Action 保持一致。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LinkAction.RelatedActions.Add(RelinkAction);</span><br></pre></td></tr></table></figure>

<p>记录下 第一次链接Action 对应的 重链接Action。</p>
<p>文件 <code>ActionsGraph.cs</code> 的 <code>ActionGraph::Link</code> 中添加代码。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!Action.bProducesImportLibrary)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (Action RelatedAction <span class="keyword">in</span> PrerequisiteAction.RelatedActions)</span><br><span class="line">    &#123;</span><br><span class="line">        Action.PrerequisiteActions.Add(RelatedAction);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>把 重链接Action 添加到依赖于 第一次链接Action 的可执行文件链接Action的依赖列表，这样可执行文件一定会在 重链接Action 执行完成即完整so生成后，才会开始链接。</p>
<p>修改后观察，链接成功，问题已解决。</p>
<h2 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h2><p>假设 <code>c.exe</code> 依赖于 <code>libb.so</code>，<code>libb.so</code> 依赖于 <code>liba.so</code>。</p>
<h3 id="不指定依赖库"><a href="#不指定依赖库" class="headerlink" title="不指定依赖库"></a>不指定依赖库</h3><p>构建 <code>libb.so</code> 时不指定依赖库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -shared -fPIC -o libb.so b.c</span><br></pre></td></tr></table></figure>

<p><code>ldd libb.so</code> 结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">linux-vdso.so.1 (0x00007fff96b3a000)</span><br><span class="line"><span class="meta prompt_">/$</span><span class="language-bash">LIB/libonion.so =&gt; /lib64/libonion.so (0x00007f52dc3bc000)</span></span><br><span class="line">libc.so.6 =&gt; /lib64/libc.so.6 (0x00007f52dc1ec000)</span><br><span class="line">libdl.so.2 =&gt; /lib64/libdl.so.2 (0x00007f52dc1e5000)</span><br><span class="line">/lib64/ld-linux-x86-64.so.2 (0x00007f52dc3cb000)</span><br></pre></td></tr></table></figure>

<p>使用 <code>LLVM ld</code></p>
<hr>
<p>构建 <code>c.exe</code> 时不指定依赖库，不指定链接参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -fuse-ld=lld -o c.exe c.c -Wl,--start-group -Wl,--end-group</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ld.lld: error: undefined symbol: cal</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; referenced by c.c</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt;               /tmp/c-e8630d.o:(main)</span></span><br><span class="line">clang: error: linker command failed with exit code 1 (use -v to see invocation)</span><br></pre></td></tr></table></figure>

<p>构建 <code>c.exe</code> 时指定依赖库，不指定链接参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -fuse-ld=lld -o c.exe c.c -L. -Wl,--start-group -lb -Wl,--end-group</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ld.lld: error: ./libb.so: undefined reference to sum</span><br><span class="line">clang: error: linker command failed with exit code 1 (use -v to see invocation)</span><br></pre></td></tr></table></figure>

<p>构建 <code>c.exe</code> 时指定依赖库，指定链接参数 <code>--unresolved-symbols=ignore-in-shared-libs</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -fuse-ld=lld -o c.exe c.c -L. -Wl,--start-group -lb -Wl,--unresolved-symbols=ignore-in-shared-libs -Wl,--end-group</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ld.lld: error: ./libb.so: undefined reference to sum</span><br><span class="line">clang: error: linker command failed with exit code 1 (use -v to see invocation)</span><br></pre></td></tr></table></figure>

<p>构建 <code>c.exe</code> 时指定依赖库，指定链接参数 <code>--allow-shlib-undefined</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -fuse-ld=lld -o c.exe c.c -L. -Wl,--start-group -lb -Wl,--allow-shlib-undefined -Wl,--end-group</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">构建成功</span><br></pre></td></tr></table></figure>

<p>使用 <code>GNU ld</code></p>
<hr>
<p>构建 <code>c.exe</code> 时不指定依赖库，不指定链接参数，使用 <code>GNU ld</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -o c.exe c.c -Wl,--start-group -Wl,--end-group</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">x86_64-unknown-linux-gnu-ld: /tmp/c-d47523.o: in function `main&#x27;:</span><br><span class="line">c.c:(.text+0x1a): undefined reference to `cal&#x27;</span><br><span class="line">clang: error: linker command failed with exit code 1 (use -v to see invocation)</span><br></pre></td></tr></table></figure>

<p>构建 <code>c.exe</code> 时指定依赖库，不指定链接参数，使用 <code>GNU ld</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -o c.exe c.c -L. -Wl,--start-group -lb -Wl,--end-group</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x86_64-unknown-linux-gnu-ld: ./libb.so: undefined reference to `sum&#x27;</span><br><span class="line">clang: error: linker command failed with exit code 1 (use -v to see invocation)</span><br></pre></td></tr></table></figure>

<p>构建 <code>c.exe</code> 时指定依赖库，指定链接参数 <code>--unresolved-symbols=ignore-in-shared-libs</code>，使用 <code>GNU ld</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -o c.exe c.c -L. -Wl,--start-group -lb -Wl,--unresolved-symbols=ignore-in-shared-libs -Wl,--end-group</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">构建成功</span><br></pre></td></tr></table></figure>

<p>构建 <code>c.exe</code> 时指定依赖库，指定链接参数 <code>--allow-shlib-undefined</code>，使用 <code>GNU ld</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -o c.exe c.c -L. -Wl,--start-group -lb -Wl,--allow-shlib-undefined -Wl,--end-group</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">构建成功</span><br></pre></td></tr></table></figure>

<h3 id="指定依赖库"><a href="#指定依赖库" class="headerlink" title="指定依赖库"></a>指定依赖库</h3><p>构建 <code>libb.so</code> 时指定依赖库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -shared -fPIC -o libb.so b.c -L. -la</span><br></pre></td></tr></table></figure>

<p><code>ldd libb.so</code> 结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">linux-vdso.so.1 (0x00007ffee9716000)</span><br><span class="line"><span class="meta prompt_">/$</span><span class="language-bash">LIB/libonion.so =&gt; /lib64/libonion.so (0x00007f6f815bb000)</span></span><br><span class="line">liba.so =&gt; not found</span><br><span class="line">libc.so.6 =&gt; /lib64/libc.so.6 (0x00007f6f813eb000)</span><br><span class="line">libdl.so.2 =&gt; /lib64/libdl.so.2 (0x00007f6f813e4000)</span><br><span class="line">/lib64/ld-linux-x86-64.so.2 (0x00007f6f815ca000)</span><br></pre></td></tr></table></figure>

<p>使用 <code>LLVM ld</code></p>
<hr>
<p>构建 <code>c.exe</code> 时不指定依赖库，不指定链接参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -fuse-ld=lld -o c.exe c.c -Wl,--start-group -Wl,--end-group</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ld.lld: error: undefined symbol: cal</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; referenced by c.c</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt;               /tmp/c-cb2dc3.o:(main)</span></span><br><span class="line">clang: error: linker command failed with exit code 1 (use -v to see invocation)</span><br></pre></td></tr></table></figure>

<p>构建 <code>c.exe</code> 时指定依赖库，不指定链接参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -fuse-ld=lld -o c.exe c.c -L. -Wl,--start-group -lb -Wl,--end-group</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">构建成功</span><br></pre></td></tr></table></figure>

<p>构建 <code>c.exe</code> 时指定依赖库，指定链接参数 <code>--unresolved-symbols=ignore-in-shared-libs</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -fuse-ld=lld -o c.exe c.c -L. -Wl,--start-group -lb -Wl,--unresolved-symbols=ignore-in-shared-libs -Wl,--end-group</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">构建成功</span><br></pre></td></tr></table></figure>

<p>构建 <code>c.exe</code> 时指定依赖库，指定链接参数 <code>--allow-shlib-undefined</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -fuse-ld=lld -o c.exe c.c -L. -Wl,--start-group -lb -Wl,--allow-shlib-undefined -Wl,--end-group</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">构建成功</span><br></pre></td></tr></table></figure>

<p>使用 <code>GNU ld</code></p>
<hr>
<p>构建 <code>c.exe</code> 时不指定依赖库，不指定链接参数，使用 <code>GNU ld</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -o c.exe c.c -Wl,--start-group -Wl,--end-group</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">x86_64-unknown-linux-gnu-ld: /tmp/c-d74279.o: in function `main&#x27;:</span><br><span class="line">c.c:(.text+0x1a): undefined reference to `cal&#x27;</span><br><span class="line">clang: error: linker command failed with exit code 1 (use -v to see invocation)</span><br></pre></td></tr></table></figure>

<p>构建 <code>c.exe</code> 时指定依赖库，不指定链接参数，使用 <code>GNU ld</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -o c.exe c.c -L. -Wl,--start-group -lb -Wl,--end-group</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bin/x86_64-unknown-linux-gnu-ld: warning: liba.so, needed by ./libb.so, not found (try using -rpath or -rpath-link)</span><br><span class="line">x86_64-unknown-linux-gnu-ld: ./libb.so: undefined reference to `sum&#x27;</span><br><span class="line">clang: error: linker command failed with exit code 1 (use -v to see invocation)</span><br></pre></td></tr></table></figure>

<p>构建 <code>c.exe</code> 时指定依赖库，指定链接参数 <code>--unresolved-symbols=ignore-in-shared-libs</code>，使用 <code>GNU ld</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -o c.exe c.c -L. -Wl,--start-group -lb -Wl,--unresolved-symbols=ignore-in-shared-libs -Wl,--end-group</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">构建成功</span><br></pre></td></tr></table></figure>

<p>构建 <code>c.exe</code> 时指定依赖库，指定链接参数 <code>--allow-shlib-undefined</code>，使用 <code>GNU ld</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -o c.exe c.c -L. -Wl,--start-group -lb -Wl,--allow-shlib-undefined -Wl,--end-group</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">构建成功</span><br></pre></td></tr></table></figure>

<h2 id="参考信息"><a href="#参考信息" class="headerlink" title="参考信息"></a>参考信息</h2><h3 id="GNU-ld"><a href="#GNU-ld" class="headerlink" title="GNU ld"></a>GNU ld</h3><p><a target="_blank" rel="noopener" href="https://linux.die.net/man/1/ld">Manual</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">--unresolved-symbols=method</span><br><span class="line">Determine how to handle unresolved symbols. There are four possible values for method:</span><br><span class="line">ignore-all</span><br><span class="line">  Do not report any unresolved symbols.</span><br><span class="line">report-all</span><br><span class="line">  Report all unresolved symbols. This is the default.</span><br><span class="line">ignore-in-object-files</span><br><span class="line">  Report unresolved symbols that are contained in shared libraries, but ignore them if they come from regular object files.</span><br><span class="line">ignore-in-shared-libs</span><br><span class="line">  Report unresolved symbols that come from regular object files, but ignore them if they come from shared libraries. This can be useful when creating a dynamic binary and it is known that all the shared libraries that it should be referencing are included on the linker&#x27;s command line.</span><br><span class="line">The behaviour for shared libraries on their own can also be controlled by the --[no-]allow-shlib-undefined option.</span><br><span class="line">Normally the linker will generate an error message for each reported unresolved symbol but the option --warn-unresolved-symbols can change this to a warning.</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">--allow-shlib-undefined</span><br><span class="line">--no-allow-shlib-undefined</span><br><span class="line">Allows or disallows undefined symbols in shared libraries. This switch is similar to --no-undefined except that it determines the behaviour when the undefined symbols are in a shared library rather than a regular object file. It does not affect how undefined symbols in regular object files are handled.</span><br><span class="line">The default behaviour is to report errors for any undefined symbols referenced in shared libraries if the linker is being used to create an executable, but to allow them if the linker is being used to create a shared library.</span><br><span class="line"></span><br><span class="line">The reasons for allowing undefined symbol references in shared libraries specified at link time are that:</span><br><span class="line"></span><br><span class="line">â€¢ A shared library specified at link time may not be the same as the one that is available at load time, so the symbol might actually be resolvable at load time.</span><br><span class="line">â€¢ There are some operating systems, eg BeOS and HPPA , where undefined symbols in shared libraries are normal.</span><br><span class="line"></span><br><span class="line">The BeOS kernel for example patches shared libraries at load time to select whichever function is most appropriate for the current architecture. This is used, for example, to dynamically select an appropriate memset function.</span><br></pre></td></tr></table></figure>

<h3 id="LLVM-ld-lld"><a href="#LLVM-ld-lld" class="headerlink" title="LLVM ld.lld"></a>LLVM ld.lld</h3><p><a target="_blank" rel="noopener" href="https://nxmnpg.lemoda.net/1/ld.lld">Manual</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--allow-shlib-undefined</span><br><span class="line">Allow unresolved references in shared libraries. This option is enabled by default when linking a shared library.</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--unresolved-symbols -= value</span><br><span class="line">Determine how to handle unresolved symbols.</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E9%93%BE%E6%8E%A5/" rel="tag"># 链接</a>
              <a href="/tags/Unreal-Engine/" rel="tag"># Unreal Engine</a>
              <a href="/tags/%E8%99%9A%E5%B9%BB%E5%BC%95%E6%93%8E/" rel="tag"># 虚幻引擎</a>
              <a href="/tags/UE4/" rel="tag"># UE4</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/09/22/2022-09-22/" rel="prev" title="微博超话批量关注、签到、发帖、评论、捞贴一键脚本（油猴扩展版）">
                  <i class="fa fa-angle-left"></i> 微博超话批量关注、签到、发帖、评论、捞贴一键脚本（油猴扩展版）
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/07/20/2023-07-20/" rel="next" title="大语言模型 ChatGLM 微调环境搭建（Docker版）">
                  大语言模型 ChatGLM 微调环境搭建（Docker版） <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Kaleo Feng</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
