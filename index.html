<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha256-CTSx/A06dm1B063156EVh15m6Y67pAjZZaQc89LLSrU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"qilu.me","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.18.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="樂只君子">
<meta property="og:url" content="https://qilu.me/index.html">
<meta property="og:site_name" content="樂只君子">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Kaleo Feng">
<meta property="article:tag" content="樂只君子">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://qilu.me/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>樂只君子</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">樂只君子</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">起舞弄清影</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Kaleo Feng</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">48</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">99</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qilu.me/2023/07/20/2023-07-20/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Kaleo Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樂只君子">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 樂只君子">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/07/20/2023-07-20/" class="post-title-link" itemprop="url">大语言模型 ChatGLM 微调环境搭建（Docker版）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-07-20 21:00:00" itemprop="dateCreated datePublished" datetime="2023-07-20T21:00:00+08:00">2023-07-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="系统平台"><a href="#系统平台" class="headerlink" title="系统平台"></a>系统平台</h2><h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><p>系统：Ubuntu 20.04</p>
<h3 id="设置"><a href="#设置" class="headerlink" title="设置"></a>设置</h3><h4 id="NVIDIA-Docker支持"><a href="#NVIDIA-Docker支持" class="headerlink" title="NVIDIA Docker支持"></a>NVIDIA Docker支持</h4><p>安装 <code>nvidia-container-toolkit</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">distribution=$(. /etc/os-release;echo $ID$VERSION_ID)</span><br><span class="line">curl -s -L https://nvidia.github.io/nvidia-docker/gpgkey | sudo apt-key add -</span><br><span class="line">curl -s -L https://nvidia.github.io/nvidia-docker/$distribution/nvidia-docker.list | sudo tee /etc/apt/sources.list.d/nvidia-docker.list</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install nvidia-container-toolkit -y</span><br></pre></td></tr></table></figure>

<h4 id="Docker软件"><a href="#Docker软件" class="headerlink" title="Docker软件"></a>Docker软件</h4><p>安装 Docker</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install docker.io -y</span><br></pre></td></tr></table></figure>

<p>给予当前用户 docker 权限</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo gpasswd -a $USER docker</span><br><span class="line">groups</span><br></pre></td></tr></table></figure>

<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/580156606">如何在Docker中搭建CUDA &amp; CUDNN 开发环境</a></p>
<p><a target="_blank" rel="noopener" href="https://mdnice.com/writing/92d10f493d794825b447a48ea5a9ab3a">Docker容器如何优雅使用NVIDIA GPU</a></p>
<h2 id="Docker容器"><a href="#Docker容器" class="headerlink" title="Docker容器"></a>Docker容器</h2><h3 id="自定义镜像"><a href="#自定义镜像" class="headerlink" title="自定义镜像"></a>自定义镜像</h3><h4 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h4><p>Dockerfile</p>
<figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> nvidia/cuda:<span class="number">12.0</span>.<span class="number">1</span>-cudnn8-devel-ubuntu20.<span class="number">04</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> maintainer=<span class="string">&quot;KaleoFeng&quot;</span> \</span></span><br><span class="line"><span class="language-bash">  version=<span class="string">&quot;1.0-SNAPSHOT&quot;</span> \</span></span><br><span class="line"><span class="language-bash">  description=<span class="string">&quot;Nvidia CUDA, cuDNN and PyTorch&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">USER</span> root</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt update; \</span></span><br><span class="line"><span class="language-bash">  apt-get install python3-pip -y; \</span></span><br><span class="line"><span class="language-bash">  pip3 install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">VOLUME</span><span class="language-bash"> [ <span class="string">&quot;/data&quot;</span> ]</span></span><br></pre></td></tr></table></figure>

<p>环境说明:</p>
<ul>
<li>CUDA &amp; CUDNN v12.0</li>
<li>Python v3.8.10</li>
<li>PyTorch v2.1.0 适配 cu118</li>
</ul>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><p>拉取镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull kaleofeng/cudatorch:1.0-SNAPSHOT</span><br></pre></td></tr></table></figure>

<p>运行容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run \</span><br><span class="line">  -it \</span><br><span class="line">  --name cudatorch \</span><br><span class="line">  --volume $PWD/data:/data \</span><br><span class="line">  --detach \</span><br><span class="line">  --gpus all \</span><br><span class="line">  kaleofeng/cudatorch:1.0-SNAPSHOT</span><br></pre></td></tr></table></figure>

<p>赋予当前用户 <code>data</code> 目录权限</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chown -R $USER data</span><br></pre></td></tr></table></figure>

<p>进入容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it cudatorch bash</span><br></pre></td></tr></table></figure>

<p>执行命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvidia-smi</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">root@766d2bc6e192:/# nvidia-smi</span><br><span class="line">Fri Jul 21 03:30:07 2023</span><br><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">| NVIDIA-SMI 525.105.17   Driver Version: 525.105.17   CUDA Version: 12.0     |</span><br><span class="line">|-------------------------------+----------------------+----------------------+</span><br><span class="line">| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |</span><br><span class="line">| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |</span><br><span class="line">|                               |                      |               MIG M. |</span><br><span class="line">|===============================+======================+======================|</span><br><span class="line">|   0  Tesla T4            On   | 00000000:00:08.0 Off |                    0 |</span><br><span class="line">| N/A   31C    P8    11W /  70W |      2MiB / 15360MiB |      0%      Default |</span><br><span class="line">|                               |                      |                  N/A |</span><br><span class="line">+-------------------------------+----------------------+----------------------+</span><br><span class="line"></span><br><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">| Processes:                                                                  |</span><br><span class="line">|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |</span><br><span class="line">|        ID   ID                                                   Usage      |</span><br><span class="line">|=============================================================================|</span><br><span class="line">|  No running processes found                                                 |</span><br><span class="line">+-----------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>

<p>执行命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvcc -V</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@766d2bc6e192:/# nvcc -V</span><br><span class="line">nvcc: NVIDIA (R) Cuda compiler driver</span><br><span class="line">Copyright (c) 2005-2023 NVIDIA Corporation</span><br><span class="line">Built on Fri_Jan__6_16:45:21_PST_2023</span><br><span class="line">Cuda compilation tools, release 12.0, V12.0.140</span><br><span class="line">Build cuda_12.0.r12.0/compiler.32267302_0</span><br></pre></td></tr></table></figure>

<p>测试是否 GPU 版本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -c &quot;import torch; print(torch.cuda.is_available())&quot;</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@766d2bc6e192:/# python3 -c &quot;import torch; print(torch.cuda.is_available())&quot;</span><br><span class="line">True</span><br></pre></td></tr></table></figure>

<p>查看环境信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m torch.utils.collect_env</span><br></pre></td></tr></table></figure>

<h2 id="应用部署"><a href="#应用部署" class="headerlink" title="应用部署"></a>应用部署</h2><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><p>安装 Git LFS</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install git-lfs -y</span><br><span class="line">git lfs install</span><br></pre></td></tr></table></figure>

<h3 id="工程应用"><a href="#工程应用" class="headerlink" title="工程应用"></a>工程应用</h3><h4 id="准备工程"><a href="#准备工程" class="headerlink" title="准备工程"></a>准备工程</h4><p>上传工程</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd data</span><br><span class="line">rz -bey</span><br><span class="line">unzip ChatGLM2-6B-modified.zip -d ChatGLM2-6B</span><br><span class="line">cd ChatGLM2-6B</span><br></pre></td></tr></table></figure>

<p>下载模型</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir models</span><br><span class="line">cd models</span><br><span class="line">git clone https://huggingface.co/THUDM/chatglm2-6b</span><br><span class="line">cd ..</span><br></pre></td></tr></table></figure>

<h4 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h4><p>进入容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it cudatorch bash</span><br></pre></td></tr></table></figure>

<p>进入工程</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /data/ChatGLM2-6B</span><br></pre></td></tr></table></figure>

<p>ChatGLM 基础依赖</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip3 install -r requirements.txt</span><br><span class="line">pip3 install --upgrade typing-extensions</span><br><span class="line">pip3 install starlette==0.27.0</span><br></pre></td></tr></table></figure>

<p>P-Tuning 所需</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pip3 install datasets</span><br><span class="line">pip3 install jieba</span><br><span class="line">pip3 install rouge_chinese</span><br><span class="line">pip3 install nltk</span><br></pre></td></tr></table></figure>

<p>全参数微调所需</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get install libaio-dev -y</span><br><span class="line">pip3 install deepspeed</span><br></pre></td></tr></table></figure>

<p>检查环境</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ds_report</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">oot@766d2bc6e192:/data/ChatGLM2-6B# ds_report</span><br><span class="line">[2023-07-21 03:57:31,728] [INFO] [real_accelerator.py:133:get_accelerator] Setting ds_accelerator to cuda (auto detect)</span><br><span class="line">--------------------------------------------------</span><br><span class="line">DeepSpeed C++/CUDA extension op report</span><br><span class="line">--------------------------------------------------</span><br><span class="line">NOTE: Ops not installed will be just-in-time (JIT) compiled at</span><br><span class="line">      runtime if needed. Op compatibility means that your system</span><br><span class="line">      meet the required dependencies to JIT install the op.</span><br><span class="line">--------------------------------------------------</span><br><span class="line">JIT compiled ops requires ninja</span><br><span class="line">ninja .................. [OKAY]</span><br><span class="line">--------------------------------------------------</span><br><span class="line">op name ................ installed .. compatible</span><br><span class="line">--------------------------------------------------</span><br><span class="line">async_io ............... [NO] ....... [OKAY]</span><br><span class="line">cpu_adagrad ............ [NO] ....... [OKAY]</span><br><span class="line">cpu_adam ............... [NO] ....... [OKAY]</span><br><span class="line">fused_adam ............. [NO] ....... [OKAY]</span><br><span class="line">fused_lamb ............. [NO] ....... [OKAY]</span><br><span class="line">quantizer .............. [NO] ....... [OKAY]</span><br><span class="line">random_ltd ............. [NO] ....... [OKAY]</span><br><span class="line"> [WARNING]  sparse_attn requires a torch version &gt;= 1.5 and &lt; 2.0 but detected 2.0</span><br><span class="line"> [WARNING]  using untested triton version (2.0.0), only 1.0.0 is known to be compatible</span><br><span class="line">sparse_attn ............ [NO] ....... [NO]</span><br><span class="line">spatial_inference ...... [NO] ....... [OKAY]</span><br><span class="line">transformer ............ [NO] ....... [OKAY]</span><br><span class="line">stochastic_transformer . [NO] ....... [OKAY]</span><br><span class="line">transformer_inference .. [NO] ....... [OKAY]</span><br><span class="line">--------------------------------------------------</span><br><span class="line">DeepSpeed general environment info:</span><br><span class="line">torch install path ............... [&#x27;/usr/local/lib/python3.8/dist-packages/torch&#x27;]</span><br><span class="line">torch version .................... 2.0.1+cu118</span><br><span class="line">deepspeed install path ........... [&#x27;/usr/local/lib/python3.8/dist-packages/deepspeed&#x27;]</span><br><span class="line">deepspeed info ................... 0.10.0, unknown, unknown</span><br><span class="line">torch cuda version ............... 11.8</span><br><span class="line">torch hip version ................ None</span><br><span class="line">nvcc version ..................... 12.0</span><br><span class="line">deepspeed wheel compiled w. ...... torch 2.0, cuda 11.8</span><br></pre></td></tr></table></figure>

<h3 id="进行训练"><a href="#进行训练" class="headerlink" title="进行训练"></a>进行训练</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd ptuning/</span><br><span class="line">chmod +x ds_train_finetune.sh</span><br><span class="line">./ds_train_finetune.sh</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qilu.me/2023/04/08/2023-04-08/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Kaleo Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樂只君子">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 樂只君子">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/04/08/2023-04-08/" class="post-title-link" itemprop="url">UE4构建时未定义的引用的链接问题</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-04-08 10:00:00" itemprop="dateCreated datePublished" datetime="2023-04-08T10:00:00+08:00">2023-04-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>UE4版本 <code>v4.26</code></p>
<p>操作系统 <code>CentOS 7</code></p>
<p>编译器 <code>clang version 10.0.1</code></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>项目流水线执行 <code>BuildEngine</code> 构建引擎，时不时出现 <code>undefined reference</code> 的链接错误，重试后可构建成功。</p>
<p>时常出现，重试成功，极大可能是链接时序问题。</p>
<h2 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h2><p>本地服务器搭建类似环境，尝试复现该问题。</p>
<p>查阅 UE4 构建工具的代码，在合适地方添加日志，分析日志结合代码，最终确定问题所在。</p>
<p><code>UE4Editor</code> 可执行文件 依赖于 <code>libUE4Editor-Engine.so</code>，<code>libUE4Editor-Engine.so</code> 依赖于 <code>libUE4Editor-Xyz.so</code>，<code>UE4Editor</code> 不直接依赖 <code>libUE4Editor-Xyz.so</code>。</p>
<p>链接错误出现在链接生成 <code>UE4Editor</code> 的时候，需要去链接 <code>libUE4Editor-Engine.so</code>，此时报错找不到 <code>libUE4Editor-Xyz.so</code> 中的符号， 即 <code>undefined reference</code>。</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>分析链接过程。</p>
<h3 id="链接生成-libUE4Editor-Engine-so"><a href="#链接生成-libUE4Editor-Engine-so" class="headerlink" title="链接生成 libUE4Editor-Engine.so"></a>链接生成 <code>libUE4Editor-Engine.so</code></h3><p><code>libUE4Editor-Engine.so</code> 包含引擎核心代码，其会引用大量依赖其他模块，也有一些其他模块依赖它，这样就出现了模块循环依赖。</p>
<p>UE4 构建时，考虑到了循环依赖情况，会采取类似下面措施处理。</p>
<p>像 <code>libUE4Editor-Engine.so</code> 这种出现循环依赖的库，会进行两次链接。</p>
<p>第一次链接仅链接生成库自身，链接脚本 <code>Link-libUE4Editor-Engine.so.link.sh</code>。</p>
<p>关键链接参数：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Wl,--start-group -lpthread -lrt -ldl -Wl,--allow-shlib-undefined -Wl,--end-group</span><br></pre></td></tr></table></figure>

<ul>
<li>没有指定依赖的库 这样生成的 so 中不包含依赖库信息。</li>
<li>指定允许未定义符号参数 <code>-Wl,--allow-shlib-undefined</code> 该参数会在链接时忽略未定义的符号，从而即使找不到依赖库的符号，也不会报错。</li>
</ul>
<p>第二次重链接会生成完整的库，链接脚本 <code>Relink-libUE4Editor-Engine.so.sh</code>。</p>
<p>关键链接参数：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Wl,--start-group -lpthread -lrt -ldl -lUE4Editor-Xyz -Wl,--end-group</span><br></pre></td></tr></table></figure>

<ul>
<li>指定了依赖的库 参数 <code>-lUE4Editor-Xyz</code> 表示其依赖于 <code>libUE4Editor-Xyz.so</code>。</li>
<li>没有指定允许未定义符号参数 默认情况下，链接可执行程序时有符号未定义，就会报错，但链接动态库时，会忽略未定义符号，不会报错。</li>
</ul>
<h3 id="链接生成-UE4Editor"><a href="#链接生成-UE4Editor" class="headerlink" title="链接生成 UE4Editor"></a>链接生成 <code>UE4Editor</code></h3><p>关键链接参数：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--unresolved-symbols=ignore-in-shared-libs --start-group -lUE4Editor-Xyz --unresolved-symbols=ignore-in-shared-libs --end-group</span><br></pre></td></tr></table></figure>

<ul>
<li>指定了未定义符号处理策略参数 <code>--unresolved-symbols=ignore-in-shared-libs</code> 会忽略来自动态库中的未定义符号，不会报错。</li>
</ul>
<p>观察上述信息，如果出现符号未定义的链接错误，需要满足两点。</p>
<ul>
<li>链接参数指定的未定义符号处理策略参数无效，这样链接的时候就还是会去找动态库中未定义的符号。</li>
<li>未定义的符号找不到，意味着其所在的依赖库信息找不到，也意味着链接生成可执行程序 <code>UE4Editor</code>时，去链接的动态库 <code>libUE4Editor-Engine.so</code>，是第一次链接生成的不包含依赖库信息的库，而不是重链接生成的那个完整的库。</li>
</ul>
<h2 id="定位"><a href="#定位" class="headerlink" title="定位"></a>定位</h2><p>UE4的每个编译或链接等操作，都被定义成一个 Action。</p>
<p>此例中，仅考虑链接情况，有4个Action。</p>
<ul>
<li><code>libUE4Editor-Xyz.so 链接Action</code></li>
<li><code>libUE4Editor-Engine.so 链接Action</code></li>
<li><code>libUE4Editor-Engine.so 重链接Action</code></li>
<li><code>UE4Editor 链接Action</code></li>
</ul>
<p>Action彼此之间有依赖关系，被依赖的Action先执行完成后，才会执行依赖Action。</p>
<p>到这里一切看似正常，但 UE4 实际实现时，存在一个问题，重链接Action不会被依赖。</p>
<p>此例中，<code>UE4Editor 链接Action</code> 应该依赖于 <code>libUE4Editor-Engine.so 重链接Action</code>，这样才能保证其链接的是一个完整库。但其实际依赖的仅是 <code>libUE4Editor-Engine.so 链接Action</code>。</p>
<p><code>libUE4Editor-Engine.so 重链接Action</code>  和 <code>UE4Editor 链接Action</code> 都依赖于 <code>libUE4Editor-Engine.so 链接Action</code>，但彼此间没有依赖关系。所以在实际构建时，时序不确定。</p>
<ul>
<li><p>如果Engine重链接Action执行完成后，Editor才开始链接，Editor链接的就是完整的Engine.so，此时正常。</p>
</li>
<li><p>如果Engine重链接Action执行中，Editor已经开始链接，Editor链接的就是Engine第一次链接后的那个不完整的Engine.so，这个so中不包含依赖库信息，所以Editor也就找不到 <code>libUE4Editor-Xyz.so</code>。</p>
</li>
</ul>
<p>问题就出在第二种情况下。找不到Xyz.so，当然其中的符号就是未定义了，此时报错 <code>undefined reference</code>。</p>
<p>但前面已经分析过，链接过程中指定了 <code>--unresolved-symbols=ignore-in-shared-libs</code>，会忽略未定义符号，不应该报错才对。</p>
<p>经过对比测试，在使用 <code>LLVM ld.lld</code> 链接器时才会出现该问题，使用 <code>GUN ld</code> 链接器没有问题。<code>LLVM ld.lld</code> 链接器中这个参数没有效果（至少是当前使用的这个版本 <code>LLD 10.0.1 (compatible with GNU linkers)</code>）。</p>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><h3 id="方案1"><a href="#方案1" class="headerlink" title="方案1"></a>方案1</h3><p>换一个 <code>LLVM ld.lld</code> 链接器支持的参数。</p>
<p>修改文件 <code>LinuxToolChain.cs</code> 中的代码，将忽略未定义符号链接参数 <code>--unresolved-symbols=ignore-in-shared-libs</code> 替换为 <code>--allow-shlib-undefined</code>。</p>
<h3 id="方案2"><a href="#方案2" class="headerlink" title="方案2"></a>方案2</h3><p>让 <code>UE4Editor 链接Action</code> 依赖于 <code>libUE4Editor-Engine.so 重链接Action</code>。</p>
<p>文件 <code>Actions.cs</code> 中的 <code>class Action</code> 中添加一个字段，保存其关联的Action，即用来在 链接Action 中保存其对应的 重链接Action。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> The actions that this action related(e.g. relink)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> List&lt;Action&gt; RelatedActions = <span class="keyword">new</span> List&lt;Action&gt;();</span><br></pre></td></tr></table></figure>

<p>文件 <code>LinuxToolChain.cs</code> 中 添加代码。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RelinkAction.bProducesImportLibrary = LinkAction.bProducesImportLibrary;</span><br></pre></td></tr></table></figure>

<p><code>bProducesImportLibrary</code> 这个字段后面会用来区分构建的是可执行程序还是动态库，因为只有可执行程序链接时，才会出现问<br>题。这里让 重链接Action 跟 第一次链接Action 保持一致。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LinkAction.RelatedActions.Add(RelinkAction);</span><br></pre></td></tr></table></figure>

<p>记录下 第一次链接Action 对应的 重链接Action。</p>
<p>文件 <code>ActionsGraph.cs</code> 的 <code>ActionGraph::Link</code> 中添加代码。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!Action.bProducesImportLibrary)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (Action RelatedAction <span class="keyword">in</span> PrerequisiteAction.RelatedActions)</span><br><span class="line">    &#123;</span><br><span class="line">        Action.PrerequisiteActions.Add(RelatedAction);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>把 重链接Action 添加到依赖于 第一次链接Action 的可执行文件链接Action的依赖列表，这样可执行文件一定会在 重链接Action 执行完成即完整so生成后，才会开始链接。</p>
<p>修改后观察，链接成功，问题已解决。</p>
<h2 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h2><p>假设 <code>c.exe</code> 依赖于 <code>libb.so</code>，<code>libb.so</code> 依赖于 <code>liba.so</code>。</p>
<h3 id="不指定依赖库"><a href="#不指定依赖库" class="headerlink" title="不指定依赖库"></a>不指定依赖库</h3><p>构建 <code>libb.so</code> 时不指定依赖库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -shared -fPIC -o libb.so b.c</span><br></pre></td></tr></table></figure>

<p><code>ldd libb.so</code> 结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">linux-vdso.so.1 (0x00007fff96b3a000)</span><br><span class="line"><span class="meta prompt_">/$</span><span class="language-bash">LIB/libonion.so =&gt; /lib64/libonion.so (0x00007f52dc3bc000)</span></span><br><span class="line">libc.so.6 =&gt; /lib64/libc.so.6 (0x00007f52dc1ec000)</span><br><span class="line">libdl.so.2 =&gt; /lib64/libdl.so.2 (0x00007f52dc1e5000)</span><br><span class="line">/lib64/ld-linux-x86-64.so.2 (0x00007f52dc3cb000)</span><br></pre></td></tr></table></figure>

<p>使用 <code>LLVM ld</code></p>
<hr>
<p>构建 <code>c.exe</code> 时不指定依赖库，不指定链接参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -fuse-ld=lld -o c.exe c.c -Wl,--start-group -Wl,--end-group</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ld.lld: error: undefined symbol: cal</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; referenced by c.c</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt;               /tmp/c-e8630d.o:(main)</span></span><br><span class="line">clang: error: linker command failed with exit code 1 (use -v to see invocation)</span><br></pre></td></tr></table></figure>

<p>构建 <code>c.exe</code> 时指定依赖库，不指定链接参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -fuse-ld=lld -o c.exe c.c -L. -Wl,--start-group -lb -Wl,--end-group</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ld.lld: error: ./libb.so: undefined reference to sum</span><br><span class="line">clang: error: linker command failed with exit code 1 (use -v to see invocation)</span><br></pre></td></tr></table></figure>

<p>构建 <code>c.exe</code> 时指定依赖库，指定链接参数 <code>--unresolved-symbols=ignore-in-shared-libs</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -fuse-ld=lld -o c.exe c.c -L. -Wl,--start-group -lb -Wl,--unresolved-symbols=ignore-in-shared-libs -Wl,--end-group</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ld.lld: error: ./libb.so: undefined reference to sum</span><br><span class="line">clang: error: linker command failed with exit code 1 (use -v to see invocation)</span><br></pre></td></tr></table></figure>

<p>构建 <code>c.exe</code> 时指定依赖库，指定链接参数 <code>--allow-shlib-undefined</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -fuse-ld=lld -o c.exe c.c -L. -Wl,--start-group -lb -Wl,--allow-shlib-undefined -Wl,--end-group</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">构建成功</span><br></pre></td></tr></table></figure>

<p>使用 <code>GNU ld</code></p>
<hr>
<p>构建 <code>c.exe</code> 时不指定依赖库，不指定链接参数，使用 <code>GNU ld</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -o c.exe c.c -Wl,--start-group -Wl,--end-group</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">x86_64-unknown-linux-gnu-ld: /tmp/c-d47523.o: in function `main&#x27;:</span><br><span class="line">c.c:(.text+0x1a): undefined reference to `cal&#x27;</span><br><span class="line">clang: error: linker command failed with exit code 1 (use -v to see invocation)</span><br></pre></td></tr></table></figure>

<p>构建 <code>c.exe</code> 时指定依赖库，不指定链接参数，使用 <code>GNU ld</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -o c.exe c.c -L. -Wl,--start-group -lb -Wl,--end-group</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x86_64-unknown-linux-gnu-ld: ./libb.so: undefined reference to `sum&#x27;</span><br><span class="line">clang: error: linker command failed with exit code 1 (use -v to see invocation)</span><br></pre></td></tr></table></figure>

<p>构建 <code>c.exe</code> 时指定依赖库，指定链接参数 <code>--unresolved-symbols=ignore-in-shared-libs</code>，使用 <code>GNU ld</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -o c.exe c.c -L. -Wl,--start-group -lb -Wl,--unresolved-symbols=ignore-in-shared-libs -Wl,--end-group</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">构建成功</span><br></pre></td></tr></table></figure>

<p>构建 <code>c.exe</code> 时指定依赖库，指定链接参数 <code>--allow-shlib-undefined</code>，使用 <code>GNU ld</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -o c.exe c.c -L. -Wl,--start-group -lb -Wl,--allow-shlib-undefined -Wl,--end-group</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">构建成功</span><br></pre></td></tr></table></figure>

<h3 id="指定依赖库"><a href="#指定依赖库" class="headerlink" title="指定依赖库"></a>指定依赖库</h3><p>构建 <code>libb.so</code> 时指定依赖库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -shared -fPIC -o libb.so b.c -L. -la</span><br></pre></td></tr></table></figure>

<p><code>ldd libb.so</code> 结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">linux-vdso.so.1 (0x00007ffee9716000)</span><br><span class="line"><span class="meta prompt_">/$</span><span class="language-bash">LIB/libonion.so =&gt; /lib64/libonion.so (0x00007f6f815bb000)</span></span><br><span class="line">liba.so =&gt; not found</span><br><span class="line">libc.so.6 =&gt; /lib64/libc.so.6 (0x00007f6f813eb000)</span><br><span class="line">libdl.so.2 =&gt; /lib64/libdl.so.2 (0x00007f6f813e4000)</span><br><span class="line">/lib64/ld-linux-x86-64.so.2 (0x00007f6f815ca000)</span><br></pre></td></tr></table></figure>

<p>使用 <code>LLVM ld</code></p>
<hr>
<p>构建 <code>c.exe</code> 时不指定依赖库，不指定链接参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -fuse-ld=lld -o c.exe c.c -Wl,--start-group -Wl,--end-group</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ld.lld: error: undefined symbol: cal</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; referenced by c.c</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt;               /tmp/c-cb2dc3.o:(main)</span></span><br><span class="line">clang: error: linker command failed with exit code 1 (use -v to see invocation)</span><br></pre></td></tr></table></figure>

<p>构建 <code>c.exe</code> 时指定依赖库，不指定链接参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -fuse-ld=lld -o c.exe c.c -L. -Wl,--start-group -lb -Wl,--end-group</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">构建成功</span><br></pre></td></tr></table></figure>

<p>构建 <code>c.exe</code> 时指定依赖库，指定链接参数 <code>--unresolved-symbols=ignore-in-shared-libs</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -fuse-ld=lld -o c.exe c.c -L. -Wl,--start-group -lb -Wl,--unresolved-symbols=ignore-in-shared-libs -Wl,--end-group</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">构建成功</span><br></pre></td></tr></table></figure>

<p>构建 <code>c.exe</code> 时指定依赖库，指定链接参数 <code>--allow-shlib-undefined</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -fuse-ld=lld -o c.exe c.c -L. -Wl,--start-group -lb -Wl,--allow-shlib-undefined -Wl,--end-group</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">构建成功</span><br></pre></td></tr></table></figure>

<p>使用 <code>GNU ld</code></p>
<hr>
<p>构建 <code>c.exe</code> 时不指定依赖库，不指定链接参数，使用 <code>GNU ld</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -o c.exe c.c -Wl,--start-group -Wl,--end-group</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">x86_64-unknown-linux-gnu-ld: /tmp/c-d74279.o: in function `main&#x27;:</span><br><span class="line">c.c:(.text+0x1a): undefined reference to `cal&#x27;</span><br><span class="line">clang: error: linker command failed with exit code 1 (use -v to see invocation)</span><br></pre></td></tr></table></figure>

<p>构建 <code>c.exe</code> 时指定依赖库，不指定链接参数，使用 <code>GNU ld</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -o c.exe c.c -L. -Wl,--start-group -lb -Wl,--end-group</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bin/x86_64-unknown-linux-gnu-ld: warning: liba.so, needed by ./libb.so, not found (try using -rpath or -rpath-link)</span><br><span class="line">x86_64-unknown-linux-gnu-ld: ./libb.so: undefined reference to `sum&#x27;</span><br><span class="line">clang: error: linker command failed with exit code 1 (use -v to see invocation)</span><br></pre></td></tr></table></figure>

<p>构建 <code>c.exe</code> 时指定依赖库，指定链接参数 <code>--unresolved-symbols=ignore-in-shared-libs</code>，使用 <code>GNU ld</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -o c.exe c.c -L. -Wl,--start-group -lb -Wl,--unresolved-symbols=ignore-in-shared-libs -Wl,--end-group</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">构建成功</span><br></pre></td></tr></table></figure>

<p>构建 <code>c.exe</code> 时指定依赖库，指定链接参数 <code>--allow-shlib-undefined</code>，使用 <code>GNU ld</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -o c.exe c.c -L. -Wl,--start-group -lb -Wl,--allow-shlib-undefined -Wl,--end-group</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">构建成功</span><br></pre></td></tr></table></figure>

<h2 id="参考信息"><a href="#参考信息" class="headerlink" title="参考信息"></a>参考信息</h2><h3 id="GNU-ld"><a href="#GNU-ld" class="headerlink" title="GNU ld"></a>GNU ld</h3><p><a target="_blank" rel="noopener" href="https://linux.die.net/man/1/ld">Manual</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">--unresolved-symbols=method</span><br><span class="line">Determine how to handle unresolved symbols. There are four possible values for method:</span><br><span class="line">ignore-all</span><br><span class="line">  Do not report any unresolved symbols.</span><br><span class="line">report-all</span><br><span class="line">  Report all unresolved symbols. This is the default.</span><br><span class="line">ignore-in-object-files</span><br><span class="line">  Report unresolved symbols that are contained in shared libraries, but ignore them if they come from regular object files.</span><br><span class="line">ignore-in-shared-libs</span><br><span class="line">  Report unresolved symbols that come from regular object files, but ignore them if they come from shared libraries. This can be useful when creating a dynamic binary and it is known that all the shared libraries that it should be referencing are included on the linker&#x27;s command line.</span><br><span class="line">The behaviour for shared libraries on their own can also be controlled by the --[no-]allow-shlib-undefined option.</span><br><span class="line">Normally the linker will generate an error message for each reported unresolved symbol but the option --warn-unresolved-symbols can change this to a warning.</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">--allow-shlib-undefined</span><br><span class="line">--no-allow-shlib-undefined</span><br><span class="line">Allows or disallows undefined symbols in shared libraries. This switch is similar to --no-undefined except that it determines the behaviour when the undefined symbols are in a shared library rather than a regular object file. It does not affect how undefined symbols in regular object files are handled.</span><br><span class="line">The default behaviour is to report errors for any undefined symbols referenced in shared libraries if the linker is being used to create an executable, but to allow them if the linker is being used to create a shared library.</span><br><span class="line"></span><br><span class="line">The reasons for allowing undefined symbol references in shared libraries specified at link time are that:</span><br><span class="line"></span><br><span class="line">â€¢ A shared library specified at link time may not be the same as the one that is available at load time, so the symbol might actually be resolvable at load time.</span><br><span class="line">â€¢ There are some operating systems, eg BeOS and HPPA , where undefined symbols in shared libraries are normal.</span><br><span class="line"></span><br><span class="line">The BeOS kernel for example patches shared libraries at load time to select whichever function is most appropriate for the current architecture. This is used, for example, to dynamically select an appropriate memset function.</span><br></pre></td></tr></table></figure>

<h3 id="LLVM-ld-lld"><a href="#LLVM-ld-lld" class="headerlink" title="LLVM ld.lld"></a>LLVM ld.lld</h3><p><a target="_blank" rel="noopener" href="https://nxmnpg.lemoda.net/1/ld.lld">Manual</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--allow-shlib-undefined</span><br><span class="line">Allow unresolved references in shared libraries. This option is enabled by default when linking a shared library.</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--unresolved-symbols -= value</span><br><span class="line">Determine how to handle unresolved symbols.</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qilu.me/2022/09/22/2022-09-22/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Kaleo Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樂只君子">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 樂只君子">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/09/22/2022-09-22/" class="post-title-link" itemprop="url">微博超话批量关注、签到、发帖、评论、捞贴一键脚本（油猴扩展版）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-09-22 20:00:00" itemprop="dateCreated datePublished" datetime="2022-09-22T20:00:00+08:00">2022-09-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>之前写过一个微博超话批量关注、签到、发帖、捞贴的<a target="_blank" rel="noopener" href="https://github.com/kaleofeng/misc/tree/master/soulsign/weibo">脚本</a>，还录了<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1x54y1i759">视频</a>，代码基于<a target="_blank" rel="noopener" href="https://github.com/inu1255/soulsign-chrome">魂签</a>浏览器扩展。因为扩展作者近来没有更新过代码，现有的构建程序在新版的浏览器下执行出错，所以我fork了<a target="_blank" rel="noopener" href="https://github.com/metaparty/soulsign-chrome">一份</a>做了修改并维护。</p>
<p>批量操作原理，就是先使用Fiddler或Charles等工具，抓取用户真实点击时HTTP请求的URI和上下行数据，脚本同样请求即可。浏览器扩展权限很大，从脚本里发起的操作基本等同于用户的直接操作。只要用户已经登录过微博，脚本操作可以直接使用其cookie，不存在登录状态问题</p>
<p>以 批量发帖 为例，发帖 HTTP请求代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> rsp = <span class="keyword">await</span> <span class="title function_">axios</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: url,</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">    <span class="attr">headers</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;X-Requested-With&#x27;</span>: <span class="string">&#x27;XMLHttpRequest&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Origin&#x27;</span>: <span class="string">&#x27;https://weibo.com&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Referer&#x27;</span>: <span class="string">`https://weibo.com/p/<span class="subst">$&#123;hid&#125;</span>/super_index`</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;id&#x27;</span>: hid,</span><br><span class="line">        <span class="string">&#x27;domain&#x27;</span>: <span class="string">&#x27;100808&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;module&#x27;</span>: <span class="string">&#x27;share_topic&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;title&#x27;</span>: <span class="string">&#x27;%E5%8F%91%E5%B8%96&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;content&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;api_url&#x27;</span>: <span class="string">&#x27;http://i.huati.weibo.com/pcpage/super/publisher&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;spr&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;extraurl&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;is_stock&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;check_url&#x27;</span>: <span class="string">`http%3A%2F%2Fi.huati.weibo.com%2Faj%2Fsuperpublishauth%26pageid%3D<span class="subst">$&#123;hid&#125;</span>%26uid%3D1764819037`</span>,</span><br><span class="line">        <span class="string">&#x27;location&#x27;</span>: <span class="string">&#x27;page_100808_super_index&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;text&#x27;</span>: text,</span><br><span class="line">        <span class="string">&#x27;appkey&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;style_type&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">&#x27;pic_id&#x27;</span>: picture,</span><br><span class="line">        <span class="string">&#x27;tid&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;pdetail&#x27;</span>: hid,</span><br><span class="line">        <span class="string">&#x27;mid&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;isReEdit&#x27;</span>: <span class="string">&#x27;false&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;sync_wb&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="string">&#x27;pub_source&#x27;</span>: <span class="string">&#x27;page_2&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;api&#x27;</span>: <span class="string">`http://i.huati.weibo.com/pcpage/operation/publisher/sendcontent?sign=super&amp;page_id=<span class="subst">$&#123;hid&#125;</span>`</span>,</span><br><span class="line">        <span class="string">&#x27;longtext&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">&#x27;topic_id&#x27;</span>: <span class="string">`1022:<span class="subst">$&#123;hid&#125;</span>`</span>,</span><br><span class="line">        <span class="string">&#x27;pub_type&#x27;</span>: <span class="string">&#x27;dialog&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;_t&#x27;</span>: <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">transformRequest</span>: [<span class="keyword">function</span>(<span class="params">data</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">objectToUrlEncodedParams</span>(data);</span><br><span class="line">    &#125;]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>数据直接配置在脚本里：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">let chaohuas = <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;hid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;100808db06c78d1e24cf708a14ce81c9b617ec&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;hname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;测试超话&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#测试[超话]# 这是要发布的内容\r\n单图&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;picture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0072KUQXly1ghh1d0daf7j30jg163t9r&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;hid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1008084b97c8f5ab54d661a331566ab64bf9d6&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;hname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;趣味测试超话&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#测试[超话]# 这是要发布的内容\r\n多图&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;picture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0072KUQXly1ghh1d0daf7j30jg163t9r|0072KUQXly1ghh1d0wgjuj30j60n9ab0&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span>;</span><br></pre></td></tr></table></figure>

<p>这里配置了两条带图微博，会分别发在两个超话，详细说明可参考开头的视频。</p>
<p>视频虽然浏览量不高，但还是有一些同学使用并提出了问题和建议，其中就有希望能在 <strong>油猴</strong> 扩展下使用。考虑到 <strong>魂签</strong> 扩展确实小众，且没有上架官方商店，只能以开发者模式使用，而油猴受众更广，资料更多，对新人更友好，于是决定做一版油猴脚本。</p>
<p>为了维护方便，最大可能保持两个扩展所用脚本代码的一致性，只对不兼容的地方做了调整。</p>
<p>一个不同是，魂签扩展界面上，可以直接点击执行脚本，也可以设置定时运行。油猴扩展的机制是进入匹配网站时，自动运行脚本。批量签到 等操作，还是希望用户主动点击执行，所以油猴版采用的方案是在网页之上添加一层操作界面，包括 关闭、批量关注 等按钮，供用户操作。</p>
<p>以 批量关注 脚本为例，界面相关代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 容纳按钮的容器，同时做互斥，可能多个脚本共用</span></span><br><span class="line"><span class="keyword">let</span> containerId = <span class="string">&#x27;kf-container&#x27;</span>;</span><br><span class="line"><span class="keyword">let</span> container = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(containerId);</span><br><span class="line"><span class="keyword">if</span> (!container) &#123;</span><br><span class="line">    <span class="comment">// 引入Bootstrap CSS</span></span><br><span class="line">    <span class="keyword">var</span> bootstrapCss = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;link&#x27;</span>);</span><br><span class="line">    bootstrapCss.<span class="property">rel</span> = <span class="string">&#x27;stylesheet&#x27;</span>;</span><br><span class="line">    bootstrapCss.<span class="property">href</span> = <span class="string">&#x27;https://cdn.jsdelivr.net/npm/bootstrap@5/dist/css/bootstrap.min.css&#x27;</span>;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">head</span>.<span class="title function_">appendChild</span>(bootstrapCss);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建容器</span></span><br><span class="line">    container = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">    container.<span class="property">id</span> = containerId;</span><br><span class="line">    container.<span class="property">className</span> = <span class="string">&#x27;btn-group-vertical btn-group-sm position-fixed&#x27;</span>;</span><br><span class="line">    container.<span class="property">style</span>.<span class="property">left</span> = <span class="string">&#x27;5px&#x27;</span>;</span><br><span class="line">    container.<span class="property">style</span>.<span class="property">top</span> = <span class="string">&#x27;5px&#x27;</span>;</span><br><span class="line">    container.<span class="property">style</span>[<span class="string">&#x27;z-index&#x27;</span>] = <span class="string">&quot;999999&quot;</span>;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(container);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭按钮</span></span><br><span class="line">    <span class="keyword">let</span> closeBtn = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;button&quot;</span>);</span><br><span class="line">    closeBtn.<span class="property">className</span> = <span class="string">&#x27;btn-close&#x27;</span>;</span><br><span class="line">    closeBtn.<span class="property">innerText</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    container.<span class="title function_">appendChild</span>(closeBtn);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 点击关闭容器</span></span><br><span class="line">    closeBtn.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">removeChild</span>(container);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 批量关注按钮</span></span><br><span class="line"><span class="keyword">let</span> followBtn = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;button&quot;</span>);</span><br><span class="line">followBtn.<span class="property">className</span> = <span class="string">&quot;kf-button btn btn-info&quot;</span>;</span><br><span class="line">followBtn.<span class="property">innerText</span> = <span class="string">&quot;批量关注&quot;</span>;</span><br><span class="line">container.<span class="title function_">appendChild</span>(followBtn);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 改变所有关联按钮可点击状态</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">changeRelatedButtonState</span>(<span class="params">disabled</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> buttons = <span class="variable language_">document</span>.<span class="title function_">getElementsByClassName</span>(<span class="string">&#x27;kf-button&#x27;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> button <span class="keyword">of</span> buttons) &#123;</span><br><span class="line">        button.<span class="property">disabled</span> = disabled;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 点击开始执行</span></span><br><span class="line">followBtn.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">changeRelatedButtonState</span>(<span class="literal">true</span>);</span><br><span class="line">    <span class="title function_">run</span>()</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span> <span class="title function_">alert</span>(<span class="string">`微博超话批量关注成功！（＾∀＾）\n<span class="subst">$&#123;result&#125;</span>`</span>))</span><br><span class="line">        .<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> <span class="title function_">alert</span>(<span class="string">`微博超话批量关注出错！（&gt;﹏&lt;）\n<span class="subst">$&#123;err&#125;</span>`</span>))</span><br><span class="line">        .<span class="title function_">finally</span>(<span class="function">() =&gt;</span> <span class="title function_">changeRelatedButtonState</span>(<span class="literal">false</span>));</span><br><span class="line">&#125;, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure>

<p>关注、签到、发帖和捞贴分成了4个扩展脚本，可能单个使用也可能同时使用，对应按钮都放在同一个容器，多个脚本也只会创建一个容器，同时也保证只执行一次公共逻辑。</p>
<p>注意一下 <code>CSS</code> 文件的引入方式，使用 <code>@resource</code> 没有效果，只能以这种添加页面元素的方式引入。</p>
<p>实际显示：</p>
<p> <img src="/2022-09-22/weibo_ui.png" alt="weibo_ui"></p>
<p>另外一个不同是，魂签可以直接跨域，而油猴需要授权使用 <code>GM_xmlhttpRequest</code> 来跨域。一般的 <code>GET</code>&#x2F;<code>PUT</code>请求都直接使用 <strong>axios</strong>，只有跨域的地方，才封装使用这个特定API，并确保跟 axios 的参数和返回值基本一致。封装代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">objectToUrlEncodedParams</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Object</span>.<span class="title function_">entries</span>(obj)</span><br><span class="line">        .<span class="title function_">map</span>(<span class="function">(<span class="params">[key, value]</span>) =&gt;</span> <span class="string">`<span class="subst">$&#123;<span class="built_in">encodeURIComponent</span>(key)&#125;</span>=<span class="subst">$&#123;<span class="built_in">encodeURIComponent</span>(value)&#125;</span>`</span>)</span><br><span class="line">        .<span class="title function_">join</span>(<span class="string">&#x27;&amp;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">xmlHttpRequest</span>(<span class="params">url, method, headers = &#123;&#125;, data = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">GM_xmlhttpRequest</span>(&#123;</span><br><span class="line">            <span class="attr">url</span>: url,</span><br><span class="line">            <span class="attr">method</span>: method,</span><br><span class="line">            <span class="attr">headers</span>: headers,</span><br><span class="line">            <span class="attr">data</span>: data,</span><br><span class="line">            <span class="attr">onload</span>: <span class="keyword">function</span>(<span class="params">rsp</span>) &#123;</span><br><span class="line">                <span class="title function_">resolve</span>(&#123;</span><br><span class="line">                    <span class="attr">status</span>: rsp.<span class="property">status</span>,</span><br><span class="line">                    <span class="attr">data</span>: rsp.<span class="property">response</span>,</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onerror</span>: <span class="keyword">function</span>(<span class="params">rsp</span>) &#123;</span><br><span class="line">                <span class="title function_">reject</span>(&#123;</span><br><span class="line">                    <span class="attr">status</span>: rsp.<span class="property">status</span>,</span><br><span class="line">                    <span class="attr">data</span>: rsp.<span class="property">response</span>,</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">xmlHttpGet</span>(<span class="params">req</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> url = req.<span class="property">url</span> || <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">let</span> method = <span class="string">&#x27;GET&#x27;</span>;</span><br><span class="line">    <span class="keyword">let</span> headers = req.<span class="property">headers</span> || &#123;&#125;;</span><br><span class="line">    <span class="keyword">let</span> params = req.<span class="property">params</span> || &#123;&#125;;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">xmlHttpRequest</span>(<span class="string">`<span class="subst">$&#123;url&#125;</span>?<span class="subst">$&#123;objectToUrlEncodedParams(params)&#125;</span>`</span>, method, headers);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码放在了<a target="_blank" rel="noopener" href="https://github.com/kaleofeng/misc/tree/master/tampermoney/weibo">GitHub</a>。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qilu.me/2022/09/16/2022-09-16/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Kaleo Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樂只君子">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 樂只君子">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/09/16/2022-09-16/" class="post-title-link" itemprop="url">Certbot申请和续签Let's Encrypt证书一键脚本</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-09-16 21:00:00" itemprop="dateCreated datePublished" datetime="2022-09-16T21:00:00+08:00">2022-09-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>申请Let’s Encrypt证书一般采用 <code>DNS</code> 认证的方式，通常命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certbot certonly -d metazion.com -d *.metazion.com -m applicant.gmail.com --manual --preferred-challenges dns</span><br></pre></td></tr></table></figure>

<p>这样交互的方式，过程中需要去域名解析服务商（如 DNSPOD）处添加 <code>TXT</code> 记录以供验证。每三个月需要续签一次证书，每次都要手动添加，还是很繁琐的。</p>
<p>各大域名解析服务商都有提供 <code>OpenAPI</code>，可以通过API来自动化完成上述操作。网上已经有一些相关代码，但本着自己定制的需求，实现了一份。</p>
<p>目录结构如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── certbot_apply.sh</span><br><span class="line">├── certbot_renew.sh</span><br><span class="line">├── configure.sh</span><br><span class="line">├── hall.py</span><br><span class="line">├── hook_deploy.sh</span><br><span class="line">├── hook_dns.sh</span><br><span class="line">├── provider</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   ├── txy.py</span><br><span class="line">│   └── util.py</span><br><span class="line">└── test</span><br><span class="line">    └── test_txy.py</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p>configure.sh</p>
<p>配置脚本。用户运行这个脚本，根据提示输入申请域名等信息，会生成 申请脚本 <code>certbot_apply.sh</code> 和 续签脚本 <code>certbot_renew.sh</code>，顾名思义，分别用来申请和续签证书。</p>
</li>
<li><p>hook_dns.sh</p>
<p>DNS操作回调脚本。申请或续签时，通过回调该脚本实现添加或删除DNS验证记录。用户一般无需修改该脚本。</p>
</li>
<li><p>hook_deploy.sh</p>
<p>证书部署回调脚本。续签证书成功后，可以通过该脚本部署新的证书，并重启Web服务器等。需要用户自行在该脚本实现相关功能。</p>
</li>
<li><p>hall.py</p>
<p>DNS功能实现脚本。<code>hook_dns.sh</code> 实际调用该脚本，该脚本根据用户输入调用 <code>provider</code> 下的实际域名解析服务商的驱动程序完成相关功能。</p>
</li>
<li><p>provider</p>
<p>域名解析服务商驱动程序目录。默认包含腾讯云（DNSPOD）的驱动程序 <code>txy.py</code>。用户如需自定义使用其他服务商，只需要提供与 <code>configure.sh</code> 时输入的域名解析服务商同名的 <code>Python</code> 驱动程序脚本，放在该目录下即可，驱动程序必要接口可以参考 <code>txy.py</code>。</p>
</li>
<li><p>test</p>
<p>测试脚本目录。简单测试驱动程序功能。</p>
</li>
</ul>
<p>下面展示下实际使用的输入输出：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@gemini certbot]# ./configure.sh</span><br><span class="line">Let&#x27;s Encrypt证书申请和续签一键脚本</span><br><span class="line">请输入申请证书的主域名（如 metazion.com）</span><br><span class="line">metazion.com</span><br><span class="line">请输入申请证书的完整域名，多个用空格分隔（如 metazion.com, *.metazion.com）</span><br><span class="line">metazion.com *.metazion.com</span><br><span class="line">请输入接收通知的电子邮箱（如 foo.gmail.com）</span><br><span class="line">kaleofeng@gmail.com</span><br><span class="line">请选择域名解析服务商</span><br><span class="line">1: 腾讯云（DNSPod）</span><br><span class="line">2: 自定义</span><br><span class="line">1</span><br><span class="line">请输入域名解析服务商提供的API Secret ID</span><br><span class="line">AKI******************************YbN</span><br><span class="line">请输入域名解析服务商提供的API Secret Key</span><br><span class="line">Zrt**************************oGU</span><br><span class="line">主域名：metazion.com</span><br><span class="line">完整域名列表：metazion.com *.metazion.com</span><br><span class="line">域名服务商：txy</span><br><span class="line">Secret ID：AKI******************************YbN</span><br><span class="line">Secret Key：Zrt**************************oGU</span><br><span class="line">已生成申请脚本（certbot_apply.sh）。</span><br><span class="line">已生成续签脚本（certbot_renew.sh）。</span><br><span class="line">如需续签证书后，部署证书并重启Web服务器等，请在 /root/script/misc/certbot/hook_deploy.sh 提供相关功能。</span><br><span class="line">[root@gemini certbot]#</span><br></pre></td></tr></table></figure>

<p>可以调用 <code>certbot_apply.sh</code> 申请证书。</p>
<p>可以调用 <code>certbot_renew.sh.sh</code> 续签证书。</p>
<p>配合 <code>crontab</code> 计划任务可以实现定期续签，这样就完全自动化无人操作了。</p>
<p>代码在<a target="_blank" rel="noopener" href="https://github.com/kaleofeng/misc/tree/master/certbot">Github</a>。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qilu.me/2021/12/12/2021-12-12/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Kaleo Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樂只君子">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 樂只君子">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/12/12/2021-12-12/" class="post-title-link" itemprop="url">macOS 和 Windows 一些互通操作记录</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-12-12 22:00:00" itemprop="dateCreated datePublished" datetime="2021-12-12T22:00:00+08:00">2021-12-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Trifle/" itemprop="url" rel="index"><span itemprop="name">Trifle</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>两台设备，分别是 <strong>M1</strong> 的 <strong>macOS Big Sur(11.6)</strong> 和 <strong>Windows 11</strong>，都是当前时间节点（2021年12月）最新的系统，有一些互通需求。</p>
<h3 id="macOS-远程登录-Windows"><a href="#macOS-远程登录-Windows" class="headerlink" title="macOS 远程登录 Windows"></a>macOS 远程登录 Windows</h3><p>微软提供了 Microsoft Remote Desktop，供 macOS 用户远程登录 Windows 系统，可在<a target="_blank" rel="noopener" href="https://mac.softpedia.com/get/Utilities/Microsoft-Remote-Desktop-Connection.shtml">此处</a>下载。</p>
<h3 id="macOS-读写-NTFS-移动硬盘"><a href="#macOS-读写-NTFS-移动硬盘" class="headerlink" title="macOS 读写 NTFS 移动硬盘"></a>macOS 读写 NTFS 移动硬盘</h3><p>可以使用免费软件 <a target="_blank" rel="noopener" href="https://mounty.app/">Mounty for NTFS</a>，根据系统版本下载。</p>
<p>使用过程中，如果遇到 <code>not re-mountable in read/write mode</code> 问题，采用如下解决方案。</p>
<ol>
<li><p>在 Windows 设备上插上移动硬盘</p>
</li>
<li><p>打开 Windows 终端（管理员），使用类似 <code>cd f:</code> 的命令到移动硬盘所在盘符下，输入 <code>chkdsk /f</code>，回车</p>
</li>
<li><p>输入 <code>y</code> 继续</p>
</li>
<li><p>右下角安全删除后再拔出移动硬盘</p>
</li>
</ol>
<h3 id="macOS-使用-ffmpeg-对视频编辑"><a href="#macOS-使用-ffmpeg-对视频编辑" class="headerlink" title="macOS 使用 ffmpeg 对视频编辑"></a>macOS 使用 <strong>ffmpeg</strong> 对视频编辑</h3><p>可以通过 <strong>Homebrew</strong> 安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install ffmpeg</span><br></pre></td></tr></table></figure>

<p><code>MKV</code> 转 <code>MP4</code> 格式：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i &#x27;test.mkv&#x27; -vcodec copy -acodec aac test.mp4</span><br></pre></td></tr></table></figure>

<p>提取 <code>AAC</code> 格式音频：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i &#x27;test.mp4&#x27; -vn -acodec aac test.aac</span><br></pre></td></tr></table></figure>

<p>顺时针旋转视频90度，保持视频比例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i &#x27;test.mp4&#x27; -vf rotate=PI/2 test2.mp4</span><br></pre></td></tr></table></figure>

<p>顺时针旋转视频90度，适配画面视频比例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i &#x27;test.mp4&#x27; -vf transpose=1 test2.mp4</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qilu.me/2020/07/31/2020-07-31/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Kaleo Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樂只君子">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 樂只君子">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/07/31/2020-07-31/" class="post-title-link" itemprop="url">我的实用工具库(2) - 按拍摄日期分类照片视频到日期目录</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-07-31 21:00:00" itemprop="dateCreated datePublished" datetime="2020-07-31T21:00:00+08:00">2020-07-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>拍过很多照片和视频，习惯以地点分类。多年过去，积累了成千上万，有时就很想从时间的角度看看过往。那些逝去的日子和此间的点滴，回不去，变不了，但看得到。</p>
<p>支持照片JPG和视频MP4等主流格式。</p>
<p>示例命令：<code>python classify-media.py .media &#39;jpgmp4mov&#39; 1</code></p>
<p><a target="_blank" rel="noopener" href="https://b23.tv/40HE0O">演示视频</a></p>
<p>直接上代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!usrbinenv python</span></span><br><span class="line"><span class="comment"># -- coding utf-8 --</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> calendar</span><br><span class="line"><span class="keyword">import</span> exifread</span><br><span class="line"><span class="keyword">import</span> glob</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pymediainfo <span class="keyword">import</span> MediaInfo</span><br><span class="line"></span><br><span class="line">specificDir= <span class="string">&#x27;.mzs&#x27;</span></span><br><span class="line">specificName = <span class="string">&#x27;meta&#x27;</span></span><br><span class="line"></span><br><span class="line">extensions = <span class="string">&#x27;&#x27;</span> <span class="comment"># Filter file extensions(for example &#x27;jpgmp4mov&#x27;), &#x27;&#x27; for all extensions</span></span><br><span class="line">mode = <span class="string">&#x27;0&#x27;</span>      <span class="comment"># Whether put all date dirs to root directory [0] No [1] yes</span></span><br><span class="line"></span><br><span class="line">processedCount = <span class="number">0</span></span><br><span class="line">unprocessedFiles = <span class="built_in">set</span>()</span><br><span class="line">exceptionalFiles = <span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">joinPath</span>(<span class="params">basePath, subPath</span>)</span><br><span class="line">  resultPath = os.path.join(basePath, subPath)</span><br><span class="line">  resultPath = resultPath.replace(<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, -<span class="number">1</span>)</span><br><span class="line">  <span class="keyword">return</span> resultPath</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">normalizePath</span>(<span class="params">path</span>)</span><br><span class="line">  <span class="keyword">return</span> path.replace(<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, -<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">removeDir</span>(<span class="params">dirPath</span>)</span><br><span class="line">  pathExists = os.path.exists(dirPath)</span><br><span class="line">  <span class="keyword">if</span> pathExists</span><br><span class="line">    shutil.rmtree(dirPath)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">makeDir</span>(<span class="params">dirPath</span>)</span><br><span class="line">  pathExists = os.path.exists(dirPath)</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> pathExists</span><br><span class="line">    os.mkdir(dirPath)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">utcTimeStringToLocalTimeString</span>(<span class="params">utcTimeString, utcFormat, localFormat</span>)</span><br><span class="line">  utcTimeStruct = time.strptime(utcTimeString, utcFormat)</span><br><span class="line">  timestamp = calendar.timegm(utcTimeStruct)</span><br><span class="line">  localTimeStruct = time.localtime(timestamp)</span><br><span class="line">  <span class="keyword">return</span> time.strftime(localFormat, localTimeStruct)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">normalizeExifReadDateTime</span>(<span class="params">dtString</span>)</span><br><span class="line">  <span class="keyword">return</span> re.sub(<span class="string">r&#x27;^(d&#123;4&#125;)(d&#123;2&#125;)(d&#123;2&#125;)(.)$&#x27;</span>, <span class="string">r&#x27;g1-g2-g3g4&#x27;</span>, dtString)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">normalizeMediaInfoDateTime</span>(<span class="params">dtString</span>)</span><br><span class="line">  dt = dtString[-<span class="number">19</span>]</span><br><span class="line">  <span class="keyword">if</span> <span class="string">&#x27;UTC&#x27;</span> <span class="keyword">in</span> dtString</span><br><span class="line">    dt = utcTimeStringToLocalTimeString(dt, <span class="string">r&#x27;%Y-%m-%d %H%M%S&#x27;</span>, <span class="string">r&#x27;%Y-%m-%d %H%M%S&#x27;</span>)</span><br><span class="line">  <span class="keyword">return</span> dt</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getImageInfo</span>(<span class="params">filePath</span>)</span><br><span class="line">  info = &#123;&#125;</span><br><span class="line">  <span class="keyword">with</span> <span class="built_in">open</span>(filePath, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f</span><br><span class="line">    tags = exifread.process_file(f, details=<span class="literal">False</span>)</span><br><span class="line">    imageDateTime = tags.get(<span class="string">&#x27;EXIF DateTimeOriginal&#x27;</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> imageDateTime == <span class="string">&#x27;0&#x27;</span></span><br><span class="line">      imageDateTime = tags.get(<span class="string">&#x27;EXIF DateTimeDigitized&#x27;</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> imageDateTime != <span class="string">&#x27;0&#x27;</span></span><br><span class="line">      imageDateTime = imageDateTime.values</span><br><span class="line">      imageDateTime = normalizeExifReadDateTime(imageDateTime)</span><br><span class="line">      info[<span class="string">&#x27;recordTime&#x27;</span>] = imageDateTime</span><br><span class="line"></span><br><span class="line">  <span class="built_in">print</span>(filePath, info[<span class="string">&#x27;recordTime&#x27;</span>])</span><br><span class="line">  <span class="keyword">return</span> info</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getVideoInfo</span>(<span class="params">filePath</span>)</span><br><span class="line">  info = &#123;&#125;</span><br><span class="line">  mediaInfo = MediaInfo.parse(filePath, full=<span class="literal">False</span>)</span><br><span class="line">  jstring = mediaInfo.to_json()</span><br><span class="line">  jdata = json.loads(jstring)</span><br><span class="line">  videoDateTime = jdata[<span class="string">&#x27;tracks&#x27;</span>][<span class="number">0</span>].get(<span class="string">&#x27;encoded_date&#x27;</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">  <span class="keyword">if</span> videoDateTime == <span class="string">&#x27;0&#x27;</span></span><br><span class="line">    videoDateTime = jdata[<span class="string">&#x27;tracks&#x27;</span>][<span class="number">0</span>].get(<span class="string">&#x27;tagged_date&#x27;</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">  <span class="keyword">if</span> videoDateTime != <span class="string">&#x27;0&#x27;</span></span><br><span class="line">    videoDateTime = normalizeMediaInfoDateTime(videoDateTime)</span><br><span class="line">    info[<span class="string">&#x27;recordTime&#x27;</span>] = videoDateTime</span><br><span class="line"></span><br><span class="line">  <span class="built_in">print</span>(filePath, info[<span class="string">&#x27;recordTime&#x27;</span>])</span><br><span class="line">  <span class="keyword">return</span> info</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">visitFile</span>(<span class="params">filePath</span>)</span><br><span class="line">  info = &#123;&#125;</span><br><span class="line">  <span class="keyword">try</span></span><br><span class="line">    <span class="keyword">if</span> re.search(<span class="string">&#x27;.(jpgpngheic)$&#x27;</span>, filePath, re.IGNORECASE) != <span class="literal">None</span></span><br><span class="line">      info = getImageInfo(filePath)</span><br><span class="line">    <span class="keyword">elif</span> re.search(<span class="string">&#x27;.(mp4movavimp3wavaacogg)$&#x27;</span>, filePath, re.IGNORECASE) != <span class="literal">None</span></span><br><span class="line">      info = getVideoInfo(filePath)</span><br><span class="line">  <span class="keyword">except</span></span><br><span class="line">    exceptionalFiles.add(filePath)</span><br><span class="line">  <span class="keyword">return</span> info</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">visitDir</span>(<span class="params">basePath, relativePath</span>)</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&#x27;-----&#x27;</span>, basePath, relativePath, <span class="string">&#x27;-----&#x27;</span>, flush=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">global</span> processedCount</span><br><span class="line"></span><br><span class="line">  dirPath = joinPath(basePath, relativePath)</span><br><span class="line"></span><br><span class="line">  baseMetaPath = joinPath(basePath, specificDir)</span><br><span class="line">  dirMetaPath = baseMetaPath</span><br><span class="line">  <span class="keyword">if</span> mode == <span class="string">&#x27;0&#x27;</span></span><br><span class="line">    dirMetaPath = joinPath(baseMetaPath, relativePath)</span><br><span class="line">  <span class="keyword">if</span> mode == <span class="string">&#x27;0&#x27;</span> <span class="keyword">or</span> relativePath == <span class="string">&#x27;&#x27;</span></span><br><span class="line">    removeDir(dirMetaPath)</span><br><span class="line">    makeDir(dirMetaPath)</span><br><span class="line"></span><br><span class="line">  sdPaths = []</span><br><span class="line">  sfPaths = []</span><br><span class="line">  fileTagMap = &#123;&#125;</span><br><span class="line">  unprocessedSet = <span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> entryName <span class="keyword">in</span> os.listdir(dirPath)</span><br><span class="line">    result = re.search(<span class="string">r&#x27;(&#123;&#125;)$&#x27;</span>.<span class="built_in">format</span>(extensions), entryName, re.IGNORECASE)</span><br><span class="line">    <span class="keyword">if</span> result == <span class="literal">None</span></span><br><span class="line">      <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    entryPath = joinPath(dirPath, entryName)</span><br><span class="line"></span><br><span class="line">    isDir = os.path.isdir(entryPath)</span><br><span class="line">    <span class="keyword">if</span> isDir</span><br><span class="line">      sdPaths.append((entryName, entryPath))</span><br><span class="line"></span><br><span class="line">    isFile = os.path.isfile(entryPath)</span><br><span class="line">    <span class="keyword">if</span> isFile</span><br><span class="line">      sfPaths.append((entryName, entryPath))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> sdPath <span class="keyword">in</span> sdPaths</span><br><span class="line">    sDirName = sdPath[<span class="number">0</span>]</span><br><span class="line">    sDirPath = sdPath[<span class="number">1</span>]</span><br><span class="line">    isSpecific = sDirPath.find(specificDir) = <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> isSpecific</span><br><span class="line">      <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    sRelativePath = joinPath(relativePath, sDirName)</span><br><span class="line">    visitDir(basePath, sRelativePath)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> sfPath <span class="keyword">in</span> sfPaths</span><br><span class="line">    sFileName = sfPath[<span class="number">0</span>]</span><br><span class="line">    sFilePath = sfPath[<span class="number">1</span>]</span><br><span class="line">    fileInfo = visitFile(sFilePath)</span><br><span class="line">    recordTime = fileInfo.get(<span class="string">&#x27;recordTime&#x27;</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> recordTime != <span class="string">&#x27;0&#x27;</span></span><br><span class="line">      fileTag = recordTime[<span class="number">10</span>]</span><br><span class="line">      filePathList = fileTagMap.setdefault(fileTag, [])</span><br><span class="line">      filePathList.append(sFilePath)</span><br><span class="line">      processedCount += <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      unprocessedSet.add(sFilePath)</span><br><span class="line">      unprocessedFiles.add(sFilePath)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> fileTag, filePathList <span class="keyword">in</span> fileTagMap.items()</span><br><span class="line">    <span class="built_in">print</span>(fileTag, <span class="built_in">len</span>(filePathList), flush=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    tagMetaPath = joinPath(dirMetaPath, fileTag)</span><br><span class="line">    <span class="built_in">print</span>(tagMetaPath, flush=<span class="literal">True</span>)</span><br><span class="line">    makeDir(tagMetaPath)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> filePath <span class="keyword">in</span> filePathList</span><br><span class="line">      fileRelatedPattern = re.sub(<span class="string">r&#x27;.(w+)$&#x27;</span>, <span class="string">&#x27;.&#x27;</span>, filePath)</span><br><span class="line">      <span class="keyword">for</span> fileRelated <span class="keyword">in</span> glob.glob(fileRelatedPattern)</span><br><span class="line">        fileRelated = normalizePath(fileRelated)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;copy &#123;&#125; to &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(fileRelated, tagMetaPath), flush=<span class="literal">True</span>)</span><br><span class="line">        shutil.copy(fileRelated, tagMetaPath)</span><br><span class="line">        unprocessedSet.discard(fileRelated)</span><br><span class="line">        unprocessedFiles.discard(fileRelated)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>, flush=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">len</span>(unprocessedSet)  <span class="number">0</span></span><br><span class="line">    unprocessedTag = <span class="string">&#x27;0&#x27;</span></span><br><span class="line">    tagMetaPath = joinPath(dirMetaPath, unprocessedTag)</span><br><span class="line">    <span class="built_in">print</span>(tagMetaPath, flush=<span class="literal">True</span>)</span><br><span class="line">    makeDir(tagMetaPath)</span><br><span class="line">    <span class="keyword">for</span> unprocessedFile <span class="keyword">in</span> unprocessedSet</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;copy &#123;&#125; to &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(unprocessedFile, tagMetaPath), flush=<span class="literal">True</span>)</span><br><span class="line">        shutil.copy(unprocessedFile, tagMetaPath)</span><br><span class="line"></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>, flush=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">visitInit</span>(<span class="params">dirPath</span>)</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&#x27;visit Init &#x27;</span>, dirPath, flush=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">  visitDir(dirPath, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&#x27;====================================================&#x27;</span>)</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&#x27;Done! processed[&#123;&#125;] unprocessed[&#123;&#125;] exceptional[&#123;&#125;]&#x27;</span>.<span class="built_in">format</span>(processedCount, <span class="built_in">len</span>(unprocessedFiles), <span class="built_in">len</span>(exceptionalFiles)))</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&#x27;Unprocessed Files &#x27;</span>, flush=<span class="literal">True</span>)</span><br><span class="line">  <span class="keyword">for</span> unprocessedFile <span class="keyword">in</span> unprocessedFiles</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(unprocessedFile))</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>, flush=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&#x27;Exceptional Files &#x27;</span>, flush=<span class="literal">True</span>)</span><br><span class="line">  <span class="keyword">for</span> exceptionalFile <span class="keyword">in</span> exceptionalFiles</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(exceptionalFile))</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>, flush=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span></span><br><span class="line">  dirPath = sys.argv[<span class="number">1</span>]</span><br><span class="line">  extensions = sys.argv[<span class="number">2</span>]</span><br><span class="line">  mode = sys.argv[<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">  visitInit(dirPath)</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qilu.me/2020/05/21/2020-05-21/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Kaleo Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樂只君子">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 樂只君子">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/05/21/2020-05-21/" class="post-title-link" itemprop="url">我的实用工具库(1) - 自动加载执行 crontab 定时任务的 docker 镜像</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-05-21 22:30:00" itemprop="dateCreated datePublished" datetime="2020-05-21T22:30:00+08:00">2020-05-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://github.com/kaleofeng/misc/blob/master/docker/pycron">pycron</a> 顾名思义，python + crontab，是一个包含 Python 3 运行时的 docker 镜像，用来执行 crontab 配置文件中的定时任务。</p>
<h2 id="缘起"><a href="#缘起" class="headerlink" title="缘起"></a>缘起</h2><p><a target="_blank" rel="noopener" href="https://metazion.net/">MetaTool</a> 有两个小工具，分别是 微博舆情统计信息 和 QQ音乐专辑单链销量，后端数据都是通过爬虫定时爬取的。爬虫脚本使用 Python 3 编写，通过 crontab 定时执行。</p>
<p>因为可能部署到多个云服务器，或者有时会更换云服务器，任务也会随时增删，就需要一种便捷的部署方式，最好随意复制一键启动，很自然就用到了 docker 镜像。</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>先看一下 docker 运行命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run \</span><br><span class="line">  --name pycron \</span><br><span class="line">  --restart=always \</span><br><span class="line">  --volume $PWD/script:/data/script \</span><br><span class="line">  --network net_cron \</span><br><span class="line">  --detach \</span><br><span class="line">  kaleofeng/pycron:1.0-SNAPSHOT</span><br></pre></td></tr></table></figure>

<p>镜像定义了一个数据卷，crontabs 配置文件和所有用户脚本等都放在该目录下。</p>
<p>下面是一个使用中状态的数据目录结构：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pycron/</span><br><span class="line">└── script</span><br><span class="line">    ├── conf</span><br><span class="line">    │   └── db.conf</span><br><span class="line">    ├── crontabs</span><br><span class="line">    └── qmusic</span><br><span class="line">        ├── data</span><br><span class="line">        │   ├── qmusic_singerstat_2020-05-20-23-59-00.xls</span><br><span class="line">        │   ├── qmusic_singerstat_2020-05-21-23-59-00.xls</span><br><span class="line">        │   └── qmusic_singerstat_2020-05-22-23-59-00.xls</span><br><span class="line">        ├── log</span><br><span class="line">        │   └── singerstat.log</span><br><span class="line">        └── singerstat.py</span><br></pre></td></tr></table></figure>

<p>看一下 crontabs 配置文件内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">59 23 * * * flock -xn /tmp/singerstat.lock -c &#x27;timeout 5m /usr/bin/python3 /data/script/qmusic/singerstat.py &gt;&gt; /data/script/qmusic/log/singerstat.log 2&gt;&amp;1&#x27;</span><br></pre></td></tr></table></figure>

<p>示例里只有一个定时任务：每日23点59分调用 <em>singerstat.py</em> 爬取相关数据。</p>
<p>需要注意的是，该配置文件只能使用 unix 换行符 <code>\n</code>，不要使用 <code>\r\n</code>。</p>
<p>配置好定时任务，保证相关脚本可以正确执行。启动镜像，镜像会自动读取数据目录下的配置文件，生成 crontab 任务，定时执行，就像普通 linux 系统中的 crontab 任务一样。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>看一下 docker 镜像的 Dockerfile：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">FROM centos:8</span><br><span class="line"></span><br><span class="line">LABEL maintainer=&quot;KaleoFeng&quot; \</span><br><span class="line">  version=&quot;1.0-SNAPSHOT&quot; \</span><br><span class="line">  description=&quot;Crontab with Python 3 on CentOS 8&quot;</span><br><span class="line"></span><br><span class="line">USER root</span><br><span class="line"></span><br><span class="line">RUN \cp -f /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br><span class="line"></span><br><span class="line">RUN dnf -y module install python36; \</span><br><span class="line">  pip3 install pymysql; \</span><br><span class="line">  pip3 install xlwt; \</span><br><span class="line">  pip3 install requests; \</span><br><span class="line">  dnf -y install cronie crontabs</span><br><span class="line"></span><br><span class="line">VOLUME [ &quot;/data/script&quot; ]</span><br><span class="line"></span><br><span class="line">COPY ./entrypoint.sh .</span><br><span class="line">ENTRYPOINT [ &quot;sh&quot;, &quot;./entrypoint.sh&quot; ]</span><br><span class="line"></span><br><span class="line">CMD [ &quot;/usr/sbin/crond&quot;, &quot;-n&quot; ]</span><br></pre></td></tr></table></figure>

<p>一目了然，该镜像基于 CentOS 8。因为爬虫脚本使用 Python 3，会将爬到的数据写入数据库，并生成 Excel 文件，所以添加了 Python 3 运行时，并安装了 MySQL 读写库 pymysql、Excel 读写库 xlwt 等依赖库。</p>
<p>定义了数据卷 <em>&#x2F;data&#x2F;script</em>，宿主机数据目录需要映射到该路径。</p>
<p>镜像入口脚本 <em>entrypoint.sh</em> ：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">set -eo pipefail</span><br><span class="line">shopt -s nullglob</span><br><span class="line"></span><br><span class="line">crontab /data/script/crontabs</span><br><span class="line"></span><br><span class="line">exec &quot;$@&quot;</span><br></pre></td></tr></table></figure>

<p>就是让 crontab 程序读取数据目录下的 crontabs 配置文件来加载定时任务。</p>
<p>镜像默认运行 crond 服务，使用 <code>-n</code> 选项让 crond 作为前台进程运行，这是重点。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qilu.me/2020/01/12/2020-01-12/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Kaleo Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樂只君子">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 樂只君子">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/01/12/2020-01-12/" class="post-title-link" itemprop="url">Spring源码分析 - Tomcat Servlet规范实现与Spring Web应用自动装配</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-01-12 21:00:00" itemprop="dateCreated datePublished" datetime="2020-01-12T21:00:00+08:00">2020-01-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Lore/" itemprop="url" rel="index"><span itemprop="name">Lore</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>本系列文章基于以下版本。</p>
<p><strong>Spring Framework</strong> 版本：<code>v5.2.8.RELEASE</code>。</p>
<p><strong>Apache Tomcat</strong> 版本：<code>v9.0.37</code></p>
<h2 id="引子"><a href="#引子" class="headerlink" title="引子"></a>引子</h2><p>以前做web应用开发，<code>web.xml</code>是必然要打交道的一个文件，通过它配置应用信息，各种servlets、filters和listeners等。</p>
<p>现在开发，已经见不到这个文件了。这意味着，有一种隐式的方式替代了显式的配置文件方式，来完成同样的工作。</p>
<p>这就是本文要讲的“Web应用自动装配”。</p>
<h2 id="正题"><a href="#正题" class="headerlink" title="正题"></a>正题</h2><p>Web应用自动装配，依赖于Servlet容器和Servlet开发框架的合作。前者实现Servlet规范，提供扩展服务，后者实现扩展服务，完成实际工作。</p>
<p>Servlet容器以Apache Tomcat来分析。</p>
<p>Servlet开发框架以Spring Framework来分析。</p>
<h3 id="Tomcat-Servlet规范实现"><a href="#Tomcat-Servlet规范实现" class="headerlink" title="Tomcat Servlet规范实现"></a>Tomcat Servlet规范实现</h3><p>新的Servlet规范为 <code>ServletContext</code> 新增了若干接口。</p>
<p>源码文件(<em>apache-tomcat-9.0.37-src\java\javax\servlet\ServletContext.java</em>)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ServletContext</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ServletRegistration.Dynamic <span class="title function_">addServlet</span><span class="params">(String servletName, String className)</span>;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">public</span> FilterRegistration.Dynamic <span class="title function_">addFilter</span><span class="params">(String filterName, String className)</span>;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addListener</span><span class="params">(String className)</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有了这些接口，就提供了通过代码配置servlets、filters和listeners等的能力，即web应用初始化。</p>
<p>什么时候怎么做呢？</p>
<p>Servlet规范提供了 <code>ServletContainerInitializer</code>。</p>
<p>源码文件(<em>apache-tomcat-9.0.37-src\java\javax\servlet\ServletContainerInitializer.java</em>)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ServletContainerInitializer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onStartup</span><span class="params">(Set&lt;Class&lt;?&gt;&gt; c, ServletContext ctx)</span> <span class="keyword">throws</span> ServletException;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Servlet容器会在启动的合适时机回调该接口实现类的 <code>onStartup</code> 方法，用户（此处为Servlet开发框架）实现该接口完成具体的初始化工作。</p>
<p>为了减少耦合，Tomcat采用了类似 <strong>Java SPI</strong> 的服务提供发现机制。</p>
<p>源码文件(<em>apache-tomcat-9.0.37-src\java\org\apache\catalina\startup\WebappServiceLoader.java</em>)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebappServiceLoader</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CLASSES</span> <span class="operator">=</span> <span class="string">&quot;/WEB-INF/classes/&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LIB</span> <span class="operator">=</span> <span class="string">&quot;/WEB-INF/lib/&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SERVICES</span> <span class="operator">=</span> <span class="string">&quot;META-INF/services/&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;T&gt; <span class="title function_">load</span><span class="params">(Class&lt;T&gt; serviceType)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">configFile</span> <span class="operator">=</span> SERVICES + serviceType.getName();</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>

<p><code>WebappServiceLoader</code> 查找并加载 <code>META-INF/services/</code> 下的服务实现。</p>
<p>源码文件(<em>apache-tomcat-9.0.37-src\java\org\apache\catalina\startup\ContextConfig.java</em>)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">processServletContainerInitializers</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">     List&lt;ServletContainerInitializer&gt; detectedScis;</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         WebappServiceLoader&lt;ServletContainerInitializer&gt; loader = <span class="keyword">new</span> <span class="title class_">WebappServiceLoader</span>&lt;&gt;(context);</span><br><span class="line">         detectedScis = loader.load(ServletContainerInitializer.class);</span><br><span class="line">     &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">     ...</span><br></pre></td></tr></table></figure>

<p>如此，就能找到 <code>ServletContainerInitializer</code> 接口的实现类，该实现类由Servlet开发框架提供，便将具体初始化工作转移到了用户方。</p>
<p>我们注意到 <code>onStartup</code> 有两个参数，第2个是 <code>ServletContext</code>，不用多说。第一个是做什么的？</p>
<p>根据前面描述，<code>ServletContainerInitializer</code> 是来做web 应用初始化工作的，它提供了一个Servlet容器到Servlet开发框架的桥梁。Servlet开发框架具体实现时，也会定义一些初始化接口，然后在 <code>onStartup</code> 时调用这些接口服务。</p>
<p>第一个参数就是Servlet容器通过类似ASM字节码解析方式，加载的Servlet开发框架的web应用初始化接口实现类集合。</p>
<p>这就是涉及到要筛选出相应的web应用初始化接口实现类，所以Servlet规范提供了 <code>@HandlesTypes</code> 注解。</p>
<h3 id="Spring-Framework扩展实现"><a href="#Spring-Framework扩展实现" class="headerlink" title="Spring Framework扩展实现"></a>Spring Framework扩展实现</h3><p>Spring的 <code>ServletContainerInitializer</code> 实现类如下。</p>
<p>源码文件(<em>spring-framework\spring-web\src\main\java\org\springframework\web\SpringServletContainerInitializer.java</em>)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HandlesTypes(WebApplicationInitializer.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringServletContainerInitializer</span> <span class="keyword">implements</span> <span class="title class_">ServletContainerInitializer</span> &#123;</span><br><span class="line">  	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStartup</span><span class="params">(<span class="meta">@Nullable</span> Set&lt;Class&lt;?&gt;&gt; webAppInitializerClasses, ServletContext servletContext)</span></span><br><span class="line">			<span class="keyword">throws</span> ServletException &#123;</span><br><span class="line"></span><br><span class="line">		List&lt;WebApplicationInitializer&gt; initializers = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (webAppInitializerClasses != <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">for</span> (Class&lt;?&gt; waiClass : webAppInitializerClasses) &#123;</span><br><span class="line">				<span class="comment">// Be defensive: Some servlet containers provide us with invalid classes,</span></span><br><span class="line">				<span class="comment">// no matter what @HandlesTypes says...</span></span><br><span class="line">				<span class="keyword">if</span> (!waiClass.isInterface() &amp;&amp; !Modifier.isAbstract(waiClass.getModifiers()) &amp;&amp;</span><br><span class="line">						WebApplicationInitializer.class.isAssignableFrom(waiClass)) &#123;</span><br><span class="line">					<span class="keyword">try</span> &#123;</span><br><span class="line">						initializers.add((WebApplicationInitializer)</span><br><span class="line">								ReflectionUtils.accessibleConstructor(waiClass).newInstance());</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">						<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(<span class="string">&quot;Failed to instantiate WebApplicationInitializer class&quot;</span>, ex);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (initializers.isEmpty()) &#123;</span><br><span class="line">			servletContext.log(<span class="string">&quot;No Spring WebApplicationInitializer types detected on classpath&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		servletContext.log(initializers.size() + <span class="string">&quot; Spring WebApplicationInitializers detected on classpath&quot;</span>);</span><br><span class="line">		AnnotationAwareOrderComparator.sort(initializers);</span><br><span class="line">		<span class="keyword">for</span> (WebApplicationInitializer initializer : initializers) &#123;</span><br><span class="line">			initializer.onStartup(servletContext);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Spring的web应用初始化接口为 <code>WebApplicationInitializer</code>，通过  <code>@HandlesTypes</code> 注解告知Servlet容器筛选加载其实现类，并作为第1个参数传入 <code>onStartup</code>，依次回调实现类的 <code>onStartup</code>，完成web应用初始化工作。</p>
<p>Spring中，<code>WebApplicationInitializer</code> 有若干实现。</p>
<p>源码文件(<em>spring-framework\spring-web\src\main\java\org\springframework\web\context\AbstractContextLoaderInitializer.java</em>)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractContextLoaderInitializer</span> <span class="keyword">implements</span> <span class="title class_">WebApplicationInitializer</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Logger available to subclasses. */</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">Log</span> <span class="variable">logger</span> <span class="operator">=</span> LogFactory.getLog(getClass());</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStartup</span><span class="params">(ServletContext servletContext)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">		registerContextLoaderListener(servletContext);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">registerContextLoaderListener</span><span class="params">(ServletContext servletContext)</span> &#123;</span><br><span class="line">		<span class="type">WebApplicationContext</span> <span class="variable">rootAppContext</span> <span class="operator">=</span> createRootApplicationContext();</span><br><span class="line">		<span class="keyword">if</span> (rootAppContext != <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="type">ContextLoaderListener</span> <span class="variable">listener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ContextLoaderListener</span>(rootAppContext);</span><br><span class="line">			listener.setContextInitializers(getRootApplicationContextInitializers());</span><br><span class="line">			servletContext.addListener(listener);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			logger.debug(<span class="string">&quot;No ContextLoaderListener registered, as &quot;</span> +</span><br><span class="line">					<span class="string">&quot;createRootApplicationContext() did not return an application context&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>该实现会向 <code>ServletContext</code> 添加 <code>ContextLoaderListener</code>。</p>
<p>源码文件(<em>spring-framework\spring-web\src\main\java\org\springframework\web\context\ContextLoaderListener.java</em>)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ContextLoaderListener</span> <span class="keyword">extends</span> <span class="title class_">ContextLoader</span> <span class="keyword">implements</span> <span class="title class_">ServletContextListener</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">ContextLoaderListener</span><span class="params">(WebApplicationContext context)</span> &#123;</span><br><span class="line">		<span class="built_in">super</span>(context);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">contextInitialized</span><span class="params">(ServletContextEvent event)</span> &#123;</span><br><span class="line">		initWebApplicationContext(event.getServletContext());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">contextDestroyed</span><span class="params">(ServletContextEvent event)</span> &#123;</span><br><span class="line">		closeWebApplicationContext(event.getServletContext());</span><br><span class="line">		ContextCleanupListener.cleanupAttributes(event.getServletContext());</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p><code>ContextLoaderListener</code> 的主要作用是使用传入的或创建新的Spring上下文，配置刷新该上下文，并保存到到 <code>ServletContext</code>。</p>
<p>其他的一些实现类型提供了包括向 <code>ServletContext</code> 添加servlets, filters，创建Spring MVC上下文等功能。</p>
<h3 id="Servlet容器启动时机"><a href="#Servlet容器启动时机" class="headerlink" title="Servlet容器启动时机"></a>Servlet容器启动时机</h3><p>源码文件(<em>apache-tomcat-9.0.37-src\java\org\apache\catalina\core\StandardContext.java</em>)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException &#123;</span><br><span class="line">    <span class="comment">// Notify our interested LifecycleListeners</span></span><br><span class="line">    fireLifecycleEvent(Lifecycle.CONFIGURE_START_EVENT, <span class="literal">null</span>);</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Call ServletContainerInitializers</span></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;ServletContainerInitializer, Set&lt;Class&lt;?&gt;&gt;&gt; entry :</span><br><span class="line">        initializers.entrySet()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            entry.getKey().onStartup(entry.getValue(),</span><br><span class="line">                    getServletContext());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ServletException e) &#123;</span><br><span class="line">            log.error(sm.getString(<span class="string">&quot;standardContext.sciFail&quot;</span>), e);</span><br><span class="line">            ok = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Configure and call application event listeners</span></span><br><span class="line">    <span class="keyword">if</span> (ok) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!listenerStart()) &#123;</span><br><span class="line">            log.error(sm.getString(<span class="string">&quot;standardContext.listenerFail&quot;</span>));</span><br><span class="line">            ok = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>CONFIGURE_START_EVENT</code> 会最终触发扫描加载 <code>ServletContainerInitializer</code> 的实现类（SpringServletContainerInitializer） 和 筛选加载 <code>@HandlesType</code> 注解指定的接口或注解（WebApplicationInitializer）实现类。</p>
<p><code>entry.getKey().onStartup</code> 即回调 <code>ServletContainerInitializer</code> 实现类（SpringServletContainerInitializer）的 <code>onStartup</code> 方法。</p>
<p><code>listenerStart</code> 会调用 <code>ServletContextListener</code> 实现类（<code>ContextLoaderListener</code>） 的 <code>contextInitialized</code>。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qilu.me/2019/12/08/2019-12-08/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Kaleo Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樂只君子">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 樂只君子">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/12/08/2019-12-08/" class="post-title-link" itemprop="url">HotSpot JVM源码分析 - 方法调用与解释执行（5）：由movl看汇编器如何生成机器码</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-12-08 20:00:00" itemprop="dateCreated datePublished" datetime="2019-12-08T20:00:00+08:00">2019-12-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Lore/" itemprop="url" rel="index"><span itemprop="name">Lore</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>本系列文章基于 <strong>OpenJDK 9</strong>，聚焦 <strong>x86</strong> 平台。</p>
<p>本文以 <code>movl</code> 为例，分析 HotSpot JVM 如何使用汇编器生成机器码。</p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>类似 <strong>invokevirtual</strong> 的字节码指令，在 <strong>解析</strong> 阶段将 <strong>符号引用</strong> 解析成 <strong>直接引用</strong> 后，解析结果会放在 <strong>常量池缓存</strong>（<strong>ConstantPoolCache</strong>），后续调用直接使用缓存条目，而不用再次解析。</p>
<p>常量池缓存结构如下（<em>openjdk\hotspot\src\share\vm\oops\cpCache.hpp</em>）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ConstantPoolCache</span>: <span class="keyword">public</span> MetaspaceObj &#123;</span><br><span class="line">  friend <span class="keyword">class</span> <span class="title class_">VMStructs</span>;</span><br><span class="line">  friend <span class="keyword">class</span> <span class="title class_">MetadataFactory</span>;</span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="type">int</span>             _length;</span><br><span class="line">  ConstantPool*   _constant_pool;          <span class="comment">// the corresponding constant pool</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这是常量池缓存字段，紧跟其后的是 <strong>常量池缓存条目</strong> （<strong>ConstantPoolCacheEntry</strong>）数组，<code>_length</code> 即数组的大小。</p>
<p>常量池缓存条目结构如下（<em>openjdk\hotspot\src\share\vm\oops\cpCache.hpp</em>）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ConstantPoolCacheEntry</span> VALUE_OBJ_CLASS_SPEC &#123;</span><br><span class="line">  friend <span class="keyword">class</span> <span class="title class_">VMStructs</span>;</span><br><span class="line">  friend <span class="keyword">class</span> <span class="title class_">constantPoolCacheKlass</span>;</span><br><span class="line">  friend <span class="keyword">class</span> <span class="title class_">ConstantPool</span>;</span><br><span class="line">  friend <span class="keyword">class</span> <span class="title class_">InterpreterRuntime</span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="keyword">volatile</span> intx     _indices;  <span class="comment">// constant pool index &amp; rewrite bytecodes</span></span><br><span class="line">  <span class="keyword">volatile</span> Metadata*   _f1;       <span class="comment">// entry specific metadata field</span></span><br><span class="line">  <span class="keyword">volatile</span> intx        _f2;       <span class="comment">// entry specific int/metadata field</span></span><br><span class="line">  <span class="keyword">volatile</span> intx     _flags;    <span class="comment">// flags</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其有 <em>4</em> 个字段，具体意义我们在后面文章中再解释，本文关注 <code>_indices</code> 字段，该字段中包含字节码指令等信息：</p>
<blockquote>
<p>&#x2F;&#x2F; _indices &#x3D; invoke code for f1 (b1 section), invoke code for f2 (b2 section), original constant pool index</p>
</blockquote>
<p>现在看一段源码（<em>openjdk\hotspot\src\cpu\x86\vm\interp_masm_x86.cpp</em>）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> InterpreterMacroAssembler::get_cache_and_index_and_bytecode_at_bcp(Register cache,</span><br><span class="line">                                                                        Register index,</span><br><span class="line">                                                                        Register bytecode,</span><br><span class="line">                                                                        <span class="type">int</span> byte_no,</span><br><span class="line">                                                                        <span class="type">int</span> bcp_offset,</span><br><span class="line">                                                                        size_t index_size) &#123;</span><br><span class="line">  get_cache_and_index_at_bcp(cache, index, bcp_offset, index_size);</span><br><span class="line">  <span class="comment">// We use a 32-bit load here since the layout of 64-bit words on</span></span><br><span class="line">  <span class="comment">// little-endian machines allow us that.</span></span><br><span class="line">  movl(bytecode, Address(cache, index, Address::times_ptr, ConstantPoolCache::base_offset() + ConstantPoolCacheEntry::indices_offset()));</span><br><span class="line">  const <span class="type">int</span> <span class="variable">shift_count</span> <span class="operator">=</span> (<span class="number">1</span> + byte_no) * BitsPerByte;</span><br><span class="line">  <span class="keyword">assert</span>((byte_no == TemplateTable::f1_byte &amp;&amp; shift_count == ConstantPoolCacheEntry::bytecode_1_shift) ||</span><br><span class="line">         (byte_no == TemplateTable::f2_byte &amp;&amp; shift_count == ConstantPoolCacheEntry::bytecode_2_shift),</span><br><span class="line">         <span class="string">&quot;correct shift count&quot;</span>);</span><br><span class="line">  shrl(bytecode, shift_count);</span><br><span class="line">  <span class="keyword">assert</span>(ConstantPoolCacheEntry::bytecode_1_mask == ConstantPoolCacheEntry::bytecode_2_mask, <span class="string">&quot;common mask&quot;</span>);</span><br><span class="line">  andl(bytecode, ConstantPoolCacheEntry::bytecode_1_mask);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码由解释器调用，用来生成 “获取 <strong>常量池缓存条目</strong>” 的机器码。</p>
<p>这里一定要区分好 <strong>解释器</strong> 和 <strong>运行时</strong> 两种环境，代码由 <strong>解释器</strong> 调用，作用是生成供 <strong>运行时</strong> 执行的机器码。</p>
<p>寄存器 <code>cache</code>, <code>index</code>, <code>bytecode</code> 分别用来存放 <strong>常量池缓存</strong> 首地址，<strong>常量池缓存条目</strong> 的数组索引和字节码指令。</p>
<p>首先调用 <code>get_cache_and_index_at_bcp</code> 方法获取 <code>cache</code> 和 <code>index</code>。</p>
<p>之后下面这行代码就用来获取 <strong>常量池缓存条目</strong> 的 <code>_indices</code> 字段数据，将其放在 <code>bytecode</code> 寄存器。再次强调，不是 <strong>解释器</strong> 执行时如此，而是生成的机器码在 <strong>运行时</strong> 如此。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">movl(bytecode, Address(cache, index, Address::times_ptr, ConstantPoolCache::base_offset() + ConstantPoolCacheEntry::indices_offset()))</span><br></pre></td></tr></table></figure>

<h2 id="正题"><a href="#正题" class="headerlink" title="正题"></a>正题</h2><p>看一下 <code>movl</code> 的源码（<em>openjdk\hotspot\src\cpu\x86\vm\assembler_x86.cpp</em>）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> Assembler::movl(Register dst, Address src) &#123;</span><br><span class="line">  InstructionMark <span class="title function_">im</span><span class="params">(<span class="built_in">this</span>)</span>;</span><br><span class="line">  prefix(src, dst);</span><br><span class="line">  emit_int8((unsigned <span class="type">char</span>)<span class="number">0x8B</span>);</span><br><span class="line">  emit_operand(dst, src);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第 <em>2</em> 行生成指令前缀，第 <em>3</em> 行生成单字节指令，第 <em>4</em> 行生成操作数；无视指令前缀，我们只关注指令和操作数。</p>
<p>这里展开，就牵扯到 <strong>Intel</strong> <strong>x86指令集</strong> 的内容了。</p>
<p>先看指令格式图：</p>
<p><img src="/2019-08-08/general_instruction_format.jpg" alt="general_instruction_format"></p>
<p>上面是指令格式，下面是两个操作数的位含义。</p>
<p>继续看 <code>movl</code> 源码。</p>
<p>参数类型 <code>Register</code> 是寄存器，<code>Address</code> 顾名思义是地址，结构如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Address</span> VALUE_OBJ_CLASS_SPEC &#123;</span><br><span class="line"> ...</span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  Register         _base;</span><br><span class="line">  Register         _index;</span><br><span class="line">  ScaleFactor      _scale;</span><br><span class="line">  <span class="type">int</span>              _disp;</span><br><span class="line">  RelocationHolder _rspec;</span><br></pre></td></tr></table></figure>

<p>封装了不同寻址模式所需的参数，对照一下上面指令集格式图，各个字段的意义就很清楚了，下面我们还是详细说一下。</p>
<p><code>movl</code> 第3行 <code>emit_int8((unsigned char)0x8B)</code> 写入的 <code>opcode</code> 是 <em>0x8B</em> ，对应 <code>mov</code> 指令，参考下图：</p>
<p><img src="/2019-08-08/mov.jpg" alt="mov"></p>
<p>32位模式下，其格式是这样的：</p>
<blockquote>
<p>8B &#x2F;r MOV r32,r&#x2F;m32 Move r&#x2F;m32 to r32</p>
</blockquote>
<p>该指令有两个操作数，第 <em>1</em> 个操作数是目的寄存器，第 <em>2</em> 个操作数是源寄存器或地址，指令作用是将源寄存器或地址的数据写到目的寄存器。</p>
<p><code>movl</code> 第 <em>4</em> 行 <code>emit_operand(dst, src)</code> 即生成两个操作数。</p>
<p>源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> Assembler::emit_operand(Register reg, Address adr,</span><br><span class="line">                             <span class="type">int</span> rip_relative_correction) &#123;</span><br><span class="line">  emit_operand(reg, adr._base, adr._index, adr._scale, adr._disp,</span><br><span class="line">               adr._rspec,</span><br><span class="line">               rip_relative_correction);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>又调用了另外一个 <code>emit_operand</code>, 并把 <code>Address</code> 封装的字段作用参数传递过去。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> Assembler::emit_operand(Register reg, Register base, Register index,</span><br><span class="line">                             Address::ScaleFactor scale, <span class="type">int</span> disp,</span><br><span class="line">                             RelocationHolder const&amp; rspec,</span><br><span class="line">                             <span class="type">int</span> rip_relative_correction) &#123;</span><br><span class="line">  relocInfo::<span class="type">relocType</span> <span class="variable">rtype</span> <span class="operator">=</span> (relocInfo::relocType) rspec.type();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Encode the registers as needed in the fields they are used in</span></span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> <span class="variable">regenc</span> <span class="operator">=</span> encode(reg) &lt;&lt; <span class="number">3</span>;</span><br><span class="line">  <span class="type">int</span> <span class="variable">indexenc</span> <span class="operator">=</span> index-&gt;is_valid() ? encode(index) &lt;&lt; <span class="number">3</span> : <span class="number">0</span>;</span><br><span class="line">  <span class="type">int</span> <span class="variable">baseenc</span> <span class="operator">=</span> base-&gt;is_valid() ? encode(base) : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (base-&gt;is_valid()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (index-&gt;is_valid()) &#123;</span><br><span class="line">      <span class="keyword">assert</span>(scale != Address::no_scale, <span class="string">&quot;inconsistent address&quot;</span>);</span><br><span class="line">      <span class="comment">// [base + index*scale + disp]</span></span><br><span class="line">      <span class="keyword">if</span> (disp == <span class="number">0</span> &amp;&amp; rtype == relocInfo::none  &amp;&amp;</span><br><span class="line">          base != rbp <span class="title function_">LP64_ONLY</span><span class="params">(&amp;&amp; base != r13)</span>) &#123;</span><br><span class="line">        <span class="comment">// [base + index*scale]</span></span><br><span class="line">        <span class="comment">// [00 reg 100][ss index base]</span></span><br><span class="line">        <span class="keyword">assert</span>(index != rsp, <span class="string">&quot;illegal addressing mode&quot;</span>);</span><br><span class="line">        emit_int8(<span class="number">0x04</span> | regenc);</span><br><span class="line">        emit_int8(scale &lt;&lt; <span class="number">6</span> | indexenc | baseenc);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (emit_compressed_disp_byte(disp) &amp;&amp; rtype == relocInfo::none) &#123;</span><br><span class="line">        <span class="comment">// [base + index*scale + imm8]</span></span><br><span class="line">        <span class="comment">// [01 reg 100][ss index base] imm8</span></span><br><span class="line">        <span class="keyword">assert</span>(index != rsp, <span class="string">&quot;illegal addressing mode&quot;</span>);</span><br><span class="line">        emit_int8(<span class="number">0x44</span> | regenc);</span><br><span class="line">        emit_int8(scale &lt;&lt; <span class="number">6</span> | indexenc | baseenc);</span><br><span class="line">        emit_int8(disp &amp; <span class="number">0xFF</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// [base + index*scale + disp32]</span></span><br><span class="line">        <span class="comment">// [10 reg 100][ss index base] disp32</span></span><br><span class="line">        <span class="keyword">assert</span>(index != rsp, <span class="string">&quot;illegal addressing mode&quot;</span>);</span><br><span class="line">        emit_int8(<span class="number">0x84</span> | regenc);</span><br><span class="line">        emit_int8(scale &lt;&lt; <span class="number">6</span> | indexenc | baseenc);</span><br><span class="line">        emit_data(disp, rspec, disp32_operand);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (base == rsp <span class="title function_">LP64_ONLY</span><span class="params">(|| base == r12)</span>) &#123;</span><br><span class="line"></span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<p>代码很长，这里只截取了我们这次涉及到的部分。</p>
<p>结合前面源码，因为 <em>4</em> 个重要参数 <code>cache</code>， <code>index</code>， <code>scale</code>， <code>disp</code> 都有值，<code>disp</code> 是 <strong>常量池缓存</strong> 的size + <strong>常量池缓存条目</strong> 字段 <code>_indices</code> 的偏移， 逻辑会走到 <code>else if</code> 块。</p>
<p>单摘出来：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// [base + index*scale + imm8]</span></span><br><span class="line"><span class="comment">// [01 reg 100][ss index base] imm8</span></span><br><span class="line"><span class="keyword">assert</span>(index != rsp, <span class="string">&quot;illegal addressing mode&quot;</span>);</span><br><span class="line">emit_int8(<span class="number">0x44</span> | regenc);</span><br><span class="line">emit_int8(scale &lt;&lt; <span class="number">6</span> | indexenc | baseenc);</span><br><span class="line">emit_int8(disp &amp; <span class="number">0xFF</span>);</span><br></pre></td></tr></table></figure>

<p>注释已经把操作数位意义和寻址方式都描述出来了，下面解释一下为什么是这样的。</p>
<p>先看第 <em>1</em> 个操作数，为 <code>0x44 | regenc</code>。</p>
<blockquote>
<p>回头看一下x86指令集指令格式图，可知，第一个操作数为 <strong>ModR&#x2F;M</strong> 字节，其形式如下：</p>
<p><img src="/2019-08-08/modrm_32.jpg" alt="modrm_32"></p>
<p><em>0x44</em> 二进制形式为 <em>01 000 100</em>，高 <em>2</em> 位 <em>01</em> 是 <strong>Mod</strong>，中 <em>3</em> 位 <em>000</em> 是 <strong>Reg&#x2F;Opcode</strong>，低 <em>3</em> 位 <em>100</em> 是 <strong>R&#x2F;M</strong>。</p>
<p>图最上面那一栏，中3位 <em>000</em> 或 上 <code>regenc</code> 就等于 <code>regenc</code>，也就是根据 <code>regenc</code> 的值选择对应 <strong>目的寄存器</strong>。</p>
<p>高 <em>2</em> 位 <strong>Mod</strong> 是 <em>01</em>，查上表可知，所在栏均为 <strong>disp8</strong> ，低 <em>3</em> 位 <strong>R&#x2F;M</strong> 是 <em>100</em>，查上表可知，对应 <strong>disp8[–][–]<strong>。看NOTES，</strong>[–][–]</strong> 表示后续跟着一个 <strong>SIB</strong>，即第 <em>2</em> 个操作数是 <strong>SIB</strong>；<strong>disp8</strong> 表示有第 <em>3</em> 个1个字节的操作数，表示偏移。</p>
<p>整体寻址模式为 <code>BASE + INDEX * SCALE + DISP</code>。</p>
</blockquote>
<p>再看第 <em>2</em> 个操作数，为 <code>scale &lt;&lt; 6 | indexenc | baseenc</code>。</p>
<blockquote>
<p>由第 <em>1</em> 个操作数得知，第 <em>2</em> 个操作数是 <strong>SIB</strong> 字节，其形式如下：</p>
<p><img src="/2019-08-08/sib_32.jpg" alt="sib_32"></p>
<p>图最上面那一栏，根据 <code>baseenc</code> 的值选择 <strong>base寄存器</strong>。</p>
<p>前面传入的 <code>scale</code> 参数为 <code>Address::times_ptr</code>，值为 <em>3</em>，二进制为 <em>11</em> ，对应上表 <strong>SS</strong>，即最后一栏。<code>index</code> 意为选择哪个 <strong>index寄存器</strong> 及操作，结果就是 <code>index * 8</code>。</p>
</blockquote>
<p>再看第 <em>3</em> 个参数，为 <code>disp &amp; 0xFF</code>。</p>
<blockquote>
<p>由第 <em>1</em> 个操作数得知，第 <em>3</em> 个操作数是 <strong>disp</strong>。</p>
</blockquote>
<p>综上，<code>emit</code> <em>3</em> 个操作数后，机器码最终为 <code>0x8B [01 reg 100] [11 index base] [disp]</code>，表示为 <code>mov reg [base + index * 8 + disp]</code>，意义是从地址 <code>[base + index * 8 + disp]</code> 取出数值，放到 <code>reg</code> 寄存器，即将 <strong>常量池缓存</strong> 中的 <strong>常量池缓存条目</strong> 数组中索引<code>index</code> 处的缓存条目 <code>_indices</code> 字段的值拷贝到 <code>bytecode</code> 寄存器。</p>
<h2 id="话外"><a href="#话外" class="headerlink" title="话外"></a>话外</h2><p>回到我们最初的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">movl(bytecode, Address(cache, index, Address::times_ptr, ConstantPoolCache::base_offset() + ConstantPoolCacheEntry::indices_offset()))</span><br></pre></td></tr></table></figure>

<p><code>Address</code> 的构造参数 <code>cache</code> 是常量池缓存首地址，对应 <code>base</code>；<code>index</code> 是常量池缓存条目数组索引，对应 <code>index</code>； <code>ConstantPoolCache::base_offset() + ConstantPoolCacheEntry::indices_offset()</code> 是 <strong>常量池缓存</strong> 头部大小 + <strong>常量池缓存条目</strong> 字段 <code>_indices</code> 的偏移，对应 <code>disp</code>。</p>
<p>按照我们上面的公式，任意 <code>index</code> 缓存条目字段 <code>indices</code> 的地址为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">base + index * <span class="number">8</span> + ConstantPoolCache::base_offset() + ConstantPoolCacheEntry::indices_offset()</span><br></pre></td></tr></table></figure>

<p>再看下前面 <strong>ConstantPoolCacheEntry</strong> 的结构定义，肯定会觉得不对呀，一个缓存条目有 <em>4</em> 个字段，大小为 <em>32</em>，怎么这里才 <code>* 8</code>？ 应该 <code>* 32</code> 才对。</p>
<p>其实，此 <code>index</code> 已非彼 <code>index</code>，原因就在 <code>get_cache_and_index_at_bcp</code> 方法里：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> InterpreterMacroAssembler::get_cache_and_index_at_bcp(Register cache,</span><br><span class="line">                                                           Register index,</span><br><span class="line">                                                           <span class="type">int</span> bcp_offset,</span><br><span class="line">                                                           size_t index_size) &#123;</span><br><span class="line">  assert_different_registers(cache, index);</span><br><span class="line">  get_cache_index_at_bcp(index, bcp_offset, index_size);</span><br><span class="line">  movptr(cache, Address(rbp, frame::interpreter_frame_cache_offset * wordSize));</span><br><span class="line">  <span class="keyword">assert</span>(sizeof(ConstantPoolCacheEntry) == <span class="number">4</span> * wordSize, <span class="string">&quot;adjust code below&quot;</span>);</span><br><span class="line">  <span class="comment">// convert from field index to ConstantPoolCacheEntry index</span></span><br><span class="line">  <span class="keyword">assert</span>(exact_log2(in_words(ConstantPoolCacheEntry::size())) == <span class="number">2</span>, <span class="string">&quot;else change next line&quot;</span>);</span><br><span class="line">  shll(index, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，调用 <code>get_cache_index_at_bcp</code> 获取到 <code>index</code>，此时确实是缓存条目数组索引，但后面因为缓存条目大小为 <code>4 * wordSize</code>，<code>wordSize</code> 等同一个指针size，等同我们公式里的 <em>8</em>，所以执行了 <code>shll(index, 2)</code>，左移 <em>2</em> 位即 <code>* 4</code>，此后 <code>index</code> 已经等于 <code>缓存条目数组索引 * 4</code> 了。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qilu.me/2019/10/15/2019-10-15/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Kaleo Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樂只君子">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 樂只君子">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/10/15/2019-10-15/" class="post-title-link" itemprop="url">HotSpot JVM源码分析 - 方法调用与解释执行（4）：由invoke指令看字节码指令如何解释执行</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-10-15 22:45:00" itemprop="dateCreated datePublished" datetime="2019-10-15T22:45:00+08:00">2019-10-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Lore/" itemprop="url" rel="index"><span itemprop="name">Lore</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>本系列文章基于 <strong>OpenJDK 9</strong>，聚焦 <strong>x86</strong> 平台。</p>
<p>本文以 <code>invokeinterface</code> 指令为例，分析 HotSpot JVM 如何解释执行 <strong>字节码指令</strong> 。</p>
<h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><p>前面文章展示了从操作数解析出 <strong>符号引用</strong> 再解析出 <strong>直接引用</strong> 的过程，解析出的信息存储在 <strong>常量池缓存</strong> 中。那么这些信息是怎么使用的呢？</p>
<p>直接上代码，因为代码较长，我们分段解释。</p>
<p>源码文件（<em>openjdk\hotspot\src\share\vm\interpreter\bytecodeInterpreter.cpp</em>）。</p>
<h3 id="获取常量池缓存条目"><a href="#获取常量池缓存条目" class="headerlink" title="获取常量池缓存条目"></a>获取常量池缓存条目</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">CASE(_invokeinterface): &#123;</span><br><span class="line">    <span class="type">u2</span> <span class="variable">index</span> <span class="operator">=</span> Bytes::get_native_u2(pc+<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// QQQ Need to make this as inlined as possible. Probably need to split all the bytecode cases</span></span><br><span class="line">    <span class="comment">// out so c++ compiler has a chance for constant prop to fold everything possible away.</span></span><br><span class="line"></span><br><span class="line">    ConstantPoolCacheEntry* cache = cp-&gt;entry_at(index);</span><br><span class="line">    <span class="keyword">if</span> (!cache-&gt;is_resolved((Bytecodes::Code)opcode)) &#123;</span><br><span class="line">        CALL_VM(InterpreterRuntime::resolve_from_cache(THREAD, (Bytecodes::Code)opcode),</span><br><span class="line">                handle_exception);</span><br><span class="line">        cache = cp-&gt;entry_at(index);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    istate-&gt;set_msg(call_method);</span><br></pre></td></tr></table></figure>

<p> <strong>字节码指令</strong> 后面，紧跟两个字节的操作数。如果已经解析过，操作数即为 <strong>常量池缓存条目</strong> 索引。</p>
<p>代码中，首先取出操作数，然后尝试籍此获得 <strong>常量池缓存条目</strong>。</p>
<p>根据条目信息，可以知道是否已经解析过。如果没有解析过，就进行前面文章展示的解析流程。</p>
<p>解析完成，再获取 <strong>常量池缓存条目</strong>，此时一定存在该条目。</p>
<h3 id="若强制virtual调用"><a href="#若强制virtual调用" class="headerlink" title="若强制virtual调用"></a>若强制virtual调用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">// Special case of invokeinterface called for virtual method of</span></span><br><span class="line">    <span class="comment">// java.lang.Object.  See cpCacheOop.cpp for details.</span></span><br><span class="line">    <span class="comment">// This code isn&#x27;t produced by javac, but could be produced by</span></span><br><span class="line">    <span class="comment">// another compliant java compiler.</span></span><br><span class="line">    <span class="keyword">if</span> (cache-&gt;is_forced_virtual()) &#123;</span><br><span class="line">        Method* callee;</span><br><span class="line">        CHECK_NULL(STACK_OBJECT(-(cache-&gt;parameter_size())));</span><br><span class="line">        <span class="keyword">if</span> (cache-&gt;is_vfinal()) &#123;</span><br><span class="line">            callee = cache-&gt;f2_as_vfinal_method();</span><br><span class="line">            <span class="comment">// Profile &#x27;special case of invokeinterface&#x27; final call.</span></span><br><span class="line">            BI_PROFILE_UPDATE_FINALCALL();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Get receiver.</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">parms</span> <span class="operator">=</span> cache-&gt;parameter_size();</span><br><span class="line">            <span class="comment">// Same comments as invokevirtual apply here.</span></span><br><span class="line">            <span class="type">oop</span> <span class="variable">rcvr</span> <span class="operator">=</span> STACK_OBJECT(-parms);</span><br><span class="line">            VERIFY_OOP(rcvr);</span><br><span class="line">            Klass* rcvrKlass = rcvr-&gt;klass();</span><br><span class="line">            callee = (Method*) rcvrKlass-&gt;method_at_vtable(cache-&gt;f2_as_index());</span><br><span class="line">            <span class="comment">// Profile &#x27;special case of invokeinterface&#x27; virtual call.</span></span><br><span class="line">            BI_PROFILE_UPDATE_VIRTUALCALL(rcvrKlass);</span><br><span class="line">        &#125;</span><br><span class="line">        istate-&gt;set_callee(callee);</span><br><span class="line">        istate-&gt;set_callee_entry_point(callee-&gt;from_interpreted_entry());</span><br><span class="line">#ifdef VM_JVMTI</span><br><span class="line">        <span class="title function_">if</span> <span class="params">(JvmtiExport::can_post_interpreter_events()</span> &amp;&amp; THREAD-&gt;is_interp_only_mode()) &#123;</span><br><span class="line">            istate-&gt;set_callee_entry_point(callee-&gt;interpreter_entry());</span><br><span class="line">        &#125;</span><br><span class="line">#endif <span class="comment">/* VM_JVMTI */</span></span><br><span class="line">        istate-&gt;set_bcp_advance(<span class="number">5</span>);</span><br><span class="line">        UPDATE_PC_AND_RETURN(<span class="number">0</span>); <span class="comment">// I&#x27;ll be back...</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>有些情况下，虽然 <strong>字节码指令</strong> 是 <code>invokeinterface</code>，但会强制走 <code>invokevirtual</code>。</p>
<p>如果指令执行的方法是 <code>final</code> 的, 那么 <strong>常量池缓存条目</strong> 的 <code>_f2</code> 字段存储的就是方法的 <strong>直接引用</strong>。</p>
<p>否则，先从栈里获取到调用方法的对象实例 <code>rcvr</code>，再籍此获取到位于 <strong>元空间</strong> 的 <strong>类元数据</strong> <code>rcvrKlass</code>。此时，<strong>常量池缓存条目</strong> 的 <code>_f2</code> 字段存储的是 <strong>虚表索引</strong>，有了索引，就可以从 <strong>类元数据</strong> 中的 <strong>虚表</strong> 中获取到方法的 <strong>直接引用</strong>。</p>
<p>调用即可。</p>
<h3 id="正常interface调用"><a href="#正常interface调用" class="headerlink" title="正常interface调用"></a>正常interface调用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">// this could definitely be cleaned up QQQ</span></span><br><span class="line">    Method* callee;</span><br><span class="line">    Klass* iclass = cache-&gt;f1_as_klass();</span><br><span class="line">    <span class="comment">// InstanceKlass* interface = (InstanceKlass*) iclass;</span></span><br><span class="line">    <span class="comment">// get receiver</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">parms</span> <span class="operator">=</span> cache-&gt;parameter_size();</span><br><span class="line">    <span class="type">oop</span> <span class="variable">rcvr</span> <span class="operator">=</span> STACK_OBJECT(-parms);</span><br><span class="line">    CHECK_NULL(rcvr);</span><br><span class="line">    InstanceKlass* int2 = (InstanceKlass*) rcvr-&gt;klass();</span><br><span class="line">    itableOffsetEntry* ki = (itableOffsetEntry*) int2-&gt;start_of_itable();</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span> ; i &lt; int2-&gt;itable_length() ; i++, ki++ ) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ki-&gt;interface_klass() == iclass) <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// If the interface isn&#x27;t found, this class doesn&#x27;t implement this</span></span><br><span class="line">    <span class="comment">// interface.  The link resolver checks this but only for the first</span></span><br><span class="line">    <span class="comment">// time this interface is called.</span></span><br><span class="line">    <span class="keyword">if</span> (i == int2-&gt;itable_length()) &#123;</span><br><span class="line">        VM_JAVA_ERROR(vmSymbols::java_lang_IncompatibleClassChangeError(), <span class="string">&quot;&quot;</span>, note_no_trap);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> <span class="variable">mindex</span> <span class="operator">=</span> cache-&gt;f2_as_index();</span><br><span class="line">    itableMethodEntry* im = ki-&gt;first_method_entry(rcvr-&gt;klass());</span><br><span class="line">    callee = im[mindex].method();</span><br><span class="line">    <span class="keyword">if</span> (callee == NULL) &#123;</span><br><span class="line">        VM_JAVA_ERROR(vmSymbols::java_lang_AbstractMethodError(), <span class="string">&quot;&quot;</span>, note_no_trap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Profile virtual call.</span></span><br><span class="line">    BI_PROFILE_UPDATE_VIRTUALCALL(rcvr-&gt;klass());</span><br><span class="line"></span><br><span class="line">    istate-&gt;set_callee(callee);</span><br><span class="line">    istate-&gt;set_callee_entry_point(callee-&gt;from_interpreted_entry());</span><br><span class="line">#ifdef VM_JVMTI</span><br><span class="line">    <span class="title function_">if</span> <span class="params">(JvmtiExport::can_post_interpreter_events()</span> &amp;&amp; THREAD-&gt;is_interp_only_mode()) &#123;</span><br><span class="line">        istate-&gt;set_callee_entry_point(callee-&gt;interpreter_entry());</span><br><span class="line">    &#125;</span><br><span class="line">#endif <span class="comment">/* VM_JVMTI */</span></span><br><span class="line">    istate-&gt;set_bcp_advance(<span class="number">5</span>);</span><br><span class="line">    UPDATE_PC_AND_RETURN(<span class="number">0</span>); <span class="comment">// I&#x27;ll be back...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>常量池缓存条目</strong> 的 <code>_f1</code> 字段存储的是 <strong>接口元数据</strong>，<code>_f2</code> 字段存储是 <strong>接口表索引</strong>。</p>
<p>从栈里获取到调用方法的对象实例 <code>rcvr</code>，再籍此获取到位于 <strong>元空间</strong> 的 <strong>类元数据</strong> <code>rcvr-&gt;klass()</code>。</p>
<p>因为一个类只会继承自一个基类，却可以实现多个接口，所以 <strong>接口表</strong> 结构比 <strong>虚表</strong> 复杂。大体是，分别有 <em>1</em> 个 <strong>接口偏移表</strong> 和 <em>N</em> 个 <strong>接口表</strong>。<strong>接口偏移表</strong> 的条目存储了 <strong>接口元数据</strong> 和对应 <strong>接口表</strong> 的偏移地址。通过跟前面说的 <code>_f1</code> 字段存储的值进行比对，就能找到方法所在的那个接口，获取到其 <strong>接口表</strong> 的偏移地址。</p>
<p>有了 <strong>类元数据</strong> 和 <strong>接口表</strong> 的偏移地址，就能找到对应的 <strong>接口表</strong>。再根据 <code>_f2</code> 字段存储的 <strong>接口表索引</strong>，就能找到方法的 <strong>直接引用</strong>。</p>
<p>调用即可。</p>
<p>这样，该 <strong>字节码指令</strong> 解释执行即对应的方法调用就完成了。</p>
<h2 id="话外"><a href="#话外" class="headerlink" title="话外"></a>话外</h2><p><code>invokeinterface</code> 比 <code>invokevirtual</code> 更复杂些，所以本文以此为例。</p>
<p>为了便于理解，选择了 <strong>CPP解释器</strong> 的执行过程，<strong>模板解释器</strong> 过程是类似的，只是生成了机器码供运行时执行。</p>
<p>结合前面两篇文章，这就是 <code>invoke</code> 类型的 <strong>字节码指令</strong> 解析引用并解释执行的主要过程。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Kaleo Feng</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
